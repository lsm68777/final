#!/bin/bash
# Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ë° ì„¤ì • íŒŒì¼ ëª¨ìŒ

# =============================================================================
# 1. ë©”ì¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (run_phoenix95_recovery.sh)
# =============================================================================

cat > run_phoenix95_recovery.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ë° ìµœì í™” ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

set -e
echo "ğŸš€ Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ì‹œìŠ¤í…œ ì‹œì‘"
echo "=================================================="

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# í•¨ìˆ˜ ì •ì˜
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# í™˜ê²½ ì²´í¬
check_requirements() {
    log_info "í™˜ê²½ ìš”êµ¬ì‚¬í•­ ì²´í¬ ì¤‘..."
    
    # Python ì²´í¬
    if ! command -v python3 &> /dev/null; then
        log_error "Python 3ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
        exit 1
    fi
    
    # Docker ì²´í¬ (ì„ íƒì‚¬í•­)
    if command -v docker &> /dev/null; then
        log_success "Docker ë°œê²¬ë¨"
    else
        log_warning "Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤ (ì„ íƒì‚¬í•­)"
    fi
    
    # í•„ìš”í•œ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
    log_info "Python ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
    pip3 install --quiet aiohttp aiofiles || {
        log_warning "ì¼ë¶€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨, ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
    }
    
    log_success "í™˜ê²½ ìš”êµ¬ì‚¬í•­ ì²´í¬ ì™„ë£Œ"
}

# ë°±ì—… ìƒì„±
create_backup() {
    log_info "í˜„ì¬ ìƒíƒœ ë°±ì—… ìƒì„± ì¤‘..."
    
    BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    
    # ì¤‘ìš” íŒŒì¼ë“¤ ë°±ì—…
    if [ -f "docker-compose.yml" ]; then
        cp docker-compose.yml "$BACKUP_DIR/"
    fi
    
    if [ -f "requirements.txt" ]; then
        cp requirements.txt "$BACKUP_DIR/"
    fi
    
    if [ -d "services" ]; then
        cp -r services "$BACKUP_DIR/" 2>/dev/null || true
    fi
    
    log_success "ë°±ì—… ìƒì„± ì™„ë£Œ: $BACKUP_DIR"
}

# ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰
run_recovery_system() {
    log_info "Phoenix 95 V4 ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰ ì¤‘..."
    
    # ë©”ì¸ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    python3 -c "
import asyncio
import sys
import os

# í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰
sys.path.append(os.getcwd())

# ë³µêµ¬ ì‹œìŠ¤í…œ ì½”ë“œ ì‹¤í–‰ (ì´ë¯¸ ìƒì„±ëœ ì•„í‹°íŒ©íŠ¸ ì‚¬ìš©)
async def main():
    from phoenix95_complete_recovery_system import Phoenix95CompleteRecoverySystem
    
    recovery_system = Phoenix95CompleteRecoverySystem('.')
    results = await recovery_system.run_complete_recovery()
    
    print('\\n' + '='*80)
    print('ğŸ“Š ë³µêµ¬ ê²°ê³¼ ìš”ì•½')
    print('='*80)
    
    if 'error' in results:
        print(f'âŒ ì˜¤ë¥˜: {results[\"error\"]}')
        return False
    
    print(f'â±ï¸ ì‹¤í–‰ ì‹œê°„: {results.get(\"execution_time\", 0):.2f}ì´ˆ')
    print(f'ğŸ“ ë¶„ì„ëœ íŒŒì¼ ìˆ˜: {results.get(\"structure_analysis\", {}).get(\"total_files\", 0)}')
    print(f'ğŸ”§ ìˆ˜ì •ëœ ì´ìŠˆ ìˆ˜: {len(results.get(\"quality_improvement\", {}).get(\"issues_fixed\", []))}')
    print(f'âš¡ ìµœì í™” ì ìš© ìˆ˜: {len(results.get(\"performance_optimization\", {}).get(\"optimizations_applied\", []))}')
    
    return True

if __name__ == '__main__':
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
"
    
    if [ $? -eq 0 ]; then
        log_success "ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰ ì™„ë£Œ"
    else
        log_error "ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰ ì‹¤íŒ¨"
        return 1
    fi
}

# ì„œë¹„ìŠ¤ êµ¬ì¡° ìƒì„±
create_service_structure() {
    log_info "V4 ì„œë¹„ìŠ¤ êµ¬ì¡° ìƒì„± ì¤‘..."
    
    # V4 í•„ìˆ˜ ì„œë¹„ìŠ¤ë“¤
    services=(
        "api-gateway-enterprise:8100"
        "signal-ingestion-pro:8101"
        "market-data-intelligence:8102"
        "phoenix95-ai-engine:8103"
        "trade-execution-leverage:8106"
        "position-tracker-realtime:8107"
        "notification-hub-intelligent:8109"
    )
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service_name port <<< "$service_info"
        
        log_info "ì„œë¹„ìŠ¤ ìƒì„± ì¤‘: $service_name (í¬íŠ¸: $port)"
        
        # ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
        mkdir -p "services/$service_name"/{domain,application,infrastructure,interfaces/api}
        
        # ê¸°ë³¸ __init__.py íŒŒì¼ë“¤ ìƒì„±
        for layer in domain application infrastructure interfaces; do
            echo "\"\"\"Phoenix 95 V4 $service_name $layer layer\"\"\"" > "services/$service_name/$layer/__init__.py"
        done
        
        # FastAPI ë©”ì¸ ì•± ìƒì„±
        cat > "services/$service_name/interfaces/api/main.py" << PYTHON_EOF
"""
Phoenix 95 V4 $service_name FastAPI Application
"""

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import uvicorn
import logging

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(
    title="${service_name//-/ }",
    description="Phoenix 95 V4 Enhanced $service_name",
    version="4.0.0"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health")
async def health_check():
    """í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸"""
    return {
        "status": "healthy",
        "service": "$service_name",
        "port": $port,
        "version": "4.0.0"
    }

@app.get("/ready")
async def readiness_check():
    """ì¤€ë¹„ ìƒíƒœ í™•ì¸"""
    return {
        "status": "ready",
        "service": "$service_name",
        "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    }

@app.get("/metrics")
async def metrics():
    """í”„ë¡œë©”í…Œìš°ìŠ¤ ë©”íŠ¸ë¦­"""
    return {"metrics": "# Prometheus metrics here"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=$port)
PYTHON_EOF

        # Dockerfile ìƒì„±
        cat > "services/$service_name/Dockerfile" << DOCKER_EOF
FROM python:3.11-slim

WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y gcc && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE $port

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\
    CMD curl -f http://localhost:$port/health || exit 1

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["python", "-m", "interfaces.api.main"]
DOCKER_EOF

        # requirements.txt ìƒì„±
        cat > "services/$service_name/requirements.txt" << REQ_EOF
fastapi==0.104.1
uvicorn==0.24.0
pydantic==2.5.0
asyncpg==0.29.0
aioredis==2.0.1
influxdb-client==1.40.0
prometheus-client==0.19.0
structlog==23.2.0
aiohttp==3.9.0
REQ_EOF

    done
    
    log_success "V4 ì„œë¹„ìŠ¤ êµ¬ì¡° ìƒì„± ì™„ë£Œ"
}

# ê³µí†µ ì„¤ì • íŒŒì¼ ìƒì„±
create_config_files() {
    log_info "ê³µí†µ ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
    
    # ê³µí†µ ë””ë ‰í† ë¦¬ êµ¬ì¡°
    mkdir -p shared/{config,domain,infrastructure,utils}
    mkdir -p infrastructure/{docker,kubernetes,monitoring}
    mkdir -p scripts/{deployment,migration,testing}
    mkdir -p tests/{unit,integration,performance}
    mkdir -p docs
    
    # Docker Compose íŒŒì¼ ìƒì„±
    cat > docker-compose.yml << 'COMPOSE_EOF'
version: '3.8'

services:
  # ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ë“¤
  postgresql:
    image: postgres:15
    environment:
      POSTGRES_DB: phoenix95_v4
      POSTGRES_USER: phoenix95
      POSTGRES_PASSWORD: phoenix95_secure
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  influxdb:
    image: influxdb:2.7
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: adminpassword
    ports:
      - "8086:8086"
    volumes:
      - influx_data:/var/lib/influxdb2
    restart: unless-stopped

  # Phoenix 95 V4 ì„œë¹„ìŠ¤ë“¤
  api-gateway-enterprise:
    build: ./services/api-gateway-enterprise
    ports:
      - "8100:8100"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  signal-ingestion-pro:
    build: ./services/signal-ingestion-pro
    ports:
      - "8101:8101"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  market-data-intelligence:
    build: ./services/market-data-intelligence
    ports:
      - "8102:8102"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
      - INFLUXDB_URL=http://influxdb:8086
    depends_on:
      - postgresql
      - redis
      - influxdb
    restart: unless-stopped

  phoenix95-ai-engine:
    build: ./services/phoenix95-ai-engine
    ports:
      - "8103:8103"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  trade-execution-leverage:
    build: ./services/trade-execution-leverage
    ports:
      - "8106:8106"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  position-tracker-realtime:
    build: ./services/position-tracker-realtime
    ports:
      - "8107:8107"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  notification-hub-intelligent:
    build: ./services/notification-hub-intelligent
    ports:
      - "8109:8109"
    environment:
      - DATABASE_URL=postgresql://phoenix95:phoenix95_secure@postgresql:5432/phoenix95_v4
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgresql
      - redis
    restart: unless-stopped

  # ëª¨ë‹ˆí„°ë§
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  influx_data:
  grafana_data:

networks:
  default:
    name: phoenix95_v4_network
COMPOSE_EOF

    # ê³µí†µ ì„¤ì • íŒŒì¼ë“¤ ìƒì„±
    cat > shared/config/telegram_config.py << 'TELEGRAM_EOF'
"""
Phoenix 95 V4 Enhanced Telegram Configuration
"""

TELEGRAM_CONFIG = {
    "bot_token": "7386542811:AAEZ21p30rES1k8NxNM2xbZ53U44PI9D5CY",
    "chat_id": "7590895952",
    "alerts": {
        "trade_execution": True,
        "position_updates": True,
        "system_errors": True,
        "performance_reports": True
    },
    "notification_levels": {
        "INFO": True,
        "WARNING": True,
        "ERROR": True,
        "CRITICAL": True
    }
}

async def send_telegram_message(message: str, level: str = "INFO"):
    """í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡"""
    import aiohttp
    
    if not TELEGRAM_CONFIG["notification_levels"].get(level, False):
        return
    
    url = f"https://api.telegram.org/bot{TELEGRAM_CONFIG['bot_token']}/sendMessage"
    data = {
        "chat_id": TELEGRAM_CONFIG["chat_id"],
        "text": f"[{level}] {message}",
        "parse_mode": "HTML"
    }
    
    try:
        async with aiohttp.ClientSession() as session:
            await session.post(url, data=data)
    except Exception as e:
        print(f"í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {e}")
TELEGRAM_EOF

    cat > shared/config/trading_config.py << 'TRADING_EOF'
"""
Phoenix 95 V4 Enhanced Trading Configuration
"""

TRADING_CONFIG = {
    "leverage": {
        "max_leverage": 20,
        "margin_mode": "ISOLATED",
        "position_side": "BOTH"
    },
    "risk_management": {
        "max_position_size_usd": 50000,
        "max_daily_loss_usd": 5000,
        "stop_loss_percentage": 0.02,
        "take_profit_percentage": 0.04
    },
    "phoenix95": {
        "confidence_threshold": 0.85,
        "min_kelly_ratio": 0.1,
        "max_kelly_ratio": 0.25
    },
    "allowed_symbols": [
        "BTCUSDT", "ETHUSDT", "ADAUSDT", "DOTUSDT", "LINKUSDT",
        "LTCUSDT", "XRPUSDT", "EOSUSDT", "TRXUSDT", "ETCUSDT"
    ]
}

SIGNAL_VALIDATION = {
    "required_fields": ["symbol", "action", "price", "confidence"],
    "confidence_min": 0.7,
    "price_deviation_max": 0.05,
    "duplicate_timeout_seconds": 300
}
TRADING_EOF

    # ëª¨ë‹ˆí„°ë§ ì„¤ì •
    mkdir -p infrastructure/monitoring
    cat > infrastructure/monitoring/prometheus.yml << 'PROMETHEUS_EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'phoenix95-v4-services'
    static_configs:
      - targets:
          - 'localhost:8100'  # api-gateway-enterprise
          - 'localhost:8101'  # signal-ingestion-pro
          - 'localhost:8102'  # market-data-intelligence
          - 'localhost:8103'  # phoenix95-ai-engine
          - 'localhost:8106'  # trade-execution-leverage
          - 'localhost:8107'  # position-tracker-realtime
          - 'localhost:8109'  # notification-hub-intelligent

  - job_name: 'databases'
    static_configs:
      - targets:
          - 'localhost:5432'  # PostgreSQL
          - 'localhost:6379'  # Redis
          - 'localhost:8086'  # InfluxDB

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
PROMETHEUS_EOF

    # í™˜ê²½ ë³€ìˆ˜ ì˜ˆì œ
    cat > .env.example << 'ENV_EOF'
# Phoenix 95 V4 Environment Variables
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=phoenix95_v4
POSTGRES_USER=phoenix95
POSTGRES_PASSWORD=phoenix95_secure

REDIS_HOST=localhost
REDIS_PORT=6379

INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=your_influxdb_token
INFLUXDB_ORG=phoenix95
INFLUXDB_BUCKET=metrics

TELEGRAM_BOT_TOKEN=7386542811:AAEZ21p30rES1k8NxNM2xbZ53U44PI9D5CY
TELEGRAM_CHAT_ID=7590895952

MAX_LEVERAGE=20
MARGIN_MODE=ISOLATED

LOG_LEVEL=INFO
ENV_EOF

    # ê¸°ë³¸ README ìƒì„±
    cat > README.md << 'README_EOF'
# Phoenix 95 V4 Enhanced

ì™„ì „ ìë™í™”ëœ Enterpriseê¸‰ ê±°ë˜ ì‹œìŠ¤í…œ

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

```bash
# ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰
./run_phoenix95_recovery.sh

# ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose up -d

# í—¬ìŠ¤ì²´í¬
curl http://localhost:8100/health
```

## ğŸ“Š ì„œë¹„ìŠ¤ êµ¬ì¡°

- **API Gateway** (8100): ë¼ìš°íŒ… ë° ì¸ì¦
- **Signal Ingestion** (8101): ì‹ í˜¸ ìˆ˜ì§‘
- **Market Data Intelligence** (8102): ì‹œì¥ ë°ì´í„° ë¶„ì„
- **Phoenix 95 AI Engine** (8103): AI ê¸°ë°˜ ì‹ í˜¸ ë¶„ì„
- **Trade Execution Leverage** (8106): 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜
- **Position Tracker Realtime** (8107): ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì¶”ì 
- **Notification Hub** (8109): ì§€ëŠ¥í˜• ì•Œë¦¼

## ğŸ”§ í•µì‹¬ ê¸°ëŠ¥

- âš¡ 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ (ISOLATED ëª¨ë“œ)
- ğŸ§  Phoenix 95 AI ì‹ ë¢°ë„ ë¶„ì„
- ğŸ“Š ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì¶”ì  ë° ì²­ì‚° ëª¨ë‹ˆí„°ë§
- ğŸ”” í…”ë ˆê·¸ë¨ í†µí•© ì•Œë¦¼
- ğŸ“ˆ Grafana ê¸°ë°˜ ëª¨ë‹ˆí„°ë§
- ğŸ”„ DDD ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜

## ğŸ“š ë¬¸ì„œ

- API ë¬¸ì„œ: http://localhost:8100/docs
- Grafana: http://localhost:3000 (admin/admin)
- Prometheus: http://localhost:9090

## ğŸ› ï¸ ê°œë°œ

```bash
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
python -m pytest tests/

# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
python recovery_scripts/quality_enforcer.py

# ì„±ëŠ¥ ìµœì í™”
python recovery_scripts/performance_optimizer.py
```
README_EOF

    log_success "ê³µí†µ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
}

# ê²€ì¦ ë° í…ŒìŠ¤íŠ¸
run_verification() {
    log_info "ì‹œìŠ¤í…œ ê²€ì¦ ì¤‘..."
    
    # êµ¬ì¡° ê²€ì¦
    required_dirs=("services" "shared" "infrastructure" "scripts" "tests")
    for dir in "${required_dirs[@]}"; do
        if [ -d "$dir" ]; then
            log_success "âœ… ë””ë ‰í† ë¦¬ ì¡´ì¬: $dir"
        else
            log_warning "âš ï¸ ë””ë ‰í† ë¦¬ ëˆ„ë½: $dir"
        fi
    done
    
    # í•„ìˆ˜ íŒŒì¼ ê²€ì¦
    required_files=("docker-compose.yml" "README.md" ".env.example")
    for file in "${required_files[@]}"; do
        if [ -f "$file" ]; then
            log_success "âœ… íŒŒì¼ ì¡´ì¬: $file"
        else
            log_warning "âš ï¸ íŒŒì¼ ëˆ„ë½: $file"
        fi
    done
    
    # ì„œë¹„ìŠ¤ êµ¬ì¡° ê²€ì¦
    for service_dir in services/*/; do
        if [ -d "$service_dir" ]; then
            service_name=$(basename "$service_dir")
            log_info "ì„œë¹„ìŠ¤ êµ¬ì¡° ê²€ì¦: $service_name"
            
            if [ -f "$service_dir/interfaces/api/main.py" ]; then
                log_success "  âœ… FastAPI ì•± ì¡´ì¬"
            else
                log_warning "  âš ï¸ FastAPI ì•± ëˆ„ë½"
            fi
            
            if [ -f "$service_dir/Dockerfile" ]; then
                log_success "  âœ… Dockerfile ì¡´ì¬"
            else
                log_warning "  âš ï¸ Dockerfile ëˆ„ë½"
            fi
        fi
    done
}

# ë©”ì¸ ì‹¤í–‰ íë¦„
main() {
    echo "ğŸ¯ Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ë° ìµœì í™”"
    echo "ê°œë°œì: AI Assistant"
    echo "ë²„ì „: 4.0.0"
    echo ""
    
    # 1. í™˜ê²½ ì²´í¬
    check_requirements
    
    # 2. ë°±ì—… ìƒì„±
    create_backup
    
    # 3. ì„œë¹„ìŠ¤ êµ¬ì¡° ìƒì„±
    create_service_structure
    
    # 4. ì„¤ì • íŒŒì¼ ìƒì„±
    create_config_files
    
    # 5. ë³µêµ¬ ì‹œìŠ¤í…œ ì‹¤í–‰
    run_recovery_system
    
    # 6. ê²€ì¦
    run_verification
    
    echo ""
    echo "ğŸ‰ Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ì™„ë£Œ!"
    echo ""
    echo "ğŸ“Š ë‹¤ìŒ ë‹¨ê³„:"
    echo "1. docker-compose up -d (ì„œë¹„ìŠ¤ ì‹œì‘)"
    echo "2. curl http://localhost:8100/health (í—¬ìŠ¤ì²´í¬)"
    echo "3. http://localhost:3000 (Grafana ëŒ€ì‹œë³´ë“œ)"
    echo ""
    echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ë“¤:"
    echo "- ./services/ (7ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤)"
    echo "- ./docker-compose.yml (ì™„ì „ í†µí•© ì„¤ì •)"
    echo "- ./shared/config/ (ê³µí†µ ì„¤ì •)"
    echo "- ./infrastructure/ (ì¸í”„ë¼ ì„¤ì •)"
    echo "- ./recovery_scripts/ (ë³µêµ¬ ë„êµ¬)"
    echo ""
    echo "ğŸ”— ìœ ìš©í•œ ë§í¬:"
    echo "- API Gateway: http://localhost:8100"
    echo "- Phoenix 95 AI: http://localhost:8103"
    echo "- Trade Execution: http://localhost:8106"
    echo "- Position Tracker: http://localhost:8107"
    echo "- Grafana: http://localhost:3000"
    echo "- Prometheus: http://localhost:9090"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"
EOF

# =============================================================================
# 2. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
# =============================================================================

chmod +x run_phoenix95_recovery.sh

# =============================================================================
# 3. ì¶”ê°€ ìœ í‹¸ë¦¬í‹° ìŠ¤í¬ë¦½íŠ¸ë“¤
# =============================================================================

# í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸
cat > health_check_all.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 ëª¨ë“  ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬

echo "ğŸ” Phoenix 95 V4 ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬"
echo "================================="

services=(
    "api-gateway-enterprise:8100"
    "signal-ingestion-pro:8101"
    "market-data-intelligence:8102"
    "phoenix95-ai-engine:8103"
    "trade-execution-leverage:8106"
    "position-tracker-realtime:8107"
    "notification-hub-intelligent:8109"
)

for service_info in "${services[@]}"; do
    IFS=':' read -r service_name port <<< "$service_info"
    
    echo -n "  $service_name ($port): "
    
    if curl -s -f "http://localhost:$port/health" > /dev/null 2>&1; then
        echo "âœ… ì •ìƒ"
    else
        echo "âŒ ë¹„ì •ìƒ"
    fi
done

echo ""
echo "ğŸ“Š ì¶”ê°€ í™•ì¸:"
echo -n "  PostgreSQL (5432): "
if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
    echo "âœ… ì •ìƒ"
else
    echo "âŒ ë¹„ì •ìƒ"
fi

echo -n "  Redis (6379): "
if redis-cli -p 6379 ping > /dev/null 2>&1; then
    echo "âœ… ì •ìƒ"
else
    echo "âŒ ë¹„ì •ìƒ"
fi
EOF

chmod +x health_check_all.sh

# ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸
cat > monitor_logs.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 ë¡œê·¸ ëª¨ë‹ˆí„°ë§

echo "ğŸ“Š Phoenix 95 V4 ë¡œê·¸ ëª¨ë‹ˆí„°ë§"
echo "============================="

if [ "$1" = "errors" ]; then
    echo "ğŸ” ì—ëŸ¬ ë¡œê·¸ë§Œ í‘œì‹œ:"
    docker-compose logs --follow | grep -E "(ERROR|CRITICAL|Exception)"
elif [ "$1" = "service" ] && [ -n "$2" ]; then
    echo "ğŸ“‹ $2 ì„œë¹„ìŠ¤ ë¡œê·¸:"
    docker-compose logs --follow "$2"
else
    echo "ğŸ“‹ ëª¨ë“  ì„œë¹„ìŠ¤ ë¡œê·¸ (ì‹¤ì‹œê°„):"
    echo "ì‚¬ìš©ë²•: $0 [errors|service SERVICE_NAME]"
    echo ""
    docker-compose logs --follow --tail=50
fi
EOF

chmod +x monitor_logs.sh

# ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
cat > backup_system.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 ì‹œìŠ¤í…œ ë°±ì—…

BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "ğŸ’¾ Phoenix 95 V4 ì‹œìŠ¤í…œ ë°±ì—… ì¤‘..."
echo "ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"

# ì„¤ì • íŒŒì¼ ë°±ì—…
echo "ğŸ“‹ ì„¤ì • íŒŒì¼ ë°±ì—… ì¤‘..."
tar -czf "$BACKUP_DIR/configs.tar.gz" \
    docker-compose.yml \
    .env* \
    shared/config/ \
    infrastructure/ 2>/dev/null

# ì„œë¹„ìŠ¤ ì½”ë“œ ë°±ì—…
echo "ğŸ”§ ì„œë¹„ìŠ¤ ì½”ë“œ ë°±ì—… ì¤‘..."
tar -czf "$BACKUP_DIR/services.tar.gz" services/ 2>/dev/null

# ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (Docker ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
if docker-compose ps postgresql | grep -q "Up"; then
    echo "ğŸ—„ï¸ PostgreSQL ë°±ì—… ì¤‘..."
    docker-compose exec -T postgresql pg_dump -U phoenix95 phoenix95_v4 > "$BACKUP_DIR/postgresql_backup.sql"
fi

if docker-compose ps redis | grep -q "Up"; then
    echo "ğŸ“Š Redis ë°±ì—… ì¤‘..."
    docker-compose exec redis redis-cli BGSAVE
    docker cp $(docker-compose ps -q redis):/data/dump.rdb "$BACKUP_DIR/redis_backup.rdb" 2>/dev/null
fi

echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
echo "ğŸ’¡ ë³µêµ¬ ë°©ë²•: ./restore_system.sh $BACKUP_DIR"
EOF

chmod +x backup_system.sh

# ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
cat > restore_system.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 ì‹œìŠ¤í…œ ë³µêµ¬

if [ -z "$1" ]; then
    echo "ì‚¬ìš©ë²•: $0 <ë°±ì—…_ë””ë ‰í† ë¦¬>"
    echo "ì˜ˆ: $0 backups/20241221_143022"
    exit 1
fi

BACKUP_DIR="$1"

if [ ! -d "$BACKUP_DIR" ]; then
    echo "âŒ ë°±ì—… ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $BACKUP_DIR"
    exit 1
fi

echo "ğŸ”„ Phoenix 95 V4 ì‹œìŠ¤í…œ ë³µêµ¬ ì¤‘..."
echo "ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"

# í˜„ì¬ ì‹œìŠ¤í…œ ì¤‘ì§€
echo "â¹ï¸ í˜„ì¬ ì‹œìŠ¤í…œ ì¤‘ì§€ ì¤‘..."
docker-compose down 2>/dev/null || true

# ì„¤ì • íŒŒì¼ ë³µêµ¬
if [ -f "$BACKUP_DIR/configs.tar.gz" ]; then
    echo "ğŸ“‹ ì„¤ì • íŒŒì¼ ë³µêµ¬ ì¤‘..."
    tar -xzf "$BACKUP_DIR/configs.tar.gz"
fi

# ì„œë¹„ìŠ¤ ì½”ë“œ ë³µêµ¬
if [ -f "$BACKUP_DIR/services.tar.gz" ]; then
    echo "ğŸ”§ ì„œë¹„ìŠ¤ ì½”ë“œ ë³µêµ¬ ì¤‘..."
    tar -xzf "$BACKUP_DIR/services.tar.gz"
fi

# ë°ì´í„°ë² ì´ìŠ¤ ë³µêµ¬
echo "ğŸ”„ ì‹œìŠ¤í…œ ì¬ì‹œì‘ ì¤‘..."
docker-compose up -d postgresql redis

echo "â³ ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
sleep 30

if [ -f "$BACKUP_DIR/postgresql_backup.sql" ]; then
    echo "ğŸ—„ï¸ PostgreSQL ë³µêµ¬ ì¤‘..."
    docker-compose exec -T postgresql psql -U phoenix95 -d phoenix95_v4 < "$BACKUP_DIR/postgresql_backup.sql"
fi

if [ -f "$BACKUP_DIR/redis_backup.rdb" ]; then
    echo "ğŸ“Š Redis ë³µêµ¬ ì¤‘..."
    docker cp "$BACKUP_DIR/redis_backup.rdb" $(docker-compose ps -q redis):/data/dump.rdb
    docker-compose restart redis
fi

# ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘
echo "ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘ ì¤‘..."
docker-compose up -d

echo "âœ… ì‹œìŠ¤í…œ ë³µêµ¬ ì™„ë£Œ!"
echo "ğŸ” í—¬ìŠ¤ì²´í¬: ./health_check_all.sh"
EOF

chmod +x restore_system.sh

# ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
cat > performance_test.sh << 'EOF'
#!/bin/bash
# Phoenix 95 V4 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

echo "âš¡ Phoenix 95 V4 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
echo "=========================="

# API Gateway ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
echo "ğŸ”— API Gateway ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì¤‘..."
if command -v ab > /dev/null 2>&1; then
    ab -n 1000 -c 10 http://localhost:8100/health
else
    echo "  âš ï¸ Apache Bench (ab)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
    echo "  ğŸ’¡ ì„¤ì¹˜: sudo apt-get install apache2-utils"
    
    # curlì„ ì´ìš©í•œ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸
    echo "  ğŸ”„ curlì„ ì´ìš©í•œ ê¸°ë³¸ í…ŒìŠ¤íŠ¸..."
    for i in {1..10}; do
        response_time=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:8100/health)
        echo "    ìš”ì²­ $i: ${response_time}s"
    done
fi

# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
echo ""
echo "ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
echo ""
echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
df -h | grep -E "(Filesystem|/dev/)"

echo ""
echo "âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
EOF

chmod +x performance_test.sh

# =============================================================================
# ì‹¤í–‰ ì•ˆë‚´
# =============================================================================

echo "ğŸ‰ Phoenix 95 V4 Enhanced ì™„ì „ ë³µêµ¬ ì‹œìŠ¤í…œ ìƒì„± ì™„ë£Œ!"
echo ""
echo "ğŸ“‹ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ë“¤:"
echo "  ğŸš€ run_phoenix95_recovery.sh - ë©”ì¸ ë³µêµ¬ ì‹¤í–‰"
echo "  ğŸ” health_check_all.sh - ì „ì²´ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬"
echo "  ğŸ“Š monitor_logs.sh - ë¡œê·¸ ëª¨ë‹ˆí„°ë§"
echo "  ğŸ’¾ backup_system.sh - ì‹œìŠ¤í…œ ë°±ì—…"
echo "  ğŸ”„ restore_system.sh - ì‹œìŠ¤í…œ ë³µêµ¬"
echo "  âš¡ performance_test.sh - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
echo ""
echo "ğŸ¯ ì‹¤í–‰ ë°©ë²•:"
echo "  1. ./run_phoenix95_recovery.sh (ì „ì²´ ì‹œìŠ¤í…œ ë³µêµ¬)"
echo "  2. docker-compose up -d (ì„œë¹„ìŠ¤ ì‹œì‘)"
echo "  3. ./health_check_all.sh (ìƒíƒœ í™•ì¸)"
echo ""
echo "ğŸ“Š ëª¨ë‹ˆí„°ë§:"
echo "  - Grafana: http://localhost:3000 (admin/admin)"
echo "  - Prometheus: http://localhost:9090"
echo "  - API Gateway: http://localhost:8100"
echo ""
echo "ğŸ’¡ ìœ ì§€ë³´ìˆ˜:"
echo "  - ./backup_system.sh (ë°±ì—…)"
echo "  - ./monitor_logs.sh errors (ì—ëŸ¬ ë¡œê·¸ ëª¨ë‹ˆí„°ë§)"
echo "  - ./performance_test.sh (ì„±ëŠ¥ í…ŒìŠ¤íŠ¸)"