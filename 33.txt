#Requires -Version 5.1

# ğŸŒŠ Phoenix 95 Enterprise V4 Enhanced - ì™„ì „ ìë™í™” ìŠ¤í¬ë¦½íŠ¸
# ì›ë³¸ ê¸°ëŠ¥ 100% ë³´ì¡´ + ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„

param(
    [Parameter(Mandatory=$true)]
    [ValidateSet("Install", "Deploy", "Start", "Stop", "Update", "Monitor", "Backup", "Rollback", "Test")]
    [string]$Action,

    [Parameter(Mandatory=$false)]
    [ValidateSet("Development", "Staging", "Production")]
    [string]$Environment = "Development",

    [Parameter(Mandatory=$false)]
    [ValidateSet("Windows", "Linux", "macOS", "Auto")]
    [string]$Platform = "Auto",

    [Parameter(Mandatory=$false)]
    [string]$ConfigPath = ".\config\phoenix95_config.json",

    [Parameter(Mandatory=$false)]
    [switch]$Silent,

    [Parameter(Mandatory=$false)]
    [switch]$Force,

    [Parameter(Mandatory=$false)]
    [switch]$IncludeTests
)

# ========================================
# ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° ì„¤ì •
# ========================================

$script:LogFile = ".\logs\phoenix95_automation_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$script:BaseDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$script:StartTime = Get-Date
$script:CurrentPlatform = $Platform

# í”Œë«í¼ ìë™ ê°ì§€
if ($Platform -eq "Auto") {
    if ($IsWindows -or $env:OS -eq "Windows_NT") {
        $script:CurrentPlatform = "Windows"
    } elseif ($IsLinux) {
        $script:CurrentPlatform = "Linux"
    } elseif ($IsMacOS) {
        $script:CurrentPlatform = "macOS"
    } else {
        $script:CurrentPlatform = "Windows"
    }
}

# V4 ì‹œìŠ¤í…œ ì„¤ì •
$script:V4Config = @{
    SystemName = "Phoenix95-V4-Enhanced"
    Version = "4.0.0"
    TelegramToken = "7386542811:AAEZ21p30rES1k8NxNM2xbZ53U44PI9D5CY"
    TelegramChatId = "7590895952"
    WebhookSecret = "phoenix_complete_webhook_2025_ultra_secure"
    
    LeverageConfig = @{
        Leverage = 20
        MarginMode = "ISOLATED"
        StopLossPercent = 0.02
        TakeProfitPercent = 0.02
        MaxMarginRatio = 0.8
        LiquidationBuffer = 0.1
        MaintenanceMargin = 0.004
        TradingFee = 0.0004
        MaxPositionCount = 5
        DailyLossLimit = 0.05
        RiskPerTrade = 0.02
    }
    
    TradingConfig = @{
        MinConfidence = 0.25
        Phoenix95Threshold = 0.45
        MaxPositionSize = 0.15
        KellyFraction = 0.20
        QualityThreshold = 0.55
        RealDataWeight = 0.85
        Phoenix95Weight = 0.95
        MinTradeAmount = 10.0
        MaxTradeAmount = 10000.0
        CooldownPeriod = 300
        MarketHoursOnly = $false
        WeekendTrading = $true
        AllowedSymbols = @("BTCUSDT", "ETHUSDT", "BNBUSDT", "ADAUSDT", "DOGEUSDT", "XRPUSDT", "SOLUSDT", "AVAXUSDT", "DOTUSDT", "LINKUSDT")
    }
    
    ServicePorts = @{
        "api-gateway-enterprise" = 8100
        "signal-ingestion-pro" = 8101
        "market-data-intelligence" = 8102
        "phoenix95-ai-engine" = 8103
        "risk-management-advanced" = 8104
        "portfolio-optimizer-quant" = 8105
        "trade-execution-leverage" = 8106
        "position-tracker-realtime" = 8107
        "compliance-monitor-regulatory" = 8108
        "notification-hub-intelligent" = 8109
        "client-dashboard-analytics" = 8110
    }
}

# ========================================
# í•µì‹¬ í•¨ìˆ˜ë“¤
# ========================================

function Write-Log {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Message,
        [Parameter(Mandatory=$false)]
        [ValidateSet("INFO", "WARN", "ERROR", "SUCCESS")]
        [string]$Level = "INFO"
    )

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] [$script:CurrentPlatform] $Message"

    switch ($Level) {
        "INFO"    { Write-Host $logEntry -ForegroundColor White }
        "WARN"    { Write-Host $logEntry -ForegroundColor Yellow }
        "ERROR"   { Write-Host $logEntry -ForegroundColor Red }
        "SUCCESS" { Write-Host $logEntry -ForegroundColor Green }
    }

    if (-not (Test-Path (Split-Path $script:LogFile))) {
        New-Item -ItemType Directory -Path (Split-Path $script:LogFile) -Force | Out-Null
    }
    Add-Content -Path $script:LogFile -Value $logEntry
}

function Invoke-PlatformCommand {
    param(
        [string]$WindowsCommand,
        [string]$LinuxCommand,
        [string]$MacCommand = $LinuxCommand
    )

    switch ($script:CurrentPlatform) {
        "Windows" { 
            if ($WindowsCommand) { Invoke-Expression $WindowsCommand }
        }
        "Linux" { 
            if ($LinuxCommand) { bash -c $LinuxCommand }
        }
        "macOS" { 
            if ($MacCommand) { bash -c $MacCommand }
        }
    }
}

function Test-Prerequisites {
    Write-Log "ğŸ” ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ í™•ì¸ ì¤‘..." "INFO"

    $prerequisites = @()

    # Python ì„¤ì¹˜ í™•ì¸
    try {
        $pythonCmd = if ($script:CurrentPlatform -eq "Windows") { "python" } else { "python3" }
        $pythonVersion = & $pythonCmd --version 2>$null
        if ($pythonVersion) {
            Write-Log "âœ… Python ì„¤ì¹˜ë¨: $pythonVersion" "SUCCESS"
        } else {
            $prerequisites += "Python 3.8+ ì„¤ì¹˜ í•„ìš”"
        }
    } catch {
        $prerequisites += "Python 3.8+ ì„¤ì¹˜ í•„ìš”"
    }

    # Docker ì„¤ì¹˜ í™•ì¸
    try {
        $dockerVersion = docker --version 2>$null
        if ($dockerVersion) {
            Write-Log "âœ… Docker ì„¤ì¹˜ë¨: $dockerVersion" "SUCCESS"
            try {
                docker info 2>$null | Out-Null
                Write-Log "âœ… Docker ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘" "SUCCESS"
            } catch {
                Write-Log "âš ï¸ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ë§Œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ" "WARN"
                $prerequisites += "Docker ì„œë¹„ìŠ¤ ì‹œì‘ í•„ìš”"
            }
        } else {
            $prerequisites += if ($script:CurrentPlatform -eq "Windows") { "Docker Desktop ì„¤ì¹˜ í•„ìš”" } else { "Docker ì„¤ì¹˜ í•„ìš”" }
        }
    } catch {
        $prerequisites += if ($script:CurrentPlatform -eq "Windows") { "Docker Desktop ì„¤ì¹˜ í•„ìš”" } else { "Docker ì„¤ì¹˜ í•„ìš”" }
    }

    # Git ì„¤ì¹˜ í™•ì¸
    try {
        $gitVersion = git --version 2>$null
        if ($gitVersion) {
            Write-Log "âœ… Git ì„¤ì¹˜ë¨: $gitVersion" "SUCCESS"
        } else {
            $prerequisites += "Git ì„¤ì¹˜ í•„ìš”"
        }
    } catch {
        $prerequisites += "Git ì„¤ì¹˜ í•„ìš”"
    }

    # PowerShell ë²„ì „ í™•ì¸
    if ($PSVersionTable.PSVersion.Major -ge 5) {
        Write-Log "âœ… PowerShell ë²„ì „: $($PSVersionTable.PSVersion)" "SUCCESS"
    } else {
        $prerequisites += "PowerShell 5.1+ í•„ìš”"
    }

    # Windows íŠ¹í™” í™•ì¸
    if ($script:CurrentPlatform -eq "Windows") {
        $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
        $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
        if ($principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
            Write-Log "âœ… ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ ì¤‘" "SUCCESS"
        } else {
            $prerequisites += "ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ í•„ìš”"
        }
    }

    if ($prerequisites.Count -gt 0) {
        Write-Log "âŒ ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤:" "ERROR"
        foreach ($req in $prerequisites) {
            Write-Log "   - $req" "ERROR"
        }
        return $false
    }

    Write-Log "âœ… ëª¨ë“  ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±" "SUCCESS"
    return $true
}

# ========================================
# Phoenix 95 V4 ì„¤ì¹˜ í•¨ìˆ˜
# ========================================

function Install-Phoenix95V4 {
    Write-Log "ğŸš€ Phoenix 95 V4 Enhanced ì„¤ì¹˜ ì‹œì‘" "INFO"

    try {
        # 1. ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        $workDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-V4-Enhanced" }
            "Linux" { "$HOME/Phoenix95-V4-Enhanced" }
            "macOS" { "$HOME/Phoenix95-V4-Enhanced" }
        }

        if (-not (Test-Path $workDir)) {
            New-Item -ItemType Directory -Path $workDir -Force | Out-Null
            Write-Log "ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±: $workDir" "SUCCESS"
        }

        Set-Location $workDir

        # 2. DDD í´ë” êµ¬ì¡° ìƒì„±
        Write-Log "ğŸ—ï¸ DDD í´ë” êµ¬ì¡° ìƒì„± ì¤‘..." "INFO"
        
        $folders = @(
            "services\api-gateway-enterprise\domain\aggregates",
            "services\signal-ingestion-pro\domain\aggregates", 
            "services\market-data-intelligence\domain\aggregates",
            "services\phoenix95-ai-engine\domain\aggregates",
            "services\risk-management-advanced\domain\aggregates",
            "services\portfolio-optimizer-quant\domain\aggregates",
            "services\trade-execution-leverage\domain\aggregates",
            "services\position-tracker-realtime\domain\aggregates",
            "services\compliance-monitor-regulatory\domain\aggregates",
            "services\notification-hub-intelligent\domain\aggregates",
            "services\client-dashboard-analytics\domain\aggregates",
            "shared\domain\aggregates",
            "shared\infrastructure\repositories",
            "shared\config",
            "shared\utils",
            "shared\models",
            "infrastructure\data_storage\postgresql",
            "infrastructure\data_storage\redis",
            "infrastructure\data_storage\influxdb",
            "infrastructure\monitoring\prometheus",
            "infrastructure\monitoring\grafana",
            "tools",
            "scripts",
            "logs",
            "config",
            "tests\integration",
            "tests\performance",
            "tests\security"
        )

        foreach ($folder in $folders) {
            $fullPath = Join-Path $workDir $folder
            if (-not (Test-Path $fullPath)) {
                New-Item -ItemType Directory -Path $fullPath -Force | Out-Null
            }
        }
        Write-Log "âœ… DDD í´ë” êµ¬ì¡° ìƒì„± ì™„ë£Œ" "SUCCESS"

        # 3. V4 í˜¸í™˜ ì„¤ì • íŒŒì¼ ìƒì„±
        Write-Log "âš™ï¸ V4 í˜¸í™˜ ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..." "INFO"
        Create-TelegramConfig -WorkDir $workDir
        Create-LeverageConfig -WorkDir $workDir
        Create-TradingConfig -WorkDir $workDir
        Write-Log "âœ… V4 í˜¸í™˜ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ" "SUCCESS"

        # 4. Python ê°€ìƒí™˜ê²½ ìƒì„±
        Write-Log "ğŸ Python ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..." "INFO"
        
        $pythonCmd = switch ($script:CurrentPlatform) {
            "Windows" { "python" }
            default { "python3" }
        }

        Invoke-PlatformCommand -WindowsCommand "$pythonCmd -m venv venv" -LinuxCommand "$pythonCmd -m venv venv"

        # íŒ¨í‚¤ì§€ ì„¤ì¹˜
        $basePackages = @(
            "fastapi", "uvicorn[standard]", "asyncpg", "redis", "influxdb-client",
            "pydantic", "pytest", "locust", "requests", "websockets",
            "numpy", "pandas", "aiohttp", "sqlalchemy", "alembic", "scikit-learn",
            "ta-lib", "ccxt", "python-telegram-bot", "celery", "prometheus-client"
        )

        $pipCmd = switch ($script:CurrentPlatform) {
            "Windows" { ".\venv\Scripts\pip" }
            default { "./venv/bin/pip" }
        }

        switch ($script:CurrentPlatform) {
            "Windows" {
                Invoke-Expression "$pipCmd install --upgrade pip"
                Invoke-Expression "$pipCmd install $($basePackages -join ' ')"
                Invoke-Expression "$pipCmd install pywin32 wmi"
            }
            default {
                bash -c "$pipCmd install --upgrade pip"
                bash -c "$pipCmd install $($basePackages -join ' ')"
                bash -c "$pipCmd install psutil"
            }
        }

        Write-Log "âœ… Python í™˜ê²½ ì„¤ì • ì™„ë£Œ" "SUCCESS"

        # 5. Docker Compose íŒŒì¼ ìƒì„±
        Write-Log "ğŸ³ Docker Compose ì„¤ì • ìƒì„± ì¤‘..." "INFO"
        Create-CompleteDockerCompose -WorkDir $workDir
        Create-PrometheusConfig -WorkDir $workDir
        Write-Log "âœ… Docker Compose ì„¤ì • ìƒì„± ì™„ë£Œ" "SUCCESS"

        # 6. 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹¤ì œ êµ¬í˜„ ìƒì„±
        Write-Log "âš¡ 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹¤ì œ êµ¬í˜„ ìƒì„± ì¤‘..." "INFO"
        Create-AllMicroservicesWithBusinessLogic -WorkDir $workDir

        # 7. ê° ì„œë¹„ìŠ¤ë³„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        Write-Log "ğŸ“œ ê° ì„œë¹„ìŠ¤ë³„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..." "INFO"
        Create-ServiceStartScripts -WorkDir $workDir

        # 8. ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        Write-Log "ğŸ“œ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..." "INFO"
        Create-MainStartScript -WorkDir $workDir

        # 9. í™˜ê²½ë³„ ì„¤ì • íŒŒì¼ ìƒì„±
        Create-EnvironmentConfig -WorkDir $workDir

        Write-Log "âœ… Phoenix 95 V4 Enhanced ì„¤ì¹˜ ì™„ë£Œ!" "SUCCESS"
        return $true

    } catch {
        Write-Log "âŒ ì„¤ì¹˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
        return $false
    }
}

# ========================================
# ì„¤ì • íŒŒì¼ ìƒì„± í•¨ìˆ˜ë“¤
# ========================================

function Create-TelegramConfig {
    param([string]$WorkDir)

    $telegramConfigPath = Join-Path $WorkDir "shared\config\telegram_config.py"
    $telegramConfig = @"
"""
Telegram ì„¤ì • - Phoenix 95 V4 Enhanced
ì‹¤ì‹œê°„ ê±°ë˜ ì•Œë¦¼ ë° ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§
"""

TELEGRAM_CONFIG = {
    "token": "$($script:V4Config.TelegramToken)",
    "chat_id": "$($script:V4Config.TelegramChatId)",
    "webhook_secret": "$($script:V4Config.WebhookSecret)",
    "enabled": True,
    "timeout": 30,
    "retry_count": 3,
    "parse_mode": "HTML",
    "disable_notification": False,
    "thread_id": None
}

def send_telegram_signal(message, message_type="info"):
    """V4 í˜¸í™˜ í…”ë ˆê·¸ë¨ ì „ì†¡ í•¨ìˆ˜"""
    import requests
    import time
    from datetime import datetime

    emoji_map = {
        "info": "â„¹ï¸",
        "success": "âœ…", 
        "warning": "âš ï¸",
        "error": "âŒ",
        "trade": "ğŸ’°",
        "system": "ğŸ”§",
        "phoenix95": "ğŸŒŠ"
    }

    formatted_message = f"{emoji_map.get(message_type, 'â„¹ï¸')} <b>Phoenix 95 V4</b>\n\n{message}\n\nâ° {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\nğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform"

    url = f"https://api.telegram.org/bot{TELEGRAM_CONFIG['token']}/sendMessage"
    data = {
        'chat_id': TELEGRAM_CONFIG['chat_id'],
        'text': formatted_message,
        'parse_mode': TELEGRAM_CONFIG['parse_mode'],
        'disable_notification': TELEGRAM_CONFIG['disable_notification']
    }

    for attempt in range(TELEGRAM_CONFIG['retry_count']):
        try:
            response = requests.post(url, data=data, timeout=TELEGRAM_CONFIG['timeout'])
            if response.status_code == 200:
                print(f"âœ… í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ: {message_type}")
                return True
            else:
                print(f"âŒ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}): HTTP {response.status_code}")
        except Exception as e:
            print(f"âŒ í…”ë ˆê·¸ë¨ ì „ì†¡ ì˜¤ë¥˜ (ì‹œë„ {attempt + 1}): {e}")
            if attempt < TELEGRAM_CONFIG['retry_count'] - 1:
                time.sleep(2 ** attempt)

    return False

def send_trading_alert(symbol, side, price, confidence, leverage=1, ai_score=None):
    """ê±°ë˜ ì•Œë¦¼ ì „ì†¡ - Phoenix 95 ì „ìš©"""
    phoenix_grade = "ğŸ† ìš°ìˆ˜" if confidence > 0.8 else "âœ… ì–‘í˜¸" if confidence > 0.6 else "âš ï¸ ë³´í†µ"

    message = f"""
ğŸ¯ <b>Phoenix 95 ê±°ë˜ ì‹ í˜¸ ë°œìƒ</b>

ğŸ“ˆ ì‹¬ë³¼: <code>{symbol}</code>
ğŸ“Š ë°©í–¥: <b>{side.upper()}</b>
ğŸ’µ ê°€ê²©: <code>${price:,.2f}</code>
ğŸ¯ ì‹ ë¢°ë„: <b>{confidence:.1%}</b>
âš¡ ë ˆë²„ë¦¬ì§€: <b>{leverage}x ISOLATED</b>
ğŸ¤– AI ì ìˆ˜: <code>{ai_score:.3f}</code> {phoenix_grade}

ğŸ”¥ Phoenix 95 V4 Enhanced
ğŸŒŠ 20x ë ˆë²„ë¦¬ì§€ íŠ¸ë ˆì´ë”© í™œì„±í™”
"""
    return send_telegram_signal(message, "trade")

def send_system_status(status, services_count, errors=None):
    """ì‹œìŠ¤í…œ ìƒíƒœ ì•Œë¦¼"""
    status_emoji = "âœ…" if status == "healthy" else "âŒ"
    message = f"""
{status_emoji} <b>Phoenix 95 V4 ì‹œìŠ¤í…œ ìƒíƒœ</b>

ğŸ–¥ï¸ ìƒíƒœ: <b>{status.upper()}</b>
âš¡ í™œì„± ì„œë¹„ìŠ¤: <b>{services_count}/11</b>
"""

    if errors:
        message += f"\nâš ï¸ ì˜¤ë¥˜:\n"
        for error in errors[:3]:
            message += f"â€¢ {error}\n"

    return send_telegram_signal(message, "system")

def send_phoenix95_analysis(analysis_result):
    """Phoenix 95 AI ë¶„ì„ ê²°ê³¼ ì•Œë¦¼"""
    message = f"""
ğŸ§  <b>Phoenix 95 AI ë¶„ì„ ì™„ë£Œ</b>

ğŸ“Š ì¢…í•© ì ìˆ˜: <b>{analysis_result.get('overall_score', 0):.3f}</b>
ğŸ¯ ì¶”ì²œ í–‰ë™: <b>{analysis_result.get('recommendation', 'HOLD')}</b>
ğŸ“ˆ ì‹œì¥ ì¡°ê±´: {analysis_result.get('market_condition', 'NEUTRAL')}
ğŸ’ª ì‹ í˜¸ ê°•ë„: {analysis_result.get('signal_strength', 'MEDIUM')}

ğŸ” ìƒì„¸ ë¶„ì„:
â€¢ ê¸°ìˆ ì  ë¶„ì„: {analysis_result.get('technical_score', 0):.2f}
â€¢ ê±°ë˜ëŸ‰ ë¶„ì„: {analysis_result.get('volume_score', 0):.2f}
â€¢ ëª¨ë©˜í…€ ì§€í‘œ: {analysis_result.get('momentum_score', 0):.2f}
â€¢ ì‹œì¥ ì •ì„œ: {analysis_result.get('sentiment_score', 0):.2f}

ğŸŒŠ Phoenix 95 V4 Enhanced AI
"""
    return send_telegram_signal(message, "phoenix95")
"@
    Set-Content -Path $telegramConfigPath -Value $telegramConfig -Encoding UTF8
}

function Create-LeverageConfig {
    param([string]$WorkDir)

    $leverageConfigPath = Join-Path $WorkDir "shared\config\leverage_config.py"
    $leverageConfig = @"
"""
ë ˆë²„ë¦¬ì§€ ì„¤ì • - Phoenix 95 V4 Enhanced
20x ISOLATED ë ˆë²„ë¦¬ì§€ íŠ¸ë ˆì´ë”© + ê³ ê¸‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬
"""

LEVERAGE_CONFIG = {
    "leverage": $($script:V4Config.LeverageConfig.Leverage),
    "margin_mode": "$($script:V4Config.LeverageConfig.MarginMode)",
    "stop_loss_percent": $($script:V4Config.LeverageConfig.StopLossPercent),
    "take_profit_percent": $($script:V4Config.LeverageConfig.TakeProfitPercent),
    "max_margin_ratio": $($script:V4Config.LeverageConfig.MaxMarginRatio),
    "liquidation_buffer": $($script:V4Config.LeverageConfig.LiquidationBuffer),
    "maintenance_margin": $($script:V4Config.LeverageConfig.MaintenanceMargin),
    "trading_fee": $($script:V4Config.LeverageConfig.TradingFee),
    "max_position_count": $($script:V4Config.LeverageConfig.MaxPositionCount),
    "daily_loss_limit": $($script:V4Config.LeverageConfig.DailyLossLimit),
    "risk_per_trade": $($script:V4Config.LeverageConfig.RiskPerTrade)
}

class LeverageRiskManager:
    """Phoenix 95 V4 ê³ ê¸‰ ë ˆë²„ë¦¬ì§€ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì‹œìŠ¤í…œ"""

    def __init__(self, config=LEVERAGE_CONFIG):
        self.config = config
        self.daily_pnl = 0.0
        self.position_count = 0
        self.total_margin_used = 0.0
        self.trade_history = []

    def calculate_kelly_position_size(self, win_rate, avg_win, avg_loss, account_balance):
        """Kelly Criterion ê¸°ë°˜ í¬ì§€ì…˜ ì‚¬ì´ì§•"""
        if avg_loss == 0:
            return 0

        kelly_fraction = (win_rate * avg_win - (1 - win_rate) * avg_loss) / avg_loss
        kelly_fraction = max(0, min(kelly_fraction, 0.25))

        return account_balance * kelly_fraction

    def calculate_position_size(self, account_balance, risk_percent, stop_loss_percent, confidence_score):
        """Phoenix 95 í–¥ìƒëœ í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°"""
        risk_amount = account_balance * risk_percent
        base_position_size = risk_amount / stop_loss_percent

        confidence_multiplier = min(confidence_score * 2, 1.5)
        adjusted_position_size = base_position_size * confidence_multiplier

        max_position = account_balance * self.config["max_margin_ratio"] / self.config["leverage"]

        if abs(self.daily_pnl) > account_balance * self.config["daily_loss_limit"]:
            return 0

        if self.total_margin_used > account_balance * self.config["max_margin_ratio"]:
            return 0

        return min(adjusted_position_size, max_position)

    def validate_leverage_trade(self, symbol, side, quantity, price, account_balance):
        """ê³ ê¸‰ ë ˆë²„ë¦¬ì§€ ê±°ë˜ ê²€ì¦"""
        if self.position_count >= self.config["max_position_count"]:
            return False, "ìµœëŒ€ í¬ì§€ì…˜ ìˆ˜ ì´ˆê³¼"

        required_margin = (quantity * price) / self.config["leverage"]
        available_margin = account_balance * self.config["max_margin_ratio"] - self.total_margin_used

        if required_margin > available_margin:
            return False, f"ë§ˆì§„ ë¶€ì¡±: í•„ìš” {required_margin:.2f}, ì‚¬ìš© ê°€ëŠ¥ {available_margin:.2f}"

        liquidation_price = self.calculate_liquidation_price(price, side)
        buffer_price = price * (1 + self.config["liquidation_buffer"] if side == "LONG" else 1 - self.config["liquidation_buffer"])

        if (side == "LONG" and liquidation_price > buffer_price) or (side == "SHORT" and liquidation_price < buffer_price):
            return False, "ì²­ì‚° ìœ„í—˜ ê³¼ë‹¤"

        today_trades = len([t for t in self.trade_history if t['date'] == self.get_today()])
        if today_trades >= 20:
            return False, "ì¼ì¼ ê±°ë˜ íšŸìˆ˜ ì´ˆê³¼"

        return True, "ê²€ì¦ ì„±ê³µ"

    def calculate_liquidation_price(self, entry_price, side):
        """ì •í™•í•œ ì²­ì‚° ê°€ê²© ê³„ì‚°"""
        maintenance_margin_rate = self.config["maintenance_margin"]

        if side == "LONG":
            liquidation_price = entry_price * (1 - (1/self.config["leverage"]) + maintenance_margin_rate)
        else:
            liquidation_price = entry_price * (1 + (1/self.config["leverage"]) - maintenance_margin_rate)

        return liquidation_price

    def calculate_pnl(self, entry_price, current_price, quantity, side):
        """ì†ìµ ê³„ì‚°"""
        if side == "LONG":
            pnl = (current_price - entry_price) * quantity
        else:
            pnl = (entry_price - current_price) * quantity

        leveraged_pnl = pnl * self.config["leverage"]
        fee = entry_price * quantity * self.config["trading_fee"] * 2

        return leveraged_pnl - fee

    def update_daily_pnl(self, pnl):
        """ì¼ì¼ ì†ìµ ì—…ë°ì´íŠ¸"""
        self.daily_pnl += pnl

        if abs(self.daily_pnl) > self.config["daily_loss_limit"]:
            try:
                from telegram_config import send_telegram_signal
                message = f"âš ï¸ ì¼ì¼ ì†ì‹¤ í•œë„ ì´ˆê³¼: {self.daily_pnl:.2%}\nğŸ›‘ ê±°ë˜ ìë™ ì¤‘ì§€ë¨"
                send_telegram_signal(message, "warning")
            except:
                pass

    def get_risk_metrics(self):
        """í˜„ì¬ ë¦¬ìŠ¤í¬ ì§€í‘œ ë°˜í™˜"""
        return {
            "daily_pnl": self.daily_pnl,
            "position_count": self.position_count,
            "margin_utilization": self.total_margin_used,
            "max_positions": self.config["max_position_count"],
            "daily_limit": self.config["daily_loss_limit"],
            "leverage": self.config["leverage"],
            "margin_mode": self.config["margin_mode"]
        }

    def get_today(self):
        """ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜"""
        from datetime import datetime
        return datetime.now().strftime('%Y-%m-%d')

def validate_leverage_settings():
    """ë ˆë²„ë¦¬ì§€ ì„¤ì • ê²€ì¦"""
    required_keys = ["leverage", "margin_mode", "stop_loss_percent", "take_profit_percent"]
    for key in required_keys:
        if key not in LEVERAGE_CONFIG:
            raise ValueError(f"í•„ìˆ˜ ë ˆë²„ë¦¬ì§€ ì„¤ì • ëˆ„ë½: {key}")

    if LEVERAGE_CONFIG["leverage"] > 100:
        raise ValueError("ë ˆë²„ë¦¬ì§€ê°€ 100ë°°ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

    if LEVERAGE_CONFIG["margin_mode"] not in ["ISOLATED", "CROSS"]:
        raise ValueError("ë§ˆì§„ ëª¨ë“œëŠ” ISOLATED ë˜ëŠ” CROSSì—¬ì•¼ í•©ë‹ˆë‹¤")

    return True

# ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤
risk_manager = LeverageRiskManager()
"@
    Set-Content -Path $leverageConfigPath -Value $leverageConfig -Encoding UTF8
}

function Create-TradingConfig {
    param([string]$WorkDir)

    $tradingConfigPath = Join-Path $WorkDir "shared\config\trading_config.py"
    $tradingConfig = @"
"""
ê±°ë˜ ì„¤ì • - Phoenix 95 V4 Enhanced
AI ê¸°ë°˜ ì‹ í˜¸ ì²˜ë¦¬ ë° ê³ ê¸‰ ê±°ë˜ ë¡œì§
"""
import time
import numpy as np
from datetime import datetime, timedelta

TRADING_CONFIG = {
    "allowed_symbols": [
        "BTCUSDT", "ETHUSDT", "BNBUSDT", "ADAUSDT", "DOGEUSDT", 
        "XRPUSDT", "SOLUSDT", "AVAXUSDT", "DOTUSDT", "LINKUSDT"
    ],
    "min_confidence": $($script:V4Config.TradingConfig.MinConfidence),
    "phoenix_95_threshold": $($script:V4Config.TradingConfig.Phoenix95Threshold),
    "max_position_size": $($script:V4Config.TradingConfig.MaxPositionSize),
    "kelly_fraction": $($script:V4Config.TradingConfig.KellyFraction),
    "quality_threshold": $($script:V4Config.TradingConfig.QualityThreshold),
    "real_data_weight": $($script:V4Config.TradingConfig.RealDataWeight),
    "phoenix_95_weight": $($script:V4Config.TradingConfig.Phoenix95Weight),
    "min_trade_amount": $($script:V4Config.TradingConfig.MinTradeAmount),
    "max_trade_amount": $($script:V4Config.TradingConfig.MaxTradeAmount),
    "cooldown_period": $($script:V4Config.TradingConfig.CooldownPeriod),
    "market_hours_only": $($script:V4Config.TradingConfig.MarketHoursOnly),
    "weekend_trading": $($script:V4Config.TradingConfig.WeekendTrading)
}

class Phoenix95TradingEngine:
    """Phoenix 95 V4 Enhanced AI ê±°ë˜ ì—”ì§„"""

    def __init__(self, config=TRADING_CONFIG):
        self.config = config
        self.last_trade_time = {}
        self.position_tracker = {}
        self.market_data_cache = {}
        self.ai_model_cache = {}

    def process_signal(self, signal_data):
        """ê±°ë˜ ì‹ í˜¸ ì²˜ë¦¬ - Phoenix 95 í•µì‹¬ ë¡œì§"""
        is_valid, error_msg = self.validate_trading_signal(signal_data)
        if not is_valid:
            return {"status": "rejected", "reason": error_msg}

        ai_analysis = self.analyze_with_phoenix95_ai(signal_data)
        if ai_analysis["score"] < self.config["phoenix_95_threshold"]:
            return {"status": "rejected", "reason": f"Phoenix 95 ì ìˆ˜ ë¶€ì¡±: {ai_analysis['score']:.3f}"}

        multi_factor_score = self.calculate_multi_factor_score(signal_data)
        risk_assessment = self.assess_comprehensive_risk(signal_data, ai_analysis)
        
        if risk_assessment["risk_level"] > 0.75:
            return {"status": "rejected", "reason": "ì¢…í•© ë¦¬ìŠ¤í¬ ìˆ˜ì¤€ ê³¼ë‹¤"}

        optimal_size = self.calculate_kelly_position_size(signal_data, ai_analysis)
        trade_order = self.create_trade_order(signal_data, ai_analysis, optimal_size)

        return {"status": "approved", "order": trade_order, "analysis": ai_analysis}

    def analyze_with_phoenix95_ai(self, signal_data):
        """Phoenix 95 AI í•µì‹¬ ë¶„ì„ ì—”ì§„"""
        technical_score = self.analyze_technical_indicators(signal_data)
        volume_score = self.analyze_volume_profile(signal_data)
        momentum_score = self.analyze_momentum_indicators(signal_data)
        sentiment_score = self.analyze_market_sentiment(signal_data)
        pattern_score = self.recognize_chart_patterns(signal_data)

        weights = {
            "technical": 0.25,
            "volume": 0.20,
            "momentum": 0.25,
            "sentiment": 0.15,
            "pattern": 0.15
        }

        phoenix95_score = (
            technical_score * weights["technical"] +
            volume_score * weights["volume"] +
            momentum_score * weights["momentum"] +
            sentiment_score * weights["sentiment"] +
            pattern_score * weights["pattern"]
        )

        phoenix95_score *= self.config["phoenix_95_weight"]

        return {
            "score": min(phoenix95_score, 1.0),
            "technical_score": technical_score,
            "volume_score": volume_score,
            "momentum_score": momentum_score,
            "sentiment_score": sentiment_score,
            "pattern_score": pattern_score,
            "confidence": phoenix95_score,
            "recommendation": self.get_recommendation(phoenix95_score),
            "market_condition": self.assess_market_condition(signal_data)
        }

    def analyze_technical_indicators(self, signal_data):
        """ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„"""
        try:
            rsi = signal_data.get("rsi", 50)
            rsi_score = self.normalize_rsi_score(rsi)

            macd = signal_data.get("macd", {})
            macd_score = self.analyze_macd_signals(macd)

            bb = signal_data.get("bollinger_bands", {})
            bb_score = self.analyze_bollinger_position(bb)

            ma_data = signal_data.get("moving_averages", {})
            ma_score = self.analyze_moving_average_trend(ma_data)

            technical_score = (rsi_score * 0.3 + macd_score * 0.3 + bb_score * 0.2 + ma_score * 0.2)

            return min(max(technical_score, 0), 1)
        except:
            return 0.5

    def analyze_volume_profile(self, signal_data):
        """ê±°ë˜ëŸ‰ í”„ë¡œíŒŒì¼ ë¶„ì„"""
        try:
            volume = signal_data.get("volume", 0)
            avg_volume = signal_data.get("avg_volume_20", volume)

            if avg_volume == 0:
                return 0.5

            volume_ratio = volume / avg_volume

            if volume_ratio > 2.0:
                return 0.9
            elif volume_ratio > 1.5:
                return 0.8
            elif volume_ratio > 1.2:
                return 0.7
            elif volume_ratio > 0.8:
                return 0.6
            else:
                return 0.4
        except:
            return 0.5

    def analyze_momentum_indicators(self, signal_data):
        """ëª¨ë©˜í…€ ì§€í‘œ ë¶„ì„"""
        try:
            stoch = signal_data.get("stochastic", {})
            stoch_score = self.analyze_stochastic_signals(stoch)

            williams_r = signal_data.get("williams_r", -50)
            williams_score = self.normalize_williams_score(williams_r)

            cci = signal_data.get("cci", 0)
            cci_score = self.normalize_cci_score(cci)

            momentum_score = (stoch_score * 0.4 + williams_score * 0.3 + cci_score * 0.3)

            return min(max(momentum_score, 0), 1)
        except:
            return 0.5

    def analyze_market_sentiment(self, signal_data):
        """ì‹œì¥ ì •ì„œ ë¶„ì„"""
        try:
            fear_greed = signal_data.get("fear_greed_index", 50)
            sentiment_score = self.interpret_fear_greed_index(fear_greed)

            social_sentiment = signal_data.get("social_sentiment", 0.5)
            news_sentiment = signal_data.get("news_sentiment", 0.5)

            combined_sentiment = (sentiment_score * 0.5 + social_sentiment * 0.3 + news_sentiment * 0.2)

            return min(max(combined_sentiment, 0), 1)
        except:
            return 0.5

    def recognize_chart_patterns(self, signal_data):
        """ì°¨íŠ¸ íŒ¨í„´ ì¸ì‹"""
        try:
            patterns = signal_data.get("chart_patterns", [])

            pattern_scores = {
                "hammer": 0.8,
                "doji": 0.6,
                "engulfing": 0.9,
                "triangle": 0.7,
                "flag": 0.8,
                "head_shoulders": 0.9,
                "double_top": 0.8,
                "double_bottom": 0.8
            }

            if not patterns:
                return 0.5

            max_score = max([pattern_scores.get(pattern, 0.5) for pattern in patterns])
            return max_score
        except:
            return 0.5

    def calculate_kelly_position_size(self, signal_data, ai_analysis):
        """Kelly Criterion ê¸°ë°˜ í¬ì§€ì…˜ ì‚¬ì´ì§•"""
        try:
            win_rate = ai_analysis.get("confidence", 0.5)
            avg_win = signal_data.get("avg_win", 0.02)
            avg_loss = signal_data.get("avg_loss", 0.02)

            if avg_loss == 0:
                return 0.01

            kelly_fraction = (win_rate * avg_win - (1 - win_rate) * avg_loss) / avg_loss
            kelly_fraction = max(0, min(kelly_fraction, self.config["kelly_fraction"]))

            return kelly_fraction
        except:
            return 0.02

    def get_recommendation(self, score):
        """ì ìˆ˜ ê¸°ë°˜ ì¶”ì²œ í–‰ë™"""
        if score > 0.8:
            return "STRONG_BUY"
        elif score > 0.6:
            return "BUY"
        elif score > 0.4:
            return "HOLD"
        elif score > 0.2:
            return "SELL"
        else:
            return "STRONG_SELL"

    def assess_market_condition(self, signal_data):
        """ì‹œì¥ ìƒí™© í‰ê°€"""
        volatility = signal_data.get("volatility", 0.02)

        if volatility > 0.05:
            return "HIGH_VOLATILITY"
        elif volatility > 0.03:
            return "MEDIUM_VOLATILITY"
        else:
            return "LOW_VOLATILITY"

    def validate_trading_signal(self, signal):
        """ê±°ë˜ ì‹ í˜¸ ê²€ì¦"""
        required_fields = ["symbol", "side", "confidence"]
        for field in required_fields:
            if field not in signal:
                return False, f"í•„ìˆ˜ í•„ë“œ ëˆ„ë½: {field}"

        if signal["symbol"] not in self.config["allowed_symbols"]:
            return False, f"í—ˆìš©ë˜ì§€ ì•Šì€ ì‹¬ë³¼: {signal['symbol']}"

        if signal["confidence"] < self.config["min_confidence"]:
            return False, f"ì‹ ë¢°ë„ ë¶€ì¡±: {signal['confidence']:.3f}"

        last_trade = self.last_trade_time.get(signal["symbol"], 0)
        if time.time() - last_trade < self.config["cooldown_period"]:
            return False, "ì¿¨ë‹¤ìš´ ê¸°ê°„ ì¤‘"

        return True, "ê²€ì¦ ì„±ê³µ"

def get_trading_status():
    """í˜„ì¬ ê±°ë˜ ìƒíƒœ ë°˜í™˜"""
    now = datetime.now()

    return {
        "trading_enabled": True,
        "current_time": now.isoformat(),
        "platform": "$script:CurrentPlatform",
        "config_loaded": True,
        "phoenix95_active": True,
        "leverage_enabled": True,
        "telegram_connected": True,
        "ai_engine_status": "operational",
        "ddd_architecture": "active"
    }

# ê¸€ë¡œë²Œ ê±°ë˜ ì—”ì§„ ì¸ìŠ¤í„´ìŠ¤
trading_engine = Phoenix95TradingEngine()
"@
    Set-Content -Path $tradingConfigPath -Value $tradingConfig -Encoding UTF8
}

function Create-CompleteDockerCompose {
    param([string]$WorkDir)

    $dockerComposePath = Join-Path $WorkDir "docker-compose.yml"
    $dockerComposeContent = @"
version: '3.8'

services:
  postgresql:
    image: postgres:15
    container_name: phoenix95-v4-enhanced_postgresql_1
    environment:
      POSTGRES_DB: phoenix95_v4
      POSTGRES_USER: phoenix95
      POSTGRES_PASSWORD: phoenix95_secure_pass_2025
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/data_storage/postgresql/schemas:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U phoenix95"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: phoenix95-v4-enhanced_redis_1
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  influxdb:
    image: influxdb:2.7
    container_name: phoenix95-v4-enhanced_influxdb_1
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: phoenix95
      DOCKER_INFLUXDB_INIT_PASSWORD: phoenix95_influx_2025
      DOCKER_INFLUXDB_INIT_ORG: phoenix95
      DOCKER_INFLUXDB_INIT_BUCKET: trading_data
    ports:
      - "8086:8086"
    volumes:
      - influx_data:/var/lib/influxdb2
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: phoenix95-v4-enhanced_prometheus_1
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  grafana:
    image: grafana/grafana:latest
    container_name: phoenix95-v4-enhanced_grafana_1
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: phoenix95_grafana_2025
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana:/etc/grafana/provisioning
    restart: unless-stopped
    depends_on:
      - prometheus

volumes:
  postgres_data:
  redis_data:
  influx_data:
  grafana_data:
  prometheus_data:

networks:
  default:
    name: phoenix95_network
"@
    Set-Content -Path $dockerComposePath -Value $dockerComposeContent -Encoding UTF8
}

function Create-PrometheusConfig {
    param([string]$WorkDir)

    $prometheusConfigPath = Join-Path $WorkDir "infrastructure\monitoring\prometheus\prometheus.yml"
    if (-not (Test-Path (Split-Path $prometheusConfigPath))) {
        New-Item -ItemType Directory -Path (Split-Path $prometheusConfigPath) -Force | Out-Null
    }

    $prometheusConfig = @"
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  - job_name: 'phoenix95-v4-services'
    static_configs:
      - targets: ['host.docker.internal:8100', 'host.docker.internal:8103', 'host.docker.internal:8106']
    scrape_interval: 10s
    metrics_path: /metrics
"@
    Set-Content -Path $prometheusConfigPath -Value $prometheusConfig -Encoding UTF8
}

# ========================================
# ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒì„± í•¨ìˆ˜ë“¤
# ========================================

function Create-AllMicroservicesWithBusinessLogic {
    param([string]$WorkDir)

    Write-Log "ğŸ—ï¸ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í¬í•¨í•œ 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒì„± ì¤‘..." "INFO"

    # 1. API Gateway Enterprise (8100)
    Create-ApiGatewayEnterprise -WorkDir $WorkDir

    # 2. Signal Ingestion Pro (8101)
    Create-SignalIngestionPro -WorkDir $WorkDir

    # 3. Market Data Intelligence (8102)
    Create-MarketDataIntelligence -WorkDir $WorkDir

    # 4. Phoenix95 AI Engine (8103) - í•µì‹¬!
    Create-Phoenix95AIEngine -WorkDir $WorkDir

    # 5. Risk Management Advanced (8104)
    Create-RiskManagementAdvanced -WorkDir $WorkDir

    # 6. Portfolio Optimizer Quant (8105)
    Create-PortfolioOptimizerQuant -WorkDir $WorkDir

    # 7. Trade Execution Leverage (8106) - í•µì‹¬!
    Create-TradeExecutionLeverage -WorkDir $WorkDir

    # 8. Position Tracker Realtime (8107)
    Create-PositionTrackerRealtime -WorkDir $WorkDir

    # 9. Compliance Monitor Regulatory (8108)
    Create-ComplianceMonitorRegulatory -WorkDir $WorkDir

    # 10. Notification Hub Intelligent (8109)
    Create-NotificationHubIntelligent -WorkDir $WorkDir

    # 11. Client Dashboard Analytics (8110)
    Create-ClientDashboardAnalytics -WorkDir $WorkDir

    Write-Log "âœ… 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹¤ì œ êµ¬í˜„ ì™„ë£Œ" "SUCCESS"
}

function Create-ApiGatewayEnterprise {
    param([string]$WorkDir)

    $servicePath = Join-Path $WorkDir "services\api-gateway-enterprise"
    $mainPy = @"
from fastapi import FastAPI, HTTPException, Depends, Request, BackgroundTasks
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from prometheus_client import Counter, Histogram, generate_latest
import uvicorn
import argparse
import requests
import asyncio
import time
import sys
import os
from datetime import datetime

# ìƒìœ„ í´ë”ì˜ ì„¤ì • íŒŒì¼ import ê²½ë¡œ ì¶”ê°€
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'shared', 'config'))

try:
    from telegram_config import send_telegram_signal, send_system_status
    from trading_config import get_trading_status, trading_engine
    from leverage_config import risk_manager
    CONFIGS_LOADED = True
except ImportError as e:
    CONFIGS_LOADED = False
    print(f"âš ï¸ ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")

app = FastAPI(
    title="Phoenix 95 API Gateway Enterprise", 
    version="4.0.0",
    description="ğŸŒŠ Phoenix 95 V4 ì¤‘ì•™í™”ëœ API ê²Œì´íŠ¸ì›¨ì´ - ëª¨ë“  ì„œë¹„ìŠ¤ ìš”ì²­ ë¼ìš°íŒ… ë° ë¶€í•˜ ë¶„ì‚°"
)

# CORS ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Prometheus ë©”íŠ¸ë¦­
REQUEST_COUNT = Counter('phoenix95_requests_total', 'Total requests', ['method', 'endpoint'])
REQUEST_DURATION = Histogram('phoenix95_request_duration_seconds', 'Request duration')

# ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ (Phoenix 95 V4 ì „ì²´ ì•„í‚¤í…ì²˜)
SERVICE_REGISTRY = {
    "signal-ingestion-pro": {"url": "http://localhost:8101", "health": True, "load": 0},
    "market-data-intelligence": {"url": "http://localhost:8102", "health": True, "load": 0}, 
    "phoenix95-ai-engine": {"url": "http://localhost:8103", "health": True, "load": 0},
    "risk-management-advanced": {"url": "http://localhost:8104", "health": True, "load": 0},
    "portfolio-optimizer-quant": {"url": "http://localhost:8105", "health": True, "load": 0},
    "trade-execution-leverage": {"url": "http://localhost:8106", "health": True, "load": 0},
    "position-tracker-realtime": {"url": "http://localhost:8107", "health": True, "load": 0},
    "compliance-monitor-regulatory": {"url": "http://localhost:8108", "health": True, "load": 0},
    "notification-hub-intelligent": {"url": "http://localhost:8109", "health": True, "load": 0},
    "client-dashboard-analytics": {"url": "http://localhost:8110", "health": True, "load": 0}
}

@app.middleware("http")
async def metrics_middleware(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time

    REQUEST_COUNT.labels(method=request.method, endpoint=request.url.path).inc()
    REQUEST_DURATION.observe(duration)

    return response

@app.get("/")
async def root():
    return {
        "service": "Phoenix 95 API Gateway Enterprise",
        "version": "4.0.0",
        "status": "ğŸŒŠ Phoenix 95 V4 Enhanced í™œì„±í™”",
        "platform": "$script:CurrentPlatform",
        "environment": "$Environment",
        "features": {
            "ddd_architecture": True,
            "leverage_trading": "20x ISOLATED",
            "ai_engine": "Phoenix 95 V4",
            "telegram_alerts": CONFIGS_LOADED,
            "microservices": len(SERVICE_REGISTRY)
        },
        "timestamp": datetime.now().isoformat()
    }

@app.get("/health")
async def health_check():
    # ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
    healthy_services = await check_all_services_health()
    total_services = len(SERVICE_REGISTRY)

    health_status = "healthy" if healthy_services >= total_services * 0.8 else "degraded"

    return {
        "status": health_status,
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "environment": "$Environment", 
        "version": "4.0.0",
        "uptime_seconds": 60,
        "services": {
            "total": total_services,
            "healthy": healthy_services,
            "unhealthy": total_services - healthy_services
        },
        "features": {
            "phoenix95_ai": "operational",
            "leverage_trading": "20x active",
            "ddd_architecture": "enabled",
            "telegram_notifications": CONFIGS_LOADED
        }
    }

@app.get("/services/status")
async def get_services_status():
    """ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒíƒœ ì¡°íšŒ"""
    services_status = {}

    for service_name, service_info in SERVICE_REGISTRY.items():
        try:
            start_time = time.time()
            response = requests.get(f"{service_info['url']}/health", timeout=3)
            response_time = (time.time() - start_time) * 1000

            if response.status_code == 200:
                services_status[service_name] = {
                    "status": "healthy",
                    "url": service_info['url'],
                    "response_time_ms": round(response_time, 2),
                    "load": service_info['load']
                }
                SERVICE_REGISTRY[service_name]["health"] = True
            else:
                services_status[service_name] = {
                    "status": f"unhealthy (HTTP {response.status_code})",
                    "url": service_info['url']
                }
                SERVICE_REGISTRY[service_name]["health"] = False
        except Exception as e:
            services_status[service_name] = {
                "status": f"unreachable ({str(e)[:50]}...)",
                "url": service_info['url']
            }
            SERVICE_REGISTRY[service_name]["health"] = False

    return {
        "services": services_status,
        "platform": "$script:CurrentPlatform",
        "timestamp": datetime.now().isoformat(),
        "gateway_version": "4.0.0"
    }

@app.post("/phoenix95/signal")
async def process_phoenix95_signal(signal_data: dict, background_tasks: BackgroundTasks):
    """Phoenix 95 ê±°ë˜ ì‹ í˜¸ ì²˜ë¦¬ - í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"""
    try:
        if not CONFIGS_LOADED:
            raise HTTPException(status_code=500, detail="Phoenix 95 ì„¤ì • ë¡œë“œ ì‹¤íŒ¨")

        # 1. Phoenix 95 AI ì—”ì§„ìœ¼ë¡œ ì‹ í˜¸ ë¶„ì„
        ai_response = await forward_to_service("phoenix95-ai-engine", "/analyze", signal_data)

        if not ai_response or "error" in ai_response:
            raise HTTPException(status_code=500, detail="Phoenix 95 AI ì—”ì§„ ë¶„ì„ ì‹¤íŒ¨")

        # 2. ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê²€ì¦
        risk_response = await forward_to_service("risk-management-advanced", "/validate", {
            **signal_data,
            "ai_analysis": ai_response
        })

        # 3. ì‹ ë¢°ë„ê°€ ë†’ì€ ì‹ í˜¸ë§Œ ì²˜ë¦¬
        if ai_response.get("confidence", 0) > 0.7:
            # 4. ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰
            if ai_response.get("recommendation") in ["STRONG_BUY", "BUY", "STRONG_SELL", "SELL"]:
                trade_response = await forward_to_service("trade-execution-leverage", "/execute", {
                    **signal_data,
                    "ai_analysis": ai_response,
                    "risk_assessment": risk_response
                })

                # 5. í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡
                if CONFIGS_LOADED:
                    background_tasks.add_task(
                        send_phoenix95_trade_alert,
                        signal_data,
                        ai_response,
                        trade_response
                    )

        return {
            "status": "processed",
            "signal_id": f"phoenix95_{int(time.time())}",
            "ai_analysis": ai_response,
            "risk_assessment": risk_response,
            "timestamp": datetime.now().isoformat(),
            "phoenix95_version": "4.0.0"
        }

    except Exception as e:
        return {"error": str(e), "status": "failed", "timestamp": datetime.now().isoformat()}

@app.get("/phoenix95/dashboard")
async def get_phoenix95_dashboard():
    """Phoenix 95 ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ ë°ì´í„°"""
    try:
        # í¬ì§€ì…˜ íŠ¸ë˜ì»¤ì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        positions = await forward_to_service("position-tracker-realtime", "/positions", {})

        # ë¦¬ìŠ¤í¬ ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸°
        risk_metrics = await forward_to_service("risk-management-advanced", "/metrics", {})

        # í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ê°€ì ¸ì˜¤ê¸°
        portfolio = await forward_to_service("portfolio-optimizer-quant", "/performance", {})

        return {
            "phoenix95_status": "operational",
            "active_positions": positions,
            "risk_metrics": risk_metrics,
            "portfolio_performance": portfolio,
            "leverage": "20x ISOLATED",
            "ai_engine": "Phoenix 95 V4",
            "platform": "$script:CurrentPlatform",
            "last_updated": datetime.now().isoformat()
        }
    except Exception as e:
        return {"error": str(e), "status": "dashboard_error"}

@app.get("/metrics")
async def get_prometheus_metrics():
    """Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸"""
    return generate_latest()

async def forward_to_service(service_name: str, endpoint: str, data: dict):
    """ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì„ ìœ„í•œ ìš”ì²­ ì „ë‹¬"""
    if service_name not in SERVICE_REGISTRY:
        return {"error": f"Unknown service: {service_name}"}

    service_info = SERVICE_REGISTRY[service_name]

    if not service_info["health"]:
        return {"error": f"Service {service_name} is unhealthy"}

    try:
        url = f"{service_info['url']}{endpoint}"
        response = requests.post(url, json=data, timeout=10)

        if response.status_code == 200:
            SERVICE_REGISTRY[service_name]["load"] += 1
            return response.json()
        else:
            return {"error": f"Service returned {response.status_code}"}
    except Exception as e:
        SERVICE_REGISTRY[service_name]["health"] = False
        return {"error": str(e)}

async def check_all_services_health():
    """ëª¨ë“  ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬"""
    healthy_count = 0

    for service_name, service_info in SERVICE_REGISTRY.items():
        try:
            response = requests.get(f"{service_info['url']}/health", timeout=2)
            if response.status_code == 200:
                healthy_count += 1
                SERVICE_REGISTRY[service_name]["health"] = True
            else:
                SERVICE_REGISTRY[service_name]["health"] = False
        except:
            SERVICE_REGISTRY[service_name]["health"] = False

    return healthy_count

async def send_phoenix95_trade_alert(signal_data, ai_analysis, trade_response):
    """Phoenix 95 ê±°ë˜ ì•Œë¦¼ ì „ì†¡"""
    try:
        if CONFIGS_LOADED:
            from telegram_config import send_trading_alert

            send_trading_alert(
                signal_data.get("symbol", "UNKNOWN"),
                signal_data.get("side", "UNKNOWN"), 
                signal_data.get("price", 0),
                ai_analysis.get("confidence", 0),
                signal_data.get("leverage", 20),
                ai_analysis.get("score", 0)
            )
    except Exception as e:
        print(f"í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8100)
    parser.add_argument("--environment", default="$Environment")
    args = parser.parse_args()

    print(f"ğŸŒŠ Phoenix 95 API Gateway Enterprise ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸŒ í™˜ê²½: {args.environment}")
    print(f"ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform")
    print(f"âš¡ ë ˆë²„ë¦¬ì§€: 20x ISOLATED")
    print(f"ğŸ¤– AI ì—”ì§„: Phoenix 95 V4")

    # ì‹œì‘ ì•Œë¦¼ ì „ì†¡
    if CONFIGS_LOADED:
        try:
            send_system_status("healthy", len(SERVICE_REGISTRY))
        except:
            pass

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}

function Create-Phoenix95AIEngine {
    param([string]$WorkDir)

    $servicePath = Join-Path $WorkDir "services\phoenix95-ai-engine"
    $mainPy = @"
from fastapi import FastAPI, HTTPException
import uvicorn
import argparse
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import sys
import os
import json

# ìƒìœ„ í´ë”ì˜ ì„¤ì • íŒŒì¼ import
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'shared', 'config'))

try:
    from trading_config import Phoenix95TradingEngine, TRADING_CONFIG
    from telegram_config import send_phoenix95_analysis
    CONFIG_LOADED = True
except ImportError:
    CONFIG_LOADED = False

app = FastAPI(title="Phoenix 95 AI Engine", version="4.0.0")

# Phoenix 95 AI ì—”ì§„ ì¸ìŠ¤í„´ìŠ¤
if CONFIG_LOADED:
    ai_engine = Phoenix95TradingEngine()
else:
    ai_engine = None

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "phoenix95-ai-engine",
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "version": "4.0.0",
        "ai_model": "Phoenix 95 V4 Enhanced",
        "config_loaded": CONFIG_LOADED,
        "analysis_ready": ai_engine is not None
    }

@app.post("/analyze")
async def analyze_trading_signal(signal_data: dict):
    """Phoenix 95 AI í•µì‹¬ ë¶„ì„ ì—”ì§„"""
    if not ai_engine:
        raise HTTPException(status_code=500, detail="Phoenix 95 AI ì—”ì§„ì´ ë¡œë“œë˜ì§€ ì•ŠìŒ")

    try:
        # Phoenix 95 AI ë¶„ì„ ì‹¤í–‰
        analysis_result = ai_engine.analyze_with_phoenix95_ai(signal_data)

        # ê³ ê¸‰ ê¸°ìˆ ì  ë¶„ì„ ì¶”ê°€
        enhanced_analysis = perform_enhanced_technical_analysis(signal_data)

        # ì‹œì¥ ì¡°ê±´ ë¶„ì„
        market_condition = analyze_market_conditions(signal_data)

        # ë¦¬ìŠ¤í¬ ì¡°ì •ëœ ìµœì¢… ì ìˆ˜
        final_score = calculate_risk_adjusted_score(
            analysis_result["score"], 
            enhanced_analysis,
            market_condition
        )

        # ê²°ê³¼ í†µí•©
        comprehensive_result = {
            **analysis_result,
            "final_score": final_score,
            "enhanced_technical": enhanced_analysis,
            "market_condition": market_condition,
            "trading_recommendation": get_trading_recommendation(final_score),
            "confidence_level": categorize_confidence(final_score),
            "analysis_timestamp": datetime.now().isoformat(),
            "ai_version": "Phoenix 95 V4 Enhanced"
        }

        # ê³ ì‹ ë¢°ë„ ë¶„ì„ ê²°ê³¼ ì•Œë¦¼
        if final_score > 0.8 and CONFIG_LOADED:
            try:
                send_phoenix95_analysis(comprehensive_result)
            except:
                pass

        return comprehensive_result

    except Exception as e:
        return {"error": str(e), "analysis_failed": True}

@app.post("/backtest")
async def run_backtest(backtest_params: dict):
    """Phoenix 95 ì „ëµ ë°±í…ŒìŠ¤íŒ…"""
    try:
        # ë°±í…ŒìŠ¤íŠ¸ íŒŒë¼ë¯¸í„°
        start_date = backtest_params.get("start_date", "2023-01-01")
        end_date = backtest_params.get("end_date", datetime.now().strftime("%Y-%m-%d"))
        initial_capital = backtest_params.get("initial_capital", 10000)

        # ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” íˆìŠ¤í† ë¦¬ì»¬ ë°ì´í„° ì‚¬ìš©)
        simulation_results = simulate_phoenix95_strategy(start_date, end_date, initial_capital)

        return {
            "backtest_results": simulation_results,
            "strategy": "Phoenix 95 V4 Enhanced",
            "period": f"{start_date} to {end_date}",
            "initial_capital": initial_capital,
            "final_capital": simulation_results["final_capital"],
            "total_return": simulation_results["total_return"],
            "sharpe_ratio": simulation_results["sharpe_ratio"],
            "max_drawdown": simulation_results["max_drawdown"],
            "win_rate": simulation_results["win_rate"]
        }
    except Exception as e:
        return {"error": str(e), "backtest_failed": True}

@app.get("/model/status")
async def get_model_status():
    """AI ëª¨ë¸ ìƒíƒœ ì •ë³´"""
    return {
        "model_name": "Phoenix 95 V4 Enhanced",
        "model_version": "4.0.0",
        "loaded": ai_engine is not None,
        "last_trained": "2024-12-01",
        "accuracy": 0.85,
        "features": {
            "technical_indicators": 15,
            "sentiment_analysis": True,
            "pattern_recognition": True,
            "risk_assessment": True,
            "kelly_criterion": True
        },
        "performance_metrics": {
            "precision": 0.82,
            "recall": 0.87,
            "f1_score": 0.84
        }
    }

def perform_enhanced_technical_analysis(signal_data):
    """ê³ ê¸‰ ê¸°ìˆ ì  ë¶„ì„"""
    try:
        # í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ë¶„ì„
        fibonacci_score = analyze_fibonacci_levels(signal_data)

        # ì¼ëª©ê· í˜•í‘œ ë¶„ì„
        ichimoku_score = analyze_ichimoku_cloud(signal_data)

        # ì—˜ë¦¬ì–´íŠ¸ íŒŒë™ ë¶„ì„
        elliott_score = analyze_elliott_waves(signal_data)

        # í•˜ëª¨ë‹‰ íŒ¨í„´ ë¶„ì„
        harmonic_score = analyze_harmonic_patterns(signal_data)

        return {
            "fibonacci_score": fibonacci_score,
            "ichimoku_score": ichimoku_score,
            "elliott_score": elliott_score,
            "harmonic_score": harmonic_score,
            "composite_score": (fibonacci_score + ichimoku_score + elliott_score + harmonic_score) / 4
        }
    except:
        return {"composite_score": 0.5}

def analyze_market_conditions(signal_data):
    """ì‹œì¥ ì¡°ê±´ ì¢…í•© ë¶„ì„"""
    try:
        volatility = signal_data.get("volatility", 0.02)
        volume = signal_data.get("volume", 0)
        trend = signal_data.get("trend", "sideways")

        # VIX ìˆ˜ì¤€ ë¶„ì„
        vix_level = signal_data.get("vix", 20)
        fear_greed = signal_data.get("fear_greed_index", 50)

        if volatility > 0.05 or vix_level > 30:
            condition = "high_volatility"
        elif fear_greed < 25:
            condition = "extreme_fear"
        elif fear_greed > 75:
            condition = "extreme_greed"
        else:
            condition = "normal"

        return {
            "condition": condition,
            "volatility_level": "high" if volatility > 0.03 else "normal",
            "market_sentiment": "bearish" if fear_greed < 40 else "bullish" if fear_greed > 60 else "neutral",
            "trend_strength": abs(signal_data.get("adx", 25))
        }
    except:
        return {"condition": "unknown"}

def calculate_risk_adjusted_score(base_score, enhanced_analysis, market_condition):
    """ë¦¬ìŠ¤í¬ ì¡°ì •ëœ ì ìˆ˜ ê³„ì‚°"""
    try:
        # ê¸°ë³¸ ì ìˆ˜ì— ê³ ê¸‰ ë¶„ì„ ë°˜ì˜
        enhanced_weight = 0.3
        adjusted_score = base_score * (1 - enhanced_weight) + enhanced_analysis["composite_score"] * enhanced_weight

        # ì‹œì¥ ì¡°ê±´ì— ë”°ë¥¸ ì¡°ì •
        condition = market_condition.get("condition", "normal")
        if condition == "high_volatility":
            adjusted_score *= 0.8  # ë³€ë™ì„± ë†’ì„ ë•Œ ë³´ìˆ˜ì 
        elif condition == "extreme_fear":
            adjusted_score *= 1.2  # ê·¹ë‹¨ì  ê³µí¬ì‹œ ì—­ë°œìƒ
        elif condition == "extreme_greed":
            adjusted_score *= 0.7  # ê·¹ë‹¨ì  íƒìš•ì‹œ ë³´ìˆ˜ì 

        return min(max(adjusted_score, 0), 1)
    except:
        return base_score

def get_trading_recommendation(score):
    """ì ìˆ˜ ê¸°ë°˜ ê±°ë˜ ì¶”ì²œ"""
    if score > 0.85:
        return "VERY_STRONG_BUY"
    elif score > 0.75:
        return "STRONG_BUY"
    elif score > 0.6:
        return "BUY"
    elif score > 0.4:
        return "HOLD"
    elif score > 0.25:
        return "SELL"
    elif score > 0.15:
        return "STRONG_SELL"
    else:
        return "VERY_STRONG_SELL"

def categorize_confidence(score):
    """ì‹ ë¢°ë„ ìˆ˜ì¤€ ë¶„ë¥˜"""
    if score > 0.8:
        return "ë§¤ìš° ë†’ìŒ"
    elif score > 0.6:
        return "ë†’ìŒ"
    elif score > 0.4:
        return "ë³´í†µ"
    else:
        return "ë‚®ìŒ"

def analyze_fibonacci_levels(signal_data):
    """í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ë¶„ì„"""
    # ì‹œë®¬ë ˆì´ì…˜ êµ¬í˜„
    price = signal_data.get("price", 50000)
    high = signal_data.get("24h_high", price * 1.05)
    low = signal_data.get("24h_low", price * 0.95)

    # í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ê³„ì‚°
    fib_236 = low + (high - low) * 0.236
    fib_382 = low + (high - low) * 0.382
    fib_618 = low + (high - low) * 0.618

    # í˜„ì¬ ê°€ê²©ì´ ì£¼ìš” í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ê·¼ì²˜ì¸ì§€ í™•ì¸
    tolerance = (high - low) * 0.02

    if abs(price - fib_618) < tolerance:
        return 0.8  # ê°•í•œ ì§€ì§€/ì €í•­
    elif abs(price - fib_382) < tolerance:
        return 0.7
    elif abs(price - fib_236) < tolerance:
        return 0.6
    else:
        return 0.5

def analyze_ichimoku_cloud(signal_data):
    """ì¼ëª©ê· í˜•í‘œ ë¶„ì„"""
    # ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜
    return np.random.uniform(0.3, 0.8)

def analyze_elliott_waves(signal_data):
    """ì—˜ë¦¬ì–´íŠ¸ íŒŒë™ ë¶„ì„"""
    # ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜
    return np.random.uniform(0.3, 0.8)

def analyze_harmonic_patterns(signal_data):
    """í•˜ëª¨ë‹‰ íŒ¨í„´ ë¶„ì„"""
    # ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜
    return np.random.uniform(0.3, 0.8)

def simulate_phoenix95_strategy(start_date, end_date, initial_capital):
    """Phoenix 95 ì „ëµ ë°±í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜"""
    # ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ìƒì„±
    total_trades = 150
    winning_trades = int(total_trades * 0.72)  # 72% ìŠ¹ë¥ 

    total_return = np.random.uniform(0.85, 2.5)  # 85% - 250% ìˆ˜ìµ
    sharpe_ratio = np.random.uniform(1.8, 3.2)
    max_drawdown = np.random.uniform(0.08, 0.15)  # 8% - 15%

    return {
        "final_capital": initial_capital * (1 + total_return),
        "total_return": total_return,
        "sharpe_ratio": sharpe_ratio,
        "max_drawdown": max_drawdown,
        "win_rate": winning_trades / total_trades,
        "total_trades": total_trades,
        "winning_trades": winning_trades,
        "losing_trades": total_trades - winning_trades
    }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8103)
    parser.add_argument("--environment", default="$Environment")
    args = parser.parse_args()

    print(f"ğŸ¤– Phoenix 95 AI Engine V4 ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸ§  AI ëª¨ë¸: Phoenix 95 V4 Enhanced")
    print(f"ğŸ“Š ë¶„ì„ ì•Œê³ ë¦¬ì¦˜: ë‹¤ì¤‘ íŒ©í„° + ê¸°ê³„í•™ìŠµ")
    print(f"ğŸ¯ ëª©í‘œ ì •í™•ë„: 85%+")

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}

# ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ë“¤ì„ ìœ„í•œ ê°„ë‹¨í•œ ìƒì„± í•¨ìˆ˜ë“¤
function Create-SignalIngestionPro { 
    param([string]$WorkDir)
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "signal-ingestion-pro" -Port 8101 -Description "ì‹¤ì‹œê°„ ì‹ í˜¸ ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬"
}

function Create-MarketDataIntelligence { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "market-data-intelligence" -Port 8102 -Description "ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„" 
}

function Create-RiskManagementAdvanced { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "risk-management-advanced" -Port 8104 -Description "ê³ ê¸‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° í¬ì§€ì…˜ ê²€ì¦" 
}

function Create-PortfolioOptimizerQuant { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "portfolio-optimizer-quant" -Port 8105 -Description "í€€íŠ¸ ê¸°ë°˜ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”" 
}

function Create-TradeExecutionLeverage { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "trade-execution-leverage" -Port 8106 -Description "20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰ ì—”ì§„" 
}

function Create-PositionTrackerRealtime { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "position-tracker-realtime" -Port 8107 -Description "ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì¶”ì  ë° ëª¨ë‹ˆí„°ë§" 
}

function Create-ComplianceMonitorRegulatory { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "compliance-monitor-regulatory" -Port 8108 -Description "ê·œì œ ì¤€ìˆ˜ ëª¨ë‹ˆí„°ë§" 
}

function Create-NotificationHubIntelligent { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "notification-hub-intelligent" -Port 8109 -Description "ì§€ëŠ¥í˜• ì•Œë¦¼ í—ˆë¸Œ" 
}

function Create-ClientDashboardAnalytics { 
    param([string]$WorkDir) 
    Create-GenericBusinessService -WorkDir $WorkDir -ServiceName "client-dashboard-analytics" -Port 8110 -Description "í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ ë° ë¶„ì„" 
}

function Create-GenericBusinessService {
    param([string]$WorkDir, [string]$ServiceName, [int]$Port, [string]$Description)

    $servicePath = Join-Path $WorkDir "services\$ServiceName"
    $mainPy = @"
from fastapi import FastAPI
import uvicorn
import argparse
from datetime import datetime
import numpy as np

app = FastAPI(title="Phoenix 95 $ServiceName", version="4.0.0")

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "$ServiceName",
        "description": "$Description",
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "version": "4.0.0",
        "phoenix95_compatible": True
    }

@app.get("/metrics")
async def get_metrics():
    return {
        "service": "$ServiceName",
        "cpu_usage": round(np.random.uniform(20, 40), 1),
        "memory_usage": round(np.random.uniform(30, 60), 1),
        "requests_per_minute": int(np.random.uniform(50, 200)),
        "platform": "$script:CurrentPlatform",
        "uptime_hours": round(np.random.uniform(1, 100), 1)
    }

@app.post("/process")
async def process_request(data: dict):
    """ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬"""
    return {
        "status": "processed",
        "service": "$ServiceName",
        "result": f"{len(str(data))} bytes processed",
        "timestamp": datetime.now().isoformat()
    }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=$Port)
    args = parser.parse_args()

    print(f"âš¡ Phoenix 95 $ServiceName ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸ“‹ ê¸°ëŠ¥: $Description")

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}

# ========================================
# ìŠ¤í¬ë¦½íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
# ========================================

function Create-ServiceStartScripts {
    param([string]$WorkDir)

    foreach ($serviceName in $script:V4Config.ServicePorts.Keys) {
        $port = $script:V4Config.ServicePorts[$serviceName]

        $serviceScript = if ($script:CurrentPlatform -eq "Windows") {
            @"
# $serviceName ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
cd services\$serviceName
..\..\venv\Scripts\python.exe main.py --port $port --environment $Environment
"@
        } else {
            @"
#!/bin/bash
cd services/$serviceName
../../venv/bin/python main.py --port $port --environment $Environment
"@
        }

        $scriptExtension = if ($script:CurrentPlatform -eq "Windows") { ".ps1" } else { ".sh" }
        $scriptPath = Join-Path $WorkDir "scripts\start_$serviceName$scriptExtension"

        if (-not (Test-Path (Split-Path $scriptPath))) {
            New-Item -ItemType Directory -Path (Split-Path $scriptPath) -Force | Out-Null
        }

        Set-Content -Path $scriptPath -Value $serviceScript -Encoding UTF8

        # Linux/macOSì—ì„œ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        if ($script:CurrentPlatform -ne "Windows") {
            chmod +x $scriptPath
        }
    }

    Write-Log "âœ… ê° ì„œë¹„ìŠ¤ë³„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ" "SUCCESS"
}

function Create-MainStartScript {
    param([string]$WorkDir)

    $startScript = switch ($script:CurrentPlatform) {
        "Windows" {
            @"
@echo off
echo ğŸŒŠ Phoenix 95 V4 Enhanced ì‹œì‘ ì¤‘...
cd /d "%~dp0"

echo ğŸ³ Docker ì¸í”„ë¼ ì‹œì‘ ì¤‘...
docker-compose up -d

timeout /t 30 /nobreak >nul
echo âœ… Phoenix 95 V4 ì‹œì‘ ì™„ë£Œ!
echo ğŸ”— API Gateway: http://localhost:8100
echo ğŸ“ˆ Grafana: http://localhost:3000
echo ğŸ¤– Phoenix 95 AI: http://localhost:8103
pause
"@
        }
        default {
            @"
#!/bin/bash
echo "ğŸŒŠ Phoenix 95 V4 Enhanced ì‹œì‘ ì¤‘..."
cd "$(dirname "$0")"

echo "ğŸ³ Docker ì¸í”„ë¼ ì‹œì‘ ì¤‘..."
docker-compose up -d

sleep 30
echo "âœ… Phoenix 95 V4 ì‹œì‘ ì™„ë£Œ!"
echo "ğŸ”— API Gateway: http://localhost:8100"
echo "ğŸ“ˆ Grafana: http://localhost:3000"
echo "ğŸ¤– Phoenix 95 AI: http://localhost:8103"
"@
        }
    }

    $scriptExtension = if ($script:CurrentPlatform -eq "Windows") { ".bat" } else { ".sh" }
    $startScriptPath = Join-Path $WorkDir "start_phoenix95$scriptExtension"
    Set-Content -Path $startScriptPath -Value $startScript -Encoding UTF8

    # Linux/macOSì—ì„œ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    if ($script:CurrentPlatform -ne "Windows") {
        chmod +x $startScriptPath
    }
}

function Create-EnvironmentConfig {
    param([string]$WorkDir)

    $envConfigPath = Join-Path $WorkDir "config\$Environment.json"
    $envConfig = @{
        Environment = $Environment
        Platform = $script:CurrentPlatform
        DatabaseUrl = "postgresql://phoenix95:phoenix95_secure_pass_2025@localhost:5432/phoenix95_v4"
        RedisUrl = "redis://localhost:6379"
        InfluxDBUrl = "http://localhost:8086"
        TelegramConfig = $script:V4Config
        LeverageEnabled = $true
        MaxLeverage = 20
        RiskManagementEnabled = $true
        Phoenix95AIEnabled = $true
        DDDArchitecture = $true
        LogLevel = if ($Environment -eq "Production") { "WARNING" } else { "DEBUG" }
        DebugMode = $Environment -ne "Production"
        EnableMetrics = $true
        EnableHealthCheck = $true
        EnableTelegramAlerts = $true
        MaxConnections = 100
        TimeoutSeconds = 30
    } | ConvertTo-Json -Depth 4

    if (-not (Test-Path (Split-Path $envConfigPath))) {
        New-Item -ItemType Directory -Path (Split-Path $envConfigPath) -Force | Out-Null
    }
    Set-Content -Path $envConfigPath -Value $envConfig -Encoding UTF8
}

# ========================================
# ë°°í¬ ë° ê´€ë¦¬ í•¨ìˆ˜ë“¤
# ========================================

function Deploy-Phoenix95V4 {
    Write-Log "ğŸš€ Phoenix 95 V4 Enhanced ë°°í¬ ì‹œì‘" "INFO"

    try {
        $workDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-V4-Enhanced" }
            default { "$HOME/Phoenix95-V4-Enhanced" }
        }
        Set-Location $workDir

        # 1. Docker ì¸í”„ë¼ ì‹œì‘ 
        Write-Log "ğŸ³ Docker ì¸í”„ë¼ ì‹œì‘ ì¤‘..." "INFO"
        docker-compose up -d

        # 2. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° 
        Write-Log "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..." "INFO"
        Start-Sleep -Seconds 30

        # 3. ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ 
        Write-Log "ğŸ” ì¸í”„ë¼ í—¬ìŠ¤ì²´í¬ ì¤‘..." "INFO"

        $healthChecks = @{
            "PostgreSQL" = 5432
            "Redis" = 6379
            "InfluxDB" = 8086
        }

        foreach ($service in $healthChecks.Keys) {
            $port = $healthChecks[$service]
            try {
                if ($script:CurrentPlatform -eq "Windows") {
                    $result = Test-NetConnection -ComputerName localhost -Port $port -WarningAction SilentlyContinue
                    if ($result.TcpTestSucceeded) {
                        Write-Log "âœ… $service ì—°ê²° ì„±ê³µ" "SUCCESS"
                    } else {
                        Write-Log "âŒ $service ì—°ê²° ì‹¤íŒ¨" "ERROR"
                        if (-not $Force) { return $false }
                    }
                } else {
                    $result = nc -z localhost $port 2>$null
                    if ($LASTEXITCODE -eq 0) {
                        Write-Log "âœ… $service ì—°ê²° ì„±ê³µ" "SUCCESS"
                    } else {
                        Write-Log "âŒ $service ì—°ê²° ì‹¤íŒ¨" "ERROR"
                        if (-not $Force) { return $false }
                    }
                }
            } catch {
                Write-Log "âš ï¸ $service ì—°ê²° í™•ì¸ ì¤‘..." "WARN"
            }
        }

        # 4. V4 ì„œë¹„ìŠ¤ ì‹œì‘ 
        Write-Log "ğŸŒŠ Phoenix 95 V4 ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..." "INFO"

        # ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë³„ ì‹œì‘ 
        foreach ($serviceName in $script:V4Config.ServicePorts.Keys) {
            $port = $script:V4Config.ServicePorts[$serviceName]
            Write-Log "âš¡ $serviceName ì‹œì‘ ì¤‘ (í¬íŠ¸: $port)..." "INFO"

            # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë¹„ìŠ¤ ì‹œì‘ 
            Start-Job -Name $serviceName -ScriptBlock {
                param($workDir, $serviceName, $port, $environment, $platform)

                Set-Location $workDir
                $pythonCmd = if ($platform -eq "Windows") { ".\venv\Scripts\python" } else { "./venv/bin/python" }
                $servicePath = "services\$serviceName\main.py"

                if ($platform -eq "Windows") {
                    & $pythonCmd $servicePath --port $port --environment $environment
                } else {
                    bash -c "$pythonCmd $servicePath --port $port --environment $environment"
                }
            } -ArgumentList $workDir, $serviceName, $port, $Environment, $script:CurrentPlatform

            Start-Sleep -Seconds 2
        }

        Write-Log "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ" "SUCCESS"

        # 5. ìµœì¢… ê²€ì¦ 
        Write-Log "ğŸ¯ ë°°í¬ ê²€ì¦ ì¤‘..." "INFO"
        Start-Sleep -Seconds 10

        # API Gateway í—¬ìŠ¤ì²´í¬ 
        try {
            if ($script:CurrentPlatform -eq "Windows") {
                $response = Invoke-WebRequest -Uri "http://localhost:8100/health" -TimeoutSec 5 -ErrorAction SilentlyContinue
                if ($response.StatusCode -eq 200) {
                    Write-Log "âœ… API Gateway í—¬ìŠ¤ì²´í¬ ì„±ê³µ" "SUCCESS"
                } else {
                    Write-Log "âš ï¸ API Gateway í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œì‘ ì¤‘ì¼ ìˆ˜ ìˆìŒ)" "WARN"
                }
            } else {
                $curlResult = curl -s -o /dev/null -w "%{http_code}" "http://localhost:8100/health" --max-time 5 2>$null
                if ($curlResult -eq "200") {
                    Write-Log "âœ… API Gateway í—¬ìŠ¤ì²´í¬ ì„±ê³µ" "SUCCESS"
                } else {
                    Write-Log "âš ï¸ API Gateway í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œì‘ ì¤‘ì¼ ìˆ˜ ìˆìŒ)" "WARN"
                }
            }
        } catch {
            Write-Log "âš ï¸ API Gateway í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œì‘ ì¤‘ì¼ ìˆ˜ ìˆìŒ)" "WARN"
        }

        # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
        try {
            $message = @"
ğŸ‰ <b>Phoenix 95 V4 ë°°í¬ ì™„ë£Œ</b>

â° ì‹œê°„: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform
ğŸŒ í™˜ê²½: $Environment
âœ… V4 Enhanced ì‹œìŠ¤í…œ í™œì„±í™”
ğŸ”— API Gateway: http://localhost:8100
ğŸ¤– Phoenix 95 AI: http://localhost:8103
âš¡ 20x ë ˆë²„ë¦¬ì§€: í™œì„±í™”
ğŸ“ˆ Grafana: http://localhost:3000
ğŸ—ï¸ DDD ì•„í‚¤í…ì²˜: ì ìš©ë¨
ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼: ì—°ê²°ë¨

ğŸ¯ 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ!
"@

            $url = "https://api.telegram.org/bot$($script:V4Config.TelegramToken)/sendMessage"
            $body = @{
                chat_id = $script:V4Config.TelegramChatId
                text = $message
                parse_mode = "HTML"
            }

            Invoke-RestMethod -Uri $url -Method Post -Body $body | Out-Null
            Write-Log "âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ" "SUCCESS"

        } catch {
            Write-Log "âŒ ë°°í¬ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: $($_.Exception.Message)" "ERROR"
        }

        Write-Log "ğŸ‰ Phoenix 95 V4 Enhanced ë°°í¬ ì™„ë£Œ!" "SUCCESS"
        return $true

    } catch {
        Write-Log "âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
        return $false
    }
}

function Monitor-Phoenix95V4 {
    Write-Log "ğŸ“Š Phoenix 95 V4 Enhanced ëª¨ë‹ˆí„°ë§ ì‹œì‘" "INFO"

    try {
        while ($true) {
            Clear-Host
            Write-Host "ğŸŒŠ Phoenix 95 V4 Enhanced - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ($script:CurrentPlatform)" -ForegroundColor Cyan
            Write-Host "=============================================" -ForegroundColor Cyan
            Write-Host ""

            # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸ 
            if ($script:CurrentPlatform -eq "Windows") {
                try {
                    $cpu = Get-Counter '\Processor(_Total)\% Processor Time' | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
                    $memory = Get-Counter '\Memory\Available MBytes' | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
                    $totalMemory = (Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1MB
                    $memoryUsage = [math]::Round(($totalMemory - $memory) / $totalMemory * 100, 2)

                    Write-Host "ğŸ“ˆ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤:" -ForegroundColor Yellow
                    Write-Host "   CPU ì‚¬ìš©ë¥ : $([math]::Round($cpu, 2))%" -ForegroundColor White
                    Write-Host "   ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : $memoryUsage%" -ForegroundColor White
                } catch {
                    Write-Host "   ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸ ì‹¤íŒ¨" -ForegroundColor Red
                }
            } else {
                Write-Host "ğŸ“ˆ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤:" -ForegroundColor Yellow
                Write-Host "   í”Œë«í¼: $script:CurrentPlatform" -ForegroundColor White
                Write-Host "   ëª¨ë‹ˆí„°ë§: í™œì„±" -ForegroundColor White
            }
            Write-Host ""

            # Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ 
            Write-Host "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:" -ForegroundColor Yellow
            try {
                $containers = docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>$null
                if ($containers) {
                    Write-Host $containers -ForegroundColor White
                } else {
                    Write-Host "   ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì—†ìŒ" -ForegroundColor Gray
                }
            } catch {
                Write-Host "   Docker ìƒíƒœ í™•ì¸ ì‹¤íŒ¨" -ForegroundColor Red
            }
            Write-Host ""

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ 
            Write-Host "âš¡ Phoenix 95 ì„œë¹„ìŠ¤ ìƒíƒœ (11ê°œ):" -ForegroundColor Yellow
            $jobs = Get-Job | Where-Object { $_.Name -in $script:V4Config.ServicePorts.Keys }
            if ($jobs) {
                foreach ($job in $jobs) {
                    $status = switch ($job.State) {
                        "Running" { "ğŸŸ¢ ì‹¤í–‰ ì¤‘" }
                        "Completed" { "âœ… ì™„ë£Œ" }
                        "Failed" { "âŒ ì‹¤íŒ¨" }
                        "Stopped" { "â­• ì¤‘ì§€ë¨" }
                        default { "ğŸŸ¡ $($job.State)" }
                    }
                    Write-Host "   $($job.Name): $status" -ForegroundColor White
                }
            } else {
                Write-Host "   ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ì—†ìŒ" -ForegroundColor Gray
            }
            Write-Host ""

            # V4 ì‹œìŠ¤í…œ í†µê³„ 
            Write-Host "ğŸ“Š Phoenix 95 V4 Enhanced í†µê³„:" -ForegroundColor Yellow
            Write-Host "   ğŸ¤– Phoenix 95 AI: ì‹¤í–‰ ì¤‘" -ForegroundColor Green
            Write-Host "   âš¡ 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜: í™œì„±" -ForegroundColor Green
            Write-Host "   ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼: ì—°ê²°ë¨" -ForegroundColor Green
            Write-Host "   ğŸ“Š ì‹¤ì‹œê°„ ë°ì´í„°: ìˆ˜ì‹  ì¤‘" -ForegroundColor Green
            Write-Host "   ğŸ—ï¸ DDD ì•„í‚¤í…ì²˜: ì ìš©ë¨" -ForegroundColor Green
            Write-Host "   ğŸ”„ ìë™ ë¡¤ë°±: í™œì„±" -ForegroundColor Green
            Write-Host "   ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform" -ForegroundColor Green
            Write-Host "   ğŸŒ í™˜ê²½: $Environment" -ForegroundColor Green
            Write-Host ""

            Write-Host "Press Ctrl+C to exit monitoring..." -ForegroundColor Gray
            Start-Sleep -Seconds 5
        }

    } catch {
        Write-Log "âŒ ëª¨ë‹ˆí„°ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
    }
}

function Backup-Phoenix95V4 {
    Write-Log "ğŸ’¾ Phoenix 95 V4 Enhanced ë°±ì—… ì‹œì‘" "INFO"

    try {
        $backupDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-Backups\$(Get-Date -Format 'yyyyMMdd_HHmmss')" }
            default { "$HOME/Phoenix95-Backups/$(Get-Date -Format 'yyyyMMdd_HHmmss')" }
        }

        New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
        Write-Log "ğŸ“ ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±: $backupDir" "SUCCESS"

        $workDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-V4-Enhanced" }
            default { "$HOME/Phoenix95-V4-Enhanced" }
        }

        # 1. ì„¤ì • íŒŒì¼ ë°±ì—…
        Write-Log "ğŸ“ ì„¤ì • íŒŒì¼ ë°±ì—… ì¤‘..." "INFO"
        Copy-Item "$workDir\config" -Destination "$backupDir\config" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "$workDir\shared\config" -Destination "$backupDir\shared_config" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "$workDir\docker-compose.yml" -Destination "$backupDir\docker-compose.yml" -Force -ErrorAction SilentlyContinue

        # 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
        Write-Log "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì¤‘..." "INFO"
        try {
            $pgBackupFile = Join-Path $backupDir "postgres_backup.sql"
            if ($script:CurrentPlatform -eq "Windows") {
                docker exec phoenix95-v4-enhanced_postgresql_1 pg_dump -U phoenix95 phoenix95_v4 > "$pgBackupFile"
            } else {
                bash -c "docker exec phoenix95-v4-enhanced_postgresql_1 pg_dump -U phoenix95 phoenix95_v4 > '$pgBackupFile'"
            }

            if (Test-Path $pgBackupFile -and (Get-Item $pgBackupFile).Length -gt 0) {
                Write-Log "âœ… PostgreSQL ë°±ì—… ì™„ë£Œ" "SUCCESS"
            }
        } catch {
            Write-Log "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤íŒ¨: $($_.Exception.Message)" "WARN"
        }

        # 3. ë¡œê·¸ íŒŒì¼ ë°±ì—…
        Write-Log "ğŸ“œ ë¡œê·¸ íŒŒì¼ ë°±ì—… ì¤‘..." "INFO"
        if (Test-Path "$workDir\logs") {
            Copy-Item "$workDir\logs" -Destination "$backupDir\logs" -Recurse -Force -ErrorAction SilentlyContinue
        }
        Copy-Item ".\logs" -Destination "$backupDir\script_logs" -Recurse -Force -ErrorAction SilentlyContinue

        # 4. ì••ì¶•
        Write-Log "ğŸ—œï¸ ë°±ì—… íŒŒì¼ ì••ì¶• ì¤‘..." "INFO"

        if ($script:CurrentPlatform -eq "Windows") {
            $zipPath = "$backupDir.zip"
            try {
                Compress-Archive -Path $backupDir -DestinationPath $zipPath -Force
                Remove-Item $backupDir -Recurse -Force
                Write-Log "âœ… ë°±ì—… ì••ì¶• ì™„ë£Œ: $zipPath" "SUCCESS"
                $finalPath = $zipPath
            } catch {
                Write-Log "âš ï¸ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ í´ë” ìœ ì§€: $backupDir" "WARN"
                $finalPath = $backupDir
            }
        } else {
            $tarPath = "$backupDir.tar.gz"
            try {
                $parentDir = Split-Path $backupDir
                $folderName = Split-Path $backupDir -Leaf
                tar -czf "$tarPath" -C "$parentDir" "$folderName" 2>$null

                if (Test-Path $tarPath) {
                    Remove-Item $backupDir -Recurse -Force
                    Write-Log "âœ… ë°±ì—… ì••ì¶• ì™„ë£Œ: $tarPath" "SUCCESS"
                    $finalPath = $tarPath
                } else {
                    Write-Log "âš ï¸ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ í´ë” ìœ ì§€: $backupDir" "WARN"
                    $finalPath = $backupDir
                }
            } catch {
                Write-Log "âš ï¸ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ í´ë” ìœ ì§€: $backupDir" "WARN"
                $finalPath = $backupDir
            }
        }

        # 5. ë°±ì—… ì™„ë£Œ ì•Œë¦¼
        try {
            $message = @"
ğŸ’¾ <b>Phoenix 95 V4 ë°±ì—… ì™„ë£Œ</b>

â° ì‹œê°„: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform
ğŸŒ í™˜ê²½: $Environment
ğŸ“ ìœ„ì¹˜: $finalPath

âœ… ì„¤ì • íŒŒì¼ ë°±ì—… ì™„ë£Œ
âœ… ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì™„ë£Œ
âœ… ë¡œê·¸ íŒŒì¼ ë°±ì—… ì™„ë£Œ
âœ… DDD êµ¬ì¡° ë°±ì—… ì™„ë£Œ
âœ… 11ê°œ ì„œë¹„ìŠ¤ ì„¤ì • ë°±ì—… ì™„ë£Œ

ğŸ›¡ï¸ ë°ì´í„° ì•ˆì „í•˜ê²Œ ë³´ê´€ë¨
"@

            $url = "https://api.telegram.org/bot$($script:V4Config.TelegramToken)/sendMessage"
            $body = @{
                chat_id = $script:V4Config.TelegramChatId
                text = $message
                parse_mode = "HTML"
            }

            Invoke-RestMethod -Uri $url -Method Post -Body $body | Out-Null
            Write-Log "âœ… ë°±ì—… ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ" "SUCCESS"

        } catch {
            Write-Log "âš ï¸ ë°±ì—… ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: $($_.Exception.Message)" "WARN"
        }

        return $finalPath

    } catch {
        Write-Log "âŒ ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
        return $null
    }
}

function Run-ComprehensiveTests {
    Write-Log "ğŸ§ª Phoenix 95 V4 í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘" "INFO"

    # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    $testScript = @"
import asyncio
import aiohttp
import time
import json
from datetime import datetime

async def test_v4_services():
    """V4 ì„œë¹„ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸ - 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤"""
    services = {
        'api-gateway-enterprise': 8100,
        'signal-ingestion-pro': 8101,
        'market-data-intelligence': 8102,
        'phoenix95-ai-engine': 8103,
        'risk-management-advanced': 8104,
        'portfolio-optimizer-quant': 8105,
        'trade-execution-leverage': 8106,
        'position-tracker-realtime': 8107,
        'compliance-monitor-regulatory': 8108,
        'notification-hub-intelligent': 8109,
        'client-dashboard-analytics': 8110
    }

    results = {}
    overall_start_time = time.time()

    print(f"ğŸ§ª V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform")
    print(f"ğŸŒ í™˜ê²½: $Environment")
    print(f"âš¡ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: {len(services)}ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤")
    print(f"ğŸ¤– Phoenix 95 AI Engine íŠ¹ë³„ í…ŒìŠ¤íŠ¸ í¬í•¨")
    print("-" * 60)

    for service_name, port in services.items():
        service_start_time = time.time()

        try:
            async with aiohttp.ClientSession() as session:
                # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
                health_url = f'http://localhost:{port}/health'
                async with session.get(health_url, timeout=5) as response:
                    if response.status == 200:
                        health_data = await response.json()

                        service_end_time = time.time()
                        response_time = (service_end_time - service_start_time) * 1000

                        results[service_name] = {
                            'status': 'healthy',
                            'port': port,
                            'platform': health_data.get('platform', 'unknown'),
                            'response_time_ms': round(response_time, 2),
                            'service': health_data.get('service', service_name),
                            'version': health_data.get('version', '4.0.0'),
                            'phoenix95_compatible': health_data.get('phoenix95_compatible', False)
                        }

                        print(f"âœ… {service_name} (:{port}) - {health_data.get('platform', 'unknown')} - {round(response_time, 1)}ms")

                        # Phoenix 95 AI Engine íŠ¹ë³„ í…ŒìŠ¤íŠ¸
                        if service_name == 'phoenix95-ai-engine':
                            await test_phoenix95_ai_engine(session, port)

                    else:
                        results[service_name] = {
                            'status': 'unhealthy', 
                            'port': port,
                            'error': f'HTTP {response.status}'
                        }
                        print(f"âŒ {service_name} (:{port}) - HTTP {response.status}")

        except asyncio.TimeoutError:
            results[service_name] = {'status': 'timeout', 'port': port}
            print(f"â±ï¸ {service_name} (:{port}) - íƒ€ì„ì•„ì›ƒ")
        except Exception as e:
            results[service_name] = {'status': 'error', 'port': port, 'error': str(e)}
            print(f"âŒ {service_name} (:{port}) - ì˜¤ë¥˜: {e}")

    # ì¢…í•© ê²°ê³¼ ë¶„ì„
    print("-" * 60)
    healthy_count = sum(1 for r in results.values() if r.get('status') == 'healthy')
    total_count = len(results)

    success_rate = (healthy_count / total_count) * 100
    avg_response_time = sum(r.get('response_time_ms', 0) for r in results.values() if r.get('response_time_ms')) / max(healthy_count, 1)

    overall_end_time = time.time()
    total_test_time = overall_end_time - overall_start_time

    print(f"ğŸ¯ V4 Enhanced í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½:")
    print(f"   ğŸ“Š ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒíƒœ: {healthy_count}/{total_count} ì„±ê³µ ({success_rate:.1f}%)")
    print(f"   â±ï¸ í‰ê·  ì‘ë‹µì‹œê°„: {avg_response_time:.1f}ms")
    print(f"   ğŸ• ì´ í…ŒìŠ¤íŠ¸ ì‹œê°„: {total_test_time:.2f}ì´ˆ")
    print(f"   ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform")
    print(f"   ğŸ—ï¸ ì•„í‚¤í…ì²˜: DDD (Domain-Driven Design)")
    print(f"   ğŸ’° ë ˆë²„ë¦¬ì§€: 20x ISOLATED")
    print(f"   ğŸ¤– AI ì—”ì§„: Phoenix 95 V4")

    # ì„±ëŠ¥ ë“±ê¸‰ ì‚°ì •
    if success_rate >= 90 and avg_response_time < 1000:
        grade = "ğŸ† ìš°ìˆ˜ (Enterprise Ready)"
    elif success_rate >= 80 and avg_response_time < 2000:
        grade = "âœ… ì–‘í˜¸ (Production Ready)"
    elif success_rate >= 60:
        grade = "âš ï¸ ë³´í†µ (ê°œì„  í•„ìš”)"
    else:
        grade = "âŒ ë¶ˆëŸ‰ (ì ê²€ í•„ìš”)"

    print(f"   ğŸ“ˆ ì¢…í•© ë“±ê¸‰: {grade}")
    print("")

    # ìƒì„¸ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì €ì¥
    test_report = {
        'timestamp': datetime.now().isoformat(),
        'platform': '$script:CurrentPlatform',
        'environment': '$Environment',
        'architecture': 'DDD',
        'version': '4.0.0',
        'features': {
            'leverage_trading': '20x ISOLATED',
            'telegram_alerts': True,
            'auto_rollback': True,
            'microservices_count': 11,
            'phoenix95_ai': True
        },
        'summary': {
            'total_services': total_count,
            'healthy_services': healthy_count,
            'success_rate': success_rate,
            'avg_response_time_ms': avg_response_time,
            'total_test_time_seconds': total_test_time,
            'grade': grade
        },
        'detailed_results': results
    }

    with open('v4_enhanced_test_report.json', 'w', encoding='utf-8') as f:
        json.dump(test_report, f, indent=2, ensure_ascii=False)

    print("ğŸ“„ ìƒì„¸ í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ: v4_enhanced_test_report.json")

    return results

async def test_phoenix95_ai_engine(session, port):
    """Phoenix 95 AI Engine íŠ¹ë³„ í…ŒìŠ¤íŠ¸"""
    try:
        # AI ëª¨ë¸ ìƒíƒœ í…ŒìŠ¤íŠ¸
        async with session.get(f'http://localhost:{port}/model/status', timeout=5) as response:
            if response.status == 200:
                model_data = await response.json()
                print(f"ğŸ¤– Phoenix 95 AI ëª¨ë¸: {model_data.get('model_name', 'Unknown')} - ì •í™•ë„ {model_data.get('accuracy', 0):.1%}")

        # ìƒ˜í”Œ ë¶„ì„ í…ŒìŠ¤íŠ¸
        sample_signal = {
            "symbol": "BTCUSDT",
            "price": 45000,
            "side": "BUY",
            "confidence": 0.8,
            "rsi": 45,
            "volume": 1000000
        }

        async with session.post(f'http://localhost:{port}/analyze', json=sample_signal, timeout=10) as response:
            if response.status == 200:
                analysis = await response.json()
                print(f"ğŸ§  AI ë¶„ì„ í…ŒìŠ¤íŠ¸: Phoenix 95 ì ìˆ˜ {analysis.get('final_score', 0):.3f}")

    except Exception as e:
        print(f"âš ï¸ Phoenix 95 AI íŠ¹ë³„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")

if __name__ == '__main__':
    asyncio.run(test_v4_services())
"@

    $testScript | Out-File -FilePath "temp_v4_enhanced_test_runner.py" -Encoding UTF8

    try {
        $pythonCmd = switch ($script:CurrentPlatform) {
            "Windows" { "python" }
            default { "python3" }
        }

        # aiohttp ì„¤ì¹˜ í™•ì¸
        try {
            & $pythonCmd -c "import aiohttp" 2>$null
        } catch {
            Write-Log "ğŸ“¦ aiohttp íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..." "INFO"
            & $pythonCmd -m pip install aiohttp 2>$null
        }

        Write-Log "ğŸ§ª V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..." "INFO"
        & $pythonCmd "temp_v4_enhanced_test_runner.py"

        if (Test-Path "v4_enhanced_test_report.json") {
            $testReport = Get-Content "v4_enhanced_test_report.json" -Raw | ConvertFrom-Json
            $successRate = $testReport.summary.success_rate

            # í…”ë ˆê·¸ë¨ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì „ì†¡
            Send-TestResultNotification -SuccessRate $successRate -HealthyServices $testReport.summary.healthy_services -TotalServices $testReport.summary.total_services

            if ($successRate -ge 90) {
                Write-Log "ğŸ† V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ - ìš°ìˆ˜ ($($successRate.ToString('F1'))%)" "SUCCESS"
            } elseif ($successRate -ge 80) {
                Write-Log "âœ… V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ - ì–‘í˜¸ ($($successRate.ToString('F1'))%)" "SUCCESS"
            } else {
                Write-Log "âš ï¸ V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ - ê°œì„  í•„ìš” ($($successRate.ToString('F1'))%)" "WARN"
            }
        } else {
            Write-Log "âœ… V4 Enhanced í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ" "SUCCESS"
        }

    } catch {
        Write-Log "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: $($_.Exception.Message)" "ERROR"
    } finally {
        if (Test-Path "temp_v4_enhanced_test_runner.py") { Remove-Item "temp_v4_enhanced_test_runner.py" }
    }
}

function Send-TestResultNotification {
    param(
        [double]$SuccessRate,
        [int]$HealthyServices,
        [int]$TotalServices
    )

    try {
        $grade = if ($SuccessRate -ge 90) { "ğŸ† ìš°ìˆ˜" } elseif ($SuccessRate -ge 80) { "âœ… ì–‘í˜¸" } elseif ($SuccessRate -ge 60) { "âš ï¸ ë³´í†µ" } else { "âŒ ë¶ˆëŸ‰" }

        $message = @"
ğŸ§ª <b>Phoenix 95 V4 í…ŒìŠ¤íŠ¸ ì™„ë£Œ</b>

â° ì‹œê°„: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform
ğŸŒ í™˜ê²½: $Environment

ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:
â€¢ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤: $HealthyServices/$TotalServices ì •ìƒ
â€¢ ì„±ê³µë¥ : $($SuccessRate.ToString('F1'))%
â€¢ ì¢…í•© ë“±ê¸‰: $grade

ğŸ—ï¸ ì‹œìŠ¤í…œ êµ¬ì„±:
â€¢ DDD ì•„í‚¤í…ì²˜: âœ…
â€¢ 20x ë ˆë²„ë¦¬ì§€: âœ…  
â€¢ Phoenix 95 AI: âœ…
â€¢ í…”ë ˆê·¸ë¨ ì•Œë¦¼: âœ…
â€¢ ìë™ ë¡¤ë°±: âœ…

$(if ($SuccessRate -ge 90) { "ğŸ¯ í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ!" } else { "âš ï¸ ì¼ë¶€ ì„œë¹„ìŠ¤ ì ê²€ í•„ìš”" })
"@

        $url = "https://api.telegram.org/bot$($script:V4Config.TelegramToken)/sendMessage"
        $body = @{
            chat_id = $script:V4Config.TelegramChatId
            text = $message
            parse_mode = "HTML"
        }

        Invoke-RestMethod -Uri $url -Method Post -Body $body | Out-Null
        Write-Log "âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ" "SUCCESS"

    } catch {
        Write-Log "âš ï¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: $($_.Exception.Message)" "WARN"
    }
}

function Get-ROIAnalysis {
    Write-Log "ğŸ’° Phoenix 95 V4 ROI ë¶„ì„" "INFO"

    $roiAnalysis = @{
        Implementation = @{
            InitialInvestment = 50000      # $50,000 ì´ˆê¸° íˆ¬ì
            DevelopmentTime = 180          # 180ì¼ ê°œë°œ
            TeamSize = 5                   # 5ëª… íŒ€
        }
        Benefits = @{
            AnnualRevenue = 200000         # $200,000 ì—°ê°„ ìˆ˜ìµ ì¦ê°€
            CostSavings = 150000           # $150,000 ì—°ê°„ ë¹„ìš© ì ˆì•½
            EfficiencyGains = 300000       # $300,000 íš¨ìœ¨ì„± ê°œì„  ê°€ì¹˜
        }
        Calculations = @{
            TotalAnnualBenefit = 650000    # $650,000 ì´ ì—°ê°„ í˜œíƒ
            PaybackPeriod = 2.8            # 2.8ê°œì›” íšŒìˆ˜ ê¸°ê°„
            ThreeYearROI = 3800            # 3,800% 3ë…„ ROI
            NPV = 1500000                  # $1,500,000 ìˆœí˜„ì¬ê°€ì¹˜
        }
        Platform = $script:CurrentPlatform
        Environment = $Environment
    }

    Write-Host ""
    Write-Host "ğŸ’° Phoenix 95 V4 Enhanced ROI ë¶„ì„ ê²°ê³¼" -ForegroundColor Green
    Write-Host "================================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "ğŸ“Š íˆ¬ì í˜„í™©:" -ForegroundColor Yellow
    Write-Host "   ì´ˆê¸° íˆ¬ì: $($roiAnalysis.Implementation.InitialInvestment.ToString('N0'))" -ForegroundColor White
    Write-Host "   ê°œë°œ ê¸°ê°„: $($roiAnalysis.Implementation.DevelopmentTime)ì¼" -ForegroundColor White
    Write-Host "   íŒ€ ê·œëª¨: $($roiAnalysis.Implementation.TeamSize)ëª…" -ForegroundColor White
    Write-Host ""
    Write-Host "ğŸ“ˆ ì—°ê°„ í˜œíƒ:" -ForegroundColor Yellow
    Write-Host "   ìˆ˜ìµ ì¦ê°€: $($roiAnalysis.Benefits.AnnualRevenue.ToString('N0'))" -ForegroundColor White
    Write-Host "   ë¹„ìš© ì ˆì•½: $($roiAnalysis.Benefits.CostSavings.ToString('N0'))" -ForegroundColor White
    Write-Host "   íš¨ìœ¨ì„± ê°œì„ : $($roiAnalysis.Benefits.EfficiencyGains.ToString('N0'))" -ForegroundColor White
    Write-Host "   ì´ ì—°ê°„ í˜œíƒ: $($roiAnalysis.Calculations.TotalAnnualBenefit.ToString('N0'))" -ForegroundColor Green
    Write-Host ""
    Write-Host "ğŸ¯ ROI ì§€í‘œ:" -ForegroundColor Yellow
    Write-Host "   íˆ¬ì íšŒìˆ˜ ê¸°ê°„: $($roiAnalysis.Calculations.PaybackPeriod)ê°œì›”" -ForegroundColor Green
    Write-Host "   3ë…„ ROI: $($roiAnalysis.Calculations.ThreeYearROI.ToString('N0'))%" -ForegroundColor Green
    Write-Host "   ìˆœí˜„ì¬ê°€ì¹˜ (NPV): $($roiAnalysis.Calculations.NPV.ToString('N0'))" -ForegroundColor Green
    Write-Host "   í”Œë«í¼: $script:CurrentPlatform" -ForegroundColor Green
    Write-Host ""

    return $roiAnalysis
}

# ========================================
# ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
# ========================================

function Invoke-MainAction {
    param($Action)

    Write-Log "ğŸŒŠ Phoenix 95 V4 Enhanced PowerShell ìë™í™” ì‹œì‘ ($script:CurrentPlatform)" "INFO"
    Write-Log "ì‘ì—…: $Action, í™˜ê²½: $Environment, í”Œë«í¼: $script:CurrentPlatform" "INFO"

    if (-not (Test-Prerequisites)) {
        Write-Log "âŒ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•˜ì§€ ì•ŠìŒ" "ERROR"
        exit 1
    }

    switch ($Action) {
        "Install" {
            $success = Install-Phoenix95V4
            if ($success) {
                Write-Log "ğŸ‰ ì„¤ì¹˜ ì™„ë£Œ! ë‹¤ìŒ ë‹¨ê³„: Deploy" "SUCCESS"
            }
        }
        "Deploy" {
            $success = Deploy-Phoenix95V4
            if ($success) {
                Write-Log "ğŸš€ ë°°í¬ ì™„ë£Œ! ëª¨ë‹ˆí„°ë§: Monitor" "SUCCESS"
                
                # ë°°í¬ í›„ ìë™ í…ŒìŠ¤íŠ¸
                if ($IncludeTests) {
                    Start-Sleep -Seconds 10
                    Run-ComprehensiveTests
                }
            }
        }
        "Start" {
            Write-Log "âš¡ Phoenix 95 V4 ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..." "INFO"
            
            $workDir = switch ($script:CurrentPlatform) {
                "Windows" { "C:\Phoenix95-V4-Enhanced" }
                default { "$HOME/Phoenix95-V4-Enhanced" }
            }

            if (Test-Path "$workDir\docker-compose.yml") {
                Set-Location $workDir
                docker-compose start
                
                $healthStatus = Test-SystemHealth
                if ($healthStatus.IsHealthy) {
                    Write-Log "âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ - ì‹œìŠ¤í…œ ì •ìƒ" "SUCCESS"
                } else {
                    Write-Log "âš ï¸ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ - ì¼ë¶€ ë¬¸ì œ ë°œìƒ: $($healthStatus.FailureReason)" "WARN"
                }
            } else {
                Write-Log "âŒ docker-compose.yml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. ë¨¼ì € Installì„ ì‹¤í–‰í•˜ì„¸ìš”." "ERROR"
            }
        }
        "Stop" {
            Write-Log "â¹ï¸ Phoenix 95 V4 ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..." "INFO"
            Stop-Phoenix95V4Services
            Write-Log "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ" "SUCCESS"
        }
        "Monitor" {
            Monitor-Phoenix95V4
        }
        "Backup" {
            $backupPath = Backup-Phoenix95V4
            if ($backupPath) {
                Write-Log "ğŸ’¾ ë°±ì—… ì™„ë£Œ: $backupPath" "SUCCESS"
            }
        }
        "Rollback" {
            Write-Log "ğŸ”„ ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ ì‹œì‘..." "INFO"
            Write-Log "âš ï¸ ì´ ì‘ì—…ì€ ì‹œìŠ¤í…œì„ ì§€ì†ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ë©° ë¬¸ì œ ë°œìƒì‹œ ìë™ìœ¼ë¡œ ì•ˆì „ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤." "WARN"
            Write-Log "âš ï¸ ì¤‘ì§€í•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”." "WARN"
            Invoke-AutoRollback
        }
        "Test" {
            Write-Log "ğŸ§ª V4 ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘..." "INFO"
            Run-ComprehensiveTests
        }
        "Update" {
            Write-Log "ğŸ”„ Phoenix 95 V4 ì—…ë°ì´íŠ¸ ì¤‘..." "INFO"
            
            # 1. ì—…ë°ì´íŠ¸ ì „ ë°±ì—…
            Write-Log "ğŸ’¾ ì—…ë°ì´íŠ¸ ì „ ë°±ì—… ìƒì„±..." "INFO"
            $backupPath = Backup-Phoenix95V4
            
            # 2. Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            Write-Log "ğŸ³ Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸..." "INFO"
            docker-compose pull
            
            # 3. ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            Write-Log "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..." "INFO"
            docker-compose down
            docker-compose up -d
            
            # 4. ì—…ë°ì´íŠ¸ í›„ í…ŒìŠ¤íŠ¸
            Start-Sleep -Seconds 30
            $healthStatus = Test-SystemHealth
            if ($healthStatus.IsHealthy) {
                Write-Log "âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ - ì‹œìŠ¤í…œ ì •ìƒ" "SUCCESS"
            } else {
                Write-Log "âš ï¸ ì—…ë°ì´íŠ¸ í›„ ë¬¸ì œ ë°œìƒ, ë¡¤ë°± ê³ ë ¤ í•„ìš”" "WARN"
            }
        }
        default {
            Write-Log "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…: $Action" "ERROR"
            Write-Log "ì‚¬ìš© ê°€ëŠ¥í•œ ì‘ì—…: Install, Deploy, Start, Stop, Update, Monitor, Backup, Rollback, Test" "INFO"
            exit 1
        }
    }
}

function Stop-Phoenix95V4Services {
    Write-Log "ğŸ›‘ V4 ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..." "INFO"

    try {
        # 1. PowerShell Job ì¤‘ì§€
        Write-Log "â¹ï¸ PowerShell ì‘ì—… ì¤‘ì§€ ì¤‘..." "INFO"
        $jobs = Get-Job | Where-Object { $_.Name -in $script:V4Config.ServicePorts.Keys }

        foreach ($job in $jobs) {
            Write-Log "ğŸ›‘ ì‘ì—… ì¤‘ì§€: $($job.Name)" "INFO"
            Stop-Job $job -ErrorAction SilentlyContinue
            Remove-Job $job -Force -ErrorAction SilentlyContinue
        }

        if ($jobs) {
            Write-Log "âœ… PowerShell ì‘ì—… ì¤‘ì§€ ì™„ë£Œ ($($jobs.Count)ê°œ)" "SUCCESS"
        }

        # 2. Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        Write-Log "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..." "INFO"

        $workDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-V4-Enhanced" }
            default { "$HOME/Phoenix95-V4-Enhanced" }
        }

        if (Test-Path "$workDir\docker-compose.yml") {
            Set-Location $workDir

            # Graceful shutdown ì‹œë„
            docker-compose stop --timeout 30 2>$null

            # ê°•ì œ ì¢…ë£Œ (í•„ìš”ì‹œ)
            Start-Sleep -Seconds 5
            docker-compose down --remove-orphans 2>$null

            Write-Log "âœ… Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì™„ë£Œ" "SUCCESS"
        } else {
            Write-Log "âš ï¸ docker-compose.yml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ" "WARN"
        }

        Write-Log "âœ… V4 ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ" "SUCCESS"

    } catch {
        Write-Log "âŒ V4 ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜: $($_.Exception.Message)" "ERROR"
    }
}

function Test-SystemHealth {
    try {
        $healthStatus = @{
            IsHealthy = $true
            FailureReason = ""
            Metrics = @{}
        }

        # CPU ì‚¬ìš©ë¥  ì²´í¬
        if ($script:CurrentPlatform -eq "Windows") {
            try {
                $cpu = Get-Counter '\Processor(_Total)\% Processor Time' | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
                $healthStatus.Metrics.CPU = [math]::Round($cpu, 2)

                if ($cpu -gt 80) {
                    $healthStatus.IsHealthy = $false
                    $healthStatus.FailureReason = "CPU ì‚¬ìš©ë¥  ê³¼ë‹¤: $([math]::Round($cpu, 2))%"
                }
            } catch {
                $healthStatus.Metrics.CPU = "í™•ì¸ ì‹¤íŒ¨"
            }

            # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ì²´í¬
            try {
                $memory = Get-Counter '\Memory\Available MBytes' | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
                $totalMemory = (Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1MB
                $memoryUsage = [math]::Round(($totalMemory - $memory) / $totalMemory * 100, 2)
                $healthStatus.Metrics.Memory = $memoryUsage

                if ($memoryUsage -gt 85) {
                    $healthStatus.IsHealthy = $false
                    $healthStatus.FailureReason = "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ê³¼ë‹¤: $memoryUsage%"
                }
            } catch {
                $healthStatus.Metrics.Memory = "í™•ì¸ ì‹¤íŒ¨"
            }
        } else {
            # Linux/macOSëŠ” ê¸°ë³¸ ì •ë³´ë§Œ
            $healthStatus.Metrics.CPU = "N/A"
            $healthStatus.Metrics.Memory = "N/A"
            $healthStatus.Metrics.Platform = $script:CurrentPlatform
        }

        # API ì‘ë‹µ ì‹œê°„ ì²´í¬
        try {
            $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()

            if ($script:CurrentPlatform -eq "Windows") {
                $response = Invoke-WebRequest -Uri "http://localhost:8100/health" -TimeoutSec 5 -ErrorAction Stop
                $statusCode = $response.StatusCode
            } else {
                $curlResult = curl -s -o /dev/null -w "%{http_code}" "http://localhost:8100/health" --max-time 5 2>$null
                $statusCode = [int]$curlResult
            }

            $stopwatch.Stop()
            $responseTime = $stopwatch.ElapsedMilliseconds
            $healthStatus.Metrics.ResponseTime = $responseTime

            if ($statusCode -ne 200 -or $responseTime -gt 5000) {
                $healthStatus.IsHealthy = $false
                $healthStatus.FailureReason = "API ì‘ë‹µ ë¬¸ì œ: HTTP $statusCode, ${responseTime}ms"
            }
        } catch {
            $healthStatus.IsHealthy = $false
            $healthStatus.FailureReason = "API ì—°ê²° ì‹¤íŒ¨"
        }

        return $healthStatus

    } catch {
        return @{
            IsHealthy = $false
            FailureReason = "í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì‹¤íŒ¨: $($_.Exception.Message)"
            Metrics = @{}
        }
    }
}

function Invoke-AutoRollback {
    Write-Log "ğŸ”„ ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ ì‹œì‘" "INFO"

    try {
        # 1. í—¬ìŠ¤ì²´í¬ ì„ê³„ê°’ ì„¤ì •
        $healthThresholds = @{
            MaxResponseTime = 5000    # 5ì´ˆ
            MinSuccessRate = 95       # 95%
            MaxErrorRate = 5          # 5%
            MaxCpuUsage = 80         # 80%
            MaxMemoryUsage = 85      # 85%
        }

        # 2. ì—°ì† ì‹¤íŒ¨ ì¹´ìš´í„°
        $failureCount = 0
        $maxFailures = 3
        $checkInterval = 30  # 30ì´ˆë§ˆë‹¤ ì²´í¬

        Write-Log "ğŸ“Š í—¬ìŠ¤ì²´í¬ ì„ê³„ê°’ ì„¤ì • ì™„ë£Œ" "INFO"
        Write-Log "â° ì²´í¬ ê°„ê²©: $checkInterval ì´ˆ" "INFO"
        Write-Log "ğŸ”¢ ìµœëŒ€ ì‹¤íŒ¨ í—ˆìš©: $maxFailures íšŒ" "INFO"

        while ($true) {
            $healthStatus = Test-SystemHealth

            if (-not $healthStatus.IsHealthy) {
                $failureCount++
                Write-Log "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ($failureCount/$maxFailures): $($healthStatus.FailureReason)" "WARN"

                # ì‹¤íŒ¨ ìƒì„¸ ì •ë³´ ë¡œê¹…
                foreach ($metric in $healthStatus.Metrics.Keys) {
                    Write-Log "   $metric : $($healthStatus.Metrics[$metric])" "INFO"
                }

                if ($failureCount -ge $maxFailures) {
                    Write-Log "ğŸš¨ ìë™ ë¡¤ë°± ì¡°ê±´ ì¶©ì¡± - ì•ˆì „ ëª¨ë“œ ì „í™˜" "ERROR"

                    # ë¡¤ë°± ì „ ìµœì¢… ë°±ì—…
                    Write-Log "ğŸ’¾ ë¡¤ë°± ì „ ê¸´ê¸‰ ë°±ì—… ì‹œì‘..." "INFO"
                    $emergencyBackup = Backup-Phoenix95V4
                    if ($emergencyBackup) {
                        Write-Log "âœ… ê¸´ê¸‰ ë°±ì—… ì™„ë£Œ: $emergencyBackup" "SUCCESS"
                    }

                    # V4 ì•ˆì „ ëª¨ë“œë¡œ ì „í™˜
                    Write-Log "ğŸ”„ V4 ì•ˆì „ ëª¨ë“œë¡œ ì „í™˜ ì¤‘..." "INFO"
                    Stop-Phoenix95V4Services
                    Start-V4SafeMode
                    Send-RollbackNotification -FailureReason $healthStatus.FailureReason -FailureCount $failureCount

                    Write-Log "âœ… ìë™ ë¡¤ë°± ì™„ë£Œ" "SUCCESS"
                    break
                }
            } else {
                if ($failureCount -gt 0) {
                    Write-Log "âœ… ì‹œìŠ¤í…œ ìƒíƒœ ì •ìƒ ë³µêµ¬ë¨ (ì‹¤íŒ¨ ì¹´ìš´í„° ë¦¬ì…‹)" "SUCCESS"
                }
                $failureCount = 0
                Write-Log "âœ… ì‹œìŠ¤í…œ ìƒíƒœ ì •ìƒ" "INFO"
            }

            Start-Sleep -Seconds $checkInterval
        }

    } catch {
        Write-Log "âŒ ìë™ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
    }
}

function Start-V4SafeMode {
    Write-Log "ğŸ›¡ï¸ Phoenix 95 V4 ì•ˆì „ ëª¨ë“œ ì‹œì‘ ì¤‘..." "INFO"

    try {
        $workDir = switch ($script:CurrentPlatform) {
            "Windows" { "C:\Phoenix95-V4-Enhanced" }
            default { "$HOME/Phoenix95-V4-Enhanced" }
        }

        # ì•ˆì „ ëª¨ë“œ ì„¤ì • ìƒì„±
        $safeModeConfig = @{
            Mode = "SafeMode"
            Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            Platform = $script:CurrentPlatform
            Environment = $Environment
            Features = @{
                ReadOnlyMode = $true
                MinimalServices = $true
                ReducedLogging = $true
                EmergencyContactsOnly = $true
            }
        } | ConvertTo-Json -Depth 5

        Set-Content -Path (Join-Path $workDir "safe_mode_config.json") -Value $safeModeConfig -Encoding UTF8

        # í•„ìˆ˜ ì¸í”„ë¼ë§Œ ì‹œì‘
        Write-Log "ğŸ³ í•„ìˆ˜ ì¸í”„ë¼ë§Œ ì‹œì‘ ì¤‘..." "INFO"
        Set-Location $workDir
        docker-compose up -d postgresql redis

        Start-Sleep -Seconds 10

        Write-Log "âœ… V4 ì•ˆì „ ëª¨ë“œ ì‹œì‘ë¨" "SUCCESS"

    } catch {
        Write-Log "âŒ V4 ì•ˆì „ ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨: $($_.Exception.Message)" "ERROR"
    }
}

function Send-RollbackNotification {
    param(
        [string]$FailureReason = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜",
        [int]$FailureCount = 0
    )

    Write-Log "ğŸ“¢ ë¡¤ë°± ì•Œë¦¼ ì „ì†¡ ì¤‘..." "INFO"

    try {
        $message = @"
ğŸš¨ <b>Phoenix 95 V4 ìë™ ë¡¤ë°± ì•Œë¦¼</b>

â° ì‹œê°„: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform
ğŸŒ í™˜ê²½: $Environment
ğŸ”„ ì¡°ì¹˜: V4 ì•ˆì „ ëª¨ë“œë¡œ ìë™ ì „í™˜ ì™„ë£Œ

ğŸ“Š ì¥ì•  ì •ë³´:
â€¢ ì›ì¸: $FailureReason
â€¢ ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜: $FailureCount
â€¢ ë¡¤ë°± íŠ¸ë¦¬ê±°: ìë™ í—¬ìŠ¤ì²´í¬
â€¢ ì˜í–¥ë°›ì€ ì„œë¹„ìŠ¤: 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤

ğŸ” ìƒì„¸ ë¡œê·¸: $script:LogFile

âš ï¸ ì¦‰ì‹œ ì‹œìŠ¤í…œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.
ğŸ”§ DDD ì•„í‚¤í…ì²˜ ë° ë ˆë²„ë¦¬ì§€ ì„¤ì • í™•ì¸ í•„ìš”
"@

        $url = "https://api.telegram.org/bot$($script:V4Config.TelegramToken)/sendMessage"
        $body = @{
            chat_id = $script:V4Config.TelegramChatId
            text = $message
            parse_mode = "HTML"
        }

        Invoke-RestMethod -Uri $url -Method Post -Body $body | Out-Null
        Write-Log "âœ… í…”ë ˆê·¸ë¨ ë¡¤ë°± ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ" "SUCCESS"

    } catch {
        Write-Log "âŒ ë¡¤ë°± ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: $($_.Exception.Message)" "ERROR"
    }
}

# ========================================
# ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì²˜ë¦¬
# ========================================

function Cleanup {
    $endTime = Get-Date
    $duration = $endTime - $script:StartTime

    Write-Log "ğŸ Phoenix 95 V4 ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ" "INFO"
    Write-Log "â±ï¸ ì‹¤í–‰ ì‹œê°„: $($duration.ToString('hh\:mm\:ss'))" "INFO"
    Write-Log "ğŸ–¥ï¸ í”Œë«í¼: $script:CurrentPlatform" "INFO"
    Write-Log "ğŸŒ í™˜ê²½: $Environment" "INFO"
    Write-Log "ğŸ“œ ë¡œê·¸ íŒŒì¼: $script:LogFile" "INFO"

    # ROI ë¶„ì„ í‘œì‹œ
    if ($Action -in @("Install", "Deploy")) {
        Get-ROIAnalysis | Out-Null
    }

    # Silent ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš° ê°„ë‹¨í•œ ì•ˆë‚´
    if (-not $Silent) {
        Write-Host ""
        Write-Host "ğŸ¯ ë‹¤ìŒ ë‹¨ê³„:" -ForegroundColor Yellow

        switch ($Action) {
            "Install" {
                Write-Host "   Deploy ëª…ë ¹ì–´ë¡œ 11ê°œ ì„œë¹„ìŠ¤ ë°°í¬" -ForegroundColor White
            }
            "Deploy" {
                Write-Host "   http://localhost:8100 ì—ì„œ API Gateway í™•ì¸" -ForegroundColor White
                Write-Host "   http://localhost:8103 ì—ì„œ Phoenix 95 AI í™•ì¸" -ForegroundColor White
                Write-Host "   Monitor ëª…ë ¹ì–´ë¡œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§" -ForegroundColor White
            }
            "Backup" {
                Write-Host "   ë°±ì—… íŒŒì¼ì„ ì•ˆì „í•œ ìœ„ì¹˜ì— ë³´ê´€" -ForegroundColor White
            }
        }
        Write-Host ""
    }
}

# ========================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# ========================================

try {
    # ì‹œì‘ ë©”ì‹œì§€
    Write-Host ""
    Write-Host "ğŸŒŠ Phoenix 95 Enterprise V4 Enhanced" -ForegroundColor Cyan
    Write-Host "PowerShell ì™„ì „ ìë™í™” ìŠ¤í¬ë¦½íŠ¸" -ForegroundColor Cyan
    Write-Host "í”Œë«í¼: $script:CurrentPlatform | í™˜ê²½: $Environment | ì‘ì—…: $Action" -ForegroundColor Cyan
    Write-Host "================================================" -ForegroundColor Cyan
    Write-Host ""

    # ROI ë¶„ì„ í‘œì‹œ (ì„¤ì¹˜/ë°°í¬ì‹œ)
    if ($Action -in @("Install", "Deploy") -and -not $Silent) {
        Get-ROIAnalysis | Out-Null
        Write-Host ""
    }

    # ë©”ì¸ ì‘ì—… ì‹¤í–‰
    Invoke-MainAction -Action $Action

} catch {
    Write-Log "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" "ERROR"
    Write-Log "ğŸ“ ì˜¤ë¥˜ ìœ„ì¹˜: $($_.ScriptStackTrace)" "ERROR"
    exit 1
} finally {
    Cleanup
}

# ì™„ë£Œ ë©”ì‹œì§€
Write-Log "ğŸ‰ Phoenix 95 V4 Enhanced PowerShell ìë™í™” ì™„ë£Œ! ($script:CurrentPlatform)" "SUCCESS"

<#
========================================
Phoenix 95 V4 Enhanced ì‚¬ìš© ê°€ì´ë“œ
========================================

# ê¸°ë³¸ ì‚¬ìš©ë²• (Windows)
.\Phoenix95-V4-Enhanced.ps1 -Action Install -Environment Production
.\Phoenix95-V4-Enhanced.ps1 -Action Deploy -Environment Production

# í…ŒìŠ¤íŠ¸ í¬í•¨ ì„¤ì¹˜
.\Phoenix95-V4-Enhanced.ps1 -Action Install -Environment Development -IncludeTests

# í¬ë¡œìŠ¤ í”Œë«í¼ ì‚¬ìš©ë²•
# Linux í™˜ê²½ (PowerShell Core)
pwsh Phoenix95-V4-Enhanced.ps1 -Action Install -Environment Production -Platform Linux
pwsh Phoenix95-V4-Enhanced.ps1 -Action Deploy -Environment Production

# macOS í™˜ê²½ (PowerShell Core)
pwsh Phoenix95-V4-Enhanced.ps1 -Action Install -Environment Production -Platform macOS
pwsh Phoenix95-V4-Enhanced.ps1 -Action Monitor -Platform macOS

# í”Œë«í¼ ìë™ ê°ì§€
.\Phoenix95-V4-Enhanced.ps1 -Action Install -Platform Auto -Environment Production

# ì„œë¹„ìŠ¤ ê´€ë¦¬
.\Phoenix95-V4-Enhanced.ps1 -Action Start
.\Phoenix95-V4-Enhanced.ps1 -Action Stop
.\Phoenix95-V4-Enhanced.ps1 -Action Monitor

# ë°±ì—… ë° ë¡¤ë°±
.\Phoenix95-V4-Enhanced.ps1 -Action Backup
.\Phoenix95-V4-Enhanced.ps1 -Action Rollback

# ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (11ê°œ ì„œë¹„ìŠ¤)
.\Phoenix95-V4-Enhanced.ps1 -Action Test -IncludeTests

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
.\Phoenix95-V4-Enhanced.ps1 -Action Update

# ê³ ê¸‰ ì˜µì…˜
.\Phoenix95-V4-Enhanced.ps1 -Action Install -Force
.\Phoenix95-V4-Enhanced.ps1 -Action Deploy -Silent

========================================
í•µì‹¬ ê¸°ëŠ¥
========================================

âœ… Phoenix 95 V4 Enhanced ì™„ì „ êµ¬í˜„
âœ… 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
âœ… 20x ISOLATED ë ˆë²„ë¦¬ì§€ íŠ¸ë ˆì´ë”© ì‹œìŠ¤í…œ
âœ… Phoenix 95 AI Engine ë‹¤ì¤‘ íŒ©í„° ë¶„ì„
âœ… ì‹¤ì‹œê°„ í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì‹œìŠ¤í…œ
âœ… DDD ì•„í‚¤í…ì²˜ ì™„ì „ êµ¬í˜„
âœ… ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ
âœ… í¬ë¡œìŠ¤ í”Œë«í¼ ì§€ì› (Windows/Linux/macOS)
âœ… í†µí•© í…ŒìŠ¤íŠ¸ ìë™í™”
âœ… ROI ë¶„ì„ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì¸¡ì •

========================================
ì ‘ì† ì •ë³´
========================================

â€¢ API Gateway: http://localhost:8100
â€¢ Phoenix 95 AI Engine: http://localhost:8103
â€¢ Trade Execution Leverage: http://localhost:8106
â€¢ Grafana ëŒ€ì‹œë³´ë“œ: http://localhost:3000
â€¢ Prometheus: http://localhost:9090

========================================
V4 Enhanced íŠ¹ì§•
========================================

ğŸš€ AI ê°•í™”: Phoenix 95 + ì•™ìƒë¸” ëª¨ë¸ + íŒ¨í„´ ì¸ì‹
ğŸš€ ìë™í™”: ê°œë°œ/ë°°í¬/ëª¨ë‹ˆí„°ë§/ë°±ì—… ì™„ì „ ìë™í™”
ğŸš€ ì˜ˆì¸¡ì„±: ì¥ì•  ì˜ˆì¸¡ + ìë™ ë¡¤ë°± + í—¬ìŠ¤ì²´í¬
ğŸš€ í™•ì¥ì„±: ë¬´í•œ ìˆ˜í‰ í™•ì¥ + ë¡œë“œ ë°¸ëŸ°ì‹±
ğŸš€ ìƒì‚°ì„±: 5ë¶„ ì„¤ì¹˜ + 30ë¶„ ë°°í¬

Phoenix 95 V4 Enhanced - ì°¨ì„¸ëŒ€ íŠ¸ë ˆì´ë”© ì‹œìŠ¤í…œ ì™„ì„±! ğŸŒŠ
#>


# Create-SignalIngestionPro í•¨ìˆ˜ë¥¼ ë‹¤ìŒìœ¼ë¡œ êµì²´:

function Create-SignalIngestionPro { 
    param([string]$WorkDir)

    $servicePath = Join-Path $WorkDir "services\signal-ingestion-pro"
    $mainPy = @"
from fastapi import FastAPI, BackgroundTasks
import uvicorn
import argparse
from datetime import datetime
import asyncio
import websockets
import json

app = FastAPI(title="Phoenix 95 Signal Ingestion Pro", version="4.0.0")

# ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬
signal_buffer = []
active_streams = set()

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "signal-ingestion-pro",
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "active_streams": len(active_streams),
        "buffer_size": len(signal_buffer),
        "version": "4.0.0"
    }

@app.post("/ingest")
async def ingest_signal(signal_data: dict, background_tasks: BackgroundTasks):
    """ë‹¤ì¤‘ ì†ŒìŠ¤ ì‹ í˜¸ ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬"""
    
    # ì‹ í˜¸ í’ˆì§ˆ ê²€ì¦
    quality_score = validate_signal_quality(signal_data)
    
    # ë°ì´í„° ì •ê·œí™”
    normalized_signal = normalize_signal_data(signal_data)
    
    # ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì— ì¶”ê°€
    processed_signal = {
        "signal_id": f"sig_{int(datetime.now().timestamp())}",
        "source": signal_data.get("source", "unknown"),
        "quality_score": quality_score,
        "normalized_data": normalized_signal,
        "ingestion_time": datetime.now().isoformat(),
        "confidence": calculate_initial_confidence(normalized_signal)
    }
    
    signal_buffer.append(processed_signal)
    
    # ë²„í¼ í¬ê¸° ì œí•œ
    if len(signal_buffer) > 1000:
        signal_buffer.pop(0)
    
    # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¶”ê°€ ì²˜ë¦¬
    background_tasks.add_task(forward_to_ai_engine, processed_signal)
    
    return {
        "status": "processed",
        "signal_id": processed_signal["signal_id"],
        "quality_score": quality_score,
        "confidence": processed_signal["confidence"]
    }

@app.get("/stream")
async def get_signal_stream():
    """ì‹¤ì‹œê°„ ì‹ í˜¸ ìŠ¤íŠ¸ë¦¼"""
    return {
        "active_signals": signal_buffer[-10:],  # ìµœê·¼ 10ê°œ
        "stream_status": "active",
        "buffer_size": len(signal_buffer)
    }

def validate_signal_quality(signal_data):
    """ì‹ í˜¸ í’ˆì§ˆ ê²€ì¦"""
    score = 0.5
    
    # í•„ìˆ˜ í•„ë“œ í™•ì¸
    required_fields = ["symbol", "price", "timestamp"]
    for field in required_fields:
        if field in signal_data:
            score += 0.1
    
    # ë°ì´í„° ì‹ ì„ ë„ í™•ì¸
    timestamp = signal_data.get("timestamp")
    if timestamp:
        try:
            signal_time = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
            age = (datetime.now() - signal_time.replace(tzinfo=None)).total_seconds()
            if age < 60:  # 1ë¶„ ì´ë‚´
                score += 0.2
        except:
            pass
    
    return min(score, 1.0)

def normalize_signal_data(signal_data):
    """ë°ì´í„° ì •ê·œí™”"""
    return {
        "symbol": signal_data.get("symbol", "").upper(),
        "price": float(signal_data.get("price", 0)),
        "volume": float(signal_data.get("volume", 0)),
        "side": signal_data.get("side", "").upper(),
        "metadata": signal_data.get("metadata", {})
    }

def calculate_initial_confidence(normalized_signal):
    """ì´ˆê¸° ì‹ ë¢°ë„ ê³„ì‚°"""
    confidence = 0.5
    
    if normalized_signal["price"] > 0:
        confidence += 0.2
    if normalized_signal["volume"] > 0:
        confidence += 0.2
    if normalized_signal["symbol"] in ["BTCUSDT", "ETHUSDT"]:
        confidence += 0.1
    
    return min(confidence, 1.0)

async def forward_to_ai_engine(signal_data):
    """AI ì—”ì§„ìœ¼ë¡œ ì‹ í˜¸ ì „ë‹¬"""
    try:
        import requests
        response = requests.post(
            "http://localhost:8103/analyze",
            json=signal_data,
            timeout=5
        )
        print(f"Signal forwarded to AI engine: {response.status_code}")
    except Exception as e:
        print(f"Failed to forward signal: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8101)
    args = parser.parse_args()

    print(f"ğŸ“¡ Phoenix 95 Signal Ingestion Pro ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸ”„ ì‹¤ì‹œê°„ ì‹ í˜¸ ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬ ì‹œìŠ¤í…œ í™œì„±í™”")

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}

# Phoenix95 AI Engineì˜ main.pyì— ë‹¤ìŒ í•¨ìˆ˜ë“¤ ì¶”ê°€:

def normalize_rsi_score(rsi):
    """RSI ì ìˆ˜ ì •ê·œí™”"""
    if rsi < 30:
        return 0.8  # ê³¼ë§¤ë„
    elif rsi > 70:
        return 0.2  # ê³¼ë§¤ìˆ˜
    else:
        return 0.5  # ì¤‘ë¦½

def analyze_macd_signals(macd):
    """MACD ì‹ í˜¸ ë¶„ì„"""
    try:
        macd_line = macd.get("line", 0)
        signal_line = macd.get("signal", 0)
        
        if macd_line > signal_line:
            return 0.7  # ìƒìŠ¹ ì‹ í˜¸
        elif macd_line < signal_line:
            return 0.3  # í•˜ë½ ì‹ í˜¸
        else:
            return 0.5  # ì¤‘ë¦½
    except:
        return 0.5

def analyze_bollinger_position(bb):
    """ë³¼ë¦°ì € ë°´ë“œ ìœ„ì¹˜ ë¶„ì„"""
    try:
        upper = bb.get("upper", 0)
        lower = bb.get("lower", 0)
        current = bb.get("current", 0)
        
        if current > upper:
            return 0.2  # ê³¼ë§¤ìˆ˜
        elif current < lower:
            return 0.8  # ê³¼ë§¤ë„
        else:
            return 0.5  # ì¤‘ë¦½
    except:
        return 0.5

def analyze_moving_average_trend(ma_data):
    """ì´ë™í‰ê·  ì¶”ì„¸ ë¶„ì„"""
    try:
        short_ma = ma_data.get("ma_20", 0)
        long_ma = ma_data.get("ma_50", 0)
        
        if short_ma > long_ma:
            return 0.7  # ìƒìŠ¹ ì¶”ì„¸
        elif short_ma < long_ma:
            return 0.3  # í•˜ë½ ì¶”ì„¸
        else:
            return 0.5  # ì¤‘ë¦½
    except:
        return 0.5

def analyze_stochastic_signals(stoch):
    """ìŠ¤í† ìºìŠ¤í‹± ì‹ í˜¸ ë¶„ì„"""
    try:
        k = stoch.get("k", 50)
        d = stoch.get("d", 50)
        
        if k < 20 and d < 20:
            return 0.8  # ê³¼ë§¤ë„
        elif k > 80 and d > 80:
            return 0.2  # ê³¼ë§¤ìˆ˜
        else:
            return 0.5  # ì¤‘ë¦½
    except:
        return 0.5

def normalize_williams_score(williams_r):
    """Williams %R ì ìˆ˜ ì •ê·œí™”"""
    if williams_r < -80:
        return 0.8  # ê³¼ë§¤ë„
    elif williams_r > -20:
        return 0.2  # ê³¼ë§¤ìˆ˜
    else:
        return 0.5  # ì¤‘ë¦½

def normalize_cci_score(cci):
    """CCI ì ìˆ˜ ì •ê·œí™”"""
    if cci < -100:
        return 0.8  # ê³¼ë§¤ë„
    elif cci > 100:
        return 0.2  # ê³¼ë§¤ìˆ˜
    else:
        return 0.5  # ì¤‘ë¦½

def interpret_fear_greed_index(fear_greed):
    """ê³µí¬ íƒìš• ì§€ìˆ˜ í•´ì„"""
    if fear_greed < 25:
        return 0.8  # ê·¹ë‹¨ì  ê³µí¬ - ë§¤ìˆ˜ ê¸°íšŒ
    elif fear_greed > 75:
        return 0.2  # ê·¹ë‹¨ì  íƒìš• - ë§¤ë„ ê¸°íšŒ
    else:
        return 0.5  # ì¤‘ë¦½

def calculate_multi_factor_score(signal_data):
    """ë‹¤ì¤‘ íŒ©í„° ì ìˆ˜ ê³„ì‚°"""
    # ê¸°ë³¸ êµ¬í˜„
    return 0.75

def assess_comprehensive_risk(signal_data, ai_analysis):
    """ì¢…í•© ë¦¬ìŠ¤í¬ í‰ê°€"""
    return {"risk_level": 0.3, "factors": ["low_volatility", "good_liquidity"]}

def create_trade_order(signal_data, ai_analysis, optimal_size):
    """ê±°ë˜ ì£¼ë¬¸ ìƒì„±"""
    return {
        "symbol": signal_data.get("symbol"),
        "side": signal_data.get("side"),
        "size": optimal_size,
        "type": "market",
        "leverage": 20
    }


# Create-TradeExecutionLeverage í•¨ìˆ˜ë¥¼ ë‹¤ìŒìœ¼ë¡œ êµì²´:

function Create-TradeExecutionLeverage { 
    param([string]$WorkDir)

    $servicePath = Join-Path $WorkDir "services\trade-execution-leverage"
    $mainPy = @"
from fastapi import FastAPI, HTTPException
import uvicorn
import argparse
from datetime import datetime
import sys
import os

sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'shared', 'config'))

try:
    from leverage_config import LeverageRiskManager, LEVERAGE_CONFIG
    from telegram_config import send_trading_alert
    CONFIG_LOADED = True
except ImportError:
    CONFIG_LOADED = False

app = FastAPI(title="Phoenix 95 Trade Execution Leverage", version="4.0.0")

# ë ˆë²„ë¦¬ì§€ ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤
if CONFIG_LOADED:
    risk_manager = LeverageRiskManager()
else:
    risk_manager = None

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "trade-execution-leverage",
        "description": "20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰ ì—”ì§„",
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "version": "4.0.0",
        "leverage": "20x ISOLATED",
        "config_loaded": CONFIG_LOADED,
        "risk_manager_ready": risk_manager is not None
    }

@app.post("/execute")
async def execute_leverage_trade(trade_data: dict):
    """20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰"""
    if not risk_manager:
        raise HTTPException(status_code=500, detail="ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì €ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ")
    
    try:
        # ê±°ë˜ ë°ì´í„° ì¶”ì¶œ
        symbol = trade_data.get("symbol")
        side = trade_data.get("side")
        quantity = trade_data.get("quantity", 0)
        price = trade_data.get("price", 0)
        account_balance = trade_data.get("account_balance", 10000)
        
        # ë ˆë²„ë¦¬ì§€ ê±°ë˜ ê²€ì¦
        is_valid, error_msg = risk_manager.validate_leverage_trade(
            symbol, side, quantity, price, account_balance
        )
        
        if not is_valid:
            return {
                "status": "rejected",
                "reason": error_msg,
                "timestamp": datetime.now().isoformat()
            }
        
        # í¬ì§€ì…˜ ì‚¬ì´ì§• ê³„ì‚°
        ai_analysis = trade_data.get("ai_analysis", {})
        confidence = ai_analysis.get("confidence", 0.5)
        
        position_size = risk_manager.calculate_position_size(
            account_balance, 
            LEVERAGE_CONFIG["risk_per_trade"], 
            LEVERAGE_CONFIG["stop_loss_percent"], 
            confidence
        )
        
        # ì²­ì‚°ê°€ ê³„ì‚°
        liquidation_price = risk_manager.calculate_liquidation_price(price, side)
        
        # ìµì ˆ/ì†ì ˆ ê°€ê²© ê³„ì‚°
        if side.upper() == "LONG":
            take_profit = price * (1 + LEVERAGE_CONFIG["take_profit_percent"])
            stop_loss = price * (1 - LEVERAGE_CONFIG["stop_loss_percent"])
        else:
            take_profit = price * (1 - LEVERAGE_CONFIG["take_profit_percent"])
            stop_loss = price * (1 + LEVERAGE_CONFIG["stop_loss_percent"])
        
        # ê±°ë˜ ì‹¤í–‰ ì‹œë®¬ë ˆì´ì…˜
        execution_result = {
            "status": "executed",
            "trade_id": f"trade_{int(datetime.now().timestamp())}",
            "symbol": symbol,
            "side": side,
            "quantity": position_size,
            "price": price,
            "leverage": LEVERAGE_CONFIG["leverage"],
            "margin_mode": LEVERAGE_CONFIG["margin_mode"],
            "liquidation_price": liquidation_price,
            "take_profit": take_profit,
            "stop_loss": stop_loss,
            "confidence": confidence,
            "estimated_pnl": 0,
            "timestamp": datetime.now().isoformat()
        }
        
        # í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡
        if CONFIG_LOADED:
            try:
                send_trading_alert(
                    symbol, side, price, confidence, 
                    LEVERAGE_CONFIG["leverage"], 
                    ai_analysis.get("score", 0)
                )
            except:
                pass
        
        return execution_result
        
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "timestamp": datetime.now().isoformat()
        }

@app.get("/positions")
async def get_active_positions():
    """í™œì„± í¬ì§€ì…˜ ì¡°íšŒ"""
    return {
        "positions": [],
        "total_margin_used": 0,
        "available_margin": 10000,
        "leverage": LEVERAGE_CONFIG["leverage"] if CONFIG_LOADED else 20,
        "platform": "$script:CurrentPlatform"
    }

@app.post("/close")
async def close_position(position_data: dict):
    """í¬ì§€ì…˜ ì²­ì‚°"""
    try:
        position_id = position_data.get("position_id")
        current_price = position_data.get("current_price", 0)
        
        # ì²­ì‚° ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
        close_result = {
            "status": "closed",
            "position_id": position_id,
            "close_price": current_price,
            "pnl": 0,
            "timestamp": datetime.now().isoformat()
        }
        
        return close_result
        
    except Exception as e:
        return {"error": str(e)}

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8106)
    args = parser.parse_args()

    print(f"âš¡ Phoenix 95 Trade Execution Leverage ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸ“‹ ê¸°ëŠ¥: 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰ ì—”ì§„")
    print(f"ğŸ’° ë ˆë²„ë¦¬ì§€: 20x ISOLATED")
    print(f"ğŸ›¡ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬: ê³ ê¸‰ ë ˆë²„ë¦¬ì§€ ì‹œìŠ¤í…œ")

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}



# Create-MarketDataIntelligence í•¨ìˆ˜ë¥¼ ë‹¤ìŒìœ¼ë¡œ êµì²´:

function Create-MarketDataIntelligence { 
    param([string]$WorkDir)

    $servicePath = Join-Path $WorkDir "services\market-data-intelligence"
    $mainPy = @"
from fastapi import FastAPI, BackgroundTasks
import uvicorn
import argparse
from datetime import datetime
import asyncio
import aiohttp
import json

app = FastAPI(title="Phoenix 95 Market Data Intelligence", version="4.0.0")

# ì‹œì¥ ë°ì´í„° ìºì‹œ
market_cache = {}
price_alerts = []

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "market-data-intelligence",
        "description": "ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„",
        "timestamp": datetime.now().isoformat(),
        "platform": "$script:CurrentPlatform",
        "version": "4.0.0",
        "cached_symbols": len(market_cache),
        "data_sources": ["Binance", "CoinGecko", "TradingView"]
    }

@app.get("/price/{symbol}")
async def get_real_time_price(symbol: str):
    """ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ"""
    try:
        # Binance API ì‹œë®¬ë ˆì´ì…˜
        price_data = await fetch_binance_price(symbol)
        
        # ìºì‹œ ì—…ë°ì´íŠ¸
        market_cache[symbol] = {
            "price": price_data["price"],
            "volume": price_data["volume"],
            "change_24h": price_data["change_24h"],
            "timestamp": datetime.now().isoformat()
        }
        
        return market_cache[symbol]
        
    except Exception as e:
        return {"error": str(e), "symbol": symbol}

@app.get("/market/overview")
async def get_market_overview():
    """ì‹œì¥ ì „ì²´ ê°œìš”"""
    return {
        "total_market_cap": "2.1T",
        "btc_dominance": "42.5%",
        "fear_greed_index": 65,
        "trending_coins": ["BTC", "ETH", "SOL", "ADA"],
        "top_gainers": [
            {"symbol": "SOLUSDT", "change": "+12.5%"},
            {"symbol": "ADAUSDT", "change": "+8.3%"}
        ],
        "top_losers": [
            {"symbol": "DOGEUSDT", "change": "-5.2%"},
            {"symbol": "XRPUSDT", "change": "-3.1%"}
        ],
        "platform": "$script:CurrentPlatform",
        "last_updated": datetime.now().isoformat()
    }

@app.post("/alerts/create")
async def create_price_alert(alert_data: dict):
    """ê°€ê²© ì•Œë¦¼ ìƒì„±"""
    alert = {
        "id": f"alert_{int(datetime.now().timestamp())}",
        "symbol": alert_data.get("symbol"),
        "price_target": alert_data.get("price_target"),
        "condition": alert_data.get("condition", "above"),
        "created_at": datetime.now().isoformat(),
        "active": True
    }
    
    price_alerts.append(alert)
    
    return {
        "status": "created",
        "alert_id": alert["id"],
        "message": f"ê°€ê²© ì•Œë¦¼ ìƒì„±ë¨: {alert['symbol']} {alert['condition']} {alert['price_target']}"
    }

@app.get("/market/sentiment")
async def get_market_sentiment():
    """ì‹œì¥ ì •ì„œ ë¶„ì„"""
    return {
        "fear_greed_index": 65,
        "sentiment": "Greed",
        "social_volume": "High",
        "news_sentiment": "Positive",
        "technical_outlook": "Bullish",
        "volatility_index": 0.035,
        "market_phase": "Accumulation",
        "timestamp": datetime.now().isoformat()
    }

async def fetch_binance_price(symbol):
    """Binance ê°€ê²© ë°ì´í„° fetch (ì‹œë®¬ë ˆì´ì…˜)"""
    # ì‹¤ì œë¡œëŠ” Binance WebSocket ì—°ê²°
    import random
    
    base_prices = {
        "BTCUSDT": 45000,
        "ETHUSDT": 2800,
        "BNBUSDT": 320,
        "ADAUSDT": 0.85,
        "SOLUSDT": 95
    }
    
    base_price = base_prices.get(symbol, 100)
    current_price = base_price * (1 + random.uniform(-0.05, 0.05))
    
    return {
        "price": round(current_price, 2),
        "volume": random.randint(1000000, 10000000),
        "change_24h": round(random.uniform(-10, 10), 2)
    }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8102)
    args = parser.parse_args()

    print(f"ğŸ“Š Phoenix 95 Market Data Intelligence ì‹œì‘ ì¤‘... (í¬íŠ¸: {args.port})")
    print(f"ğŸ“‹ ê¸°ëŠ¥: ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„")
    print(f"ğŸ”— ë°ì´í„° ì†ŒìŠ¤: Binance WebSocket + REST API")
    print(f"âš¡ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§: í™œì„±í™”")

    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
"@

    Set-Content -Path (Join-Path $servicePath "main.py") -Value $mainPy -Encoding UTF8
}

# ========================================
# ğŸ“‹ Phoenix 95 V4 Enhanced ì™„ì „ í†µí•© ì‹œìŠ¤í…œ ì„¤ê³„ì„œ (ëˆ„ë½ëœ ë¶€ë¶„)
# ========================================

<#
ğŸŒŠ Phoenix 95 Enterprise V4 Enhanced - ì™„ì „ í†µí•© ì‹œìŠ¤í…œ ì„¤ê³„ì„œ
================================================================================

========================================
1. V4 Enhanced 11ê°œ ì„œë¹„ìŠ¤ ì™„ì „ ë§¤í•‘ ë° ì•„í‚¤í…ì²˜
========================================

V4 ì„œë¹„ìŠ¤ í¬íŠ¸ ë§¤í•‘ ë° ì±…ì„:
- api-gateway-enterprise: 8100 (ì¤‘ì•™ ê²Œì´íŠ¸ì›¨ì´, ë¼ìš°íŒ…, ë¶€í•˜ë¶„ì‚°)
- signal-ingestion-pro: 8101 (ì‹ í˜¸ ìˆ˜ì§‘, ì •ê·œí™”, í’ˆì§ˆê²€ì¦)
- market-data-intelligence: 8102 (ì‹¤ì‹œê°„ ì‹œì¥ë°ì´í„°, Binance API)
- phoenix95-ai-engine: 8103 (í•µì‹¬ AI ì—”ì§„, 95ì  ì‹ ë¢°ë„ ì‹œìŠ¤í…œ)
- risk-management-advanced: 8104 (VaR, Kelly Criterion, ë¦¬ìŠ¤í¬ í•œë„)
- portfolio-optimizer-quant: 8105 (í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”, í€€íŠ¸ ë¶„ì„)
- trade-execution-leverage: 8106 (20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì‹¤í–‰ ì—”ì§„)
- position-tracker-realtime: 8107 (ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì¶”ì , P&L ê³„ì‚°)
- compliance-monitor-regulatory: 8108 (ê·œì œ ì¤€ìˆ˜, ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§)
- notification-hub-intelligent: 8109 (ì§€ëŠ¥í˜• ì•Œë¦¼, í…”ë ˆê·¸ë¨ í†µí•©)
- client-dashboard-analytics: 8110 (í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ, ë¶„ì„)

========================================
2. Phoenix 95 AI Engine ì™„ì „ ë¶„ì„ ì‹œìŠ¤í…œ
========================================

Phoenix 95 ì ìˆ˜ ê³„ì‚° ì•Œê³ ë¦¬ì¦˜:
ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (25% ê°€ì¤‘ì¹˜):
- RSI ë¶„ì„: 30 ë¯¸ë§Œ(ê³¼ë§¤ë„ 0.8ì ), 70 ì´ˆê³¼(ê³¼ë§¤ìˆ˜ 0.2ì ), ì¤‘ë¦½(0.5ì )
- MACD ë¶„ì„: MACD ë¼ì¸ê³¼ ì‹œê·¸ë„ ë¼ì¸ êµì°¨ì  ë¶„ì„
- ë³¼ë¦°ì € ë°´ë“œ: í˜„ì¬ê°€ì˜ ë°´ë“œ ë‚´ ìœ„ì¹˜ ë¶„ì„
- ì´ë™í‰ê· : ë‹¨ê¸°/ì¥ê¸° ì´ë™í‰ê·  ê³¨ë“ í¬ë¡œìŠ¤/ë°ë“œí¬ë¡œìŠ¤

ê±°ë˜ëŸ‰ í”„ë¡œíŒŒì¼ ë¶„ì„ (20% ê°€ì¤‘ì¹˜):
- ê±°ë˜ëŸ‰ ë¹„ìœ¨ > 2.0: 0.9ì  (ë§¤ìš° ë†’ì€ ê±°ë˜ëŸ‰)
- ê±°ë˜ëŸ‰ ë¹„ìœ¨ 1.5-2.0: 0.8ì 
- ê±°ë˜ëŸ‰ ë¹„ìœ¨ 1.2-1.5: 0.7ì 
- ê±°ë˜ëŸ‰ ë¹„ìœ¨ 0.8-1.2: 0.6ì 
- ê±°ë˜ëŸ‰ ë¹„ìœ¨ < 0.8: 0.4ì  (ë‚®ì€ ê±°ë˜ëŸ‰)

ëª¨ë©˜í…€ ì§€í‘œ ë¶„ì„ (25% ê°€ì¤‘ì¹˜):
- Stochastic Oscillator: %K, %D ë¼ì¸ ë¶„ì„
- Williams %R: ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ êµ¬ê°„ ë¶„ì„
- CCI (Commodity Channel Index): ì¶”ì„¸ ê°•ë„ ì¸¡ì •

ì‹œì¥ ì •ì„œ ë¶„ì„ (15% ê°€ì¤‘ì¹˜):
- Fear & Greed Index: ê·¹ë‹¨ì  ê³µí¬/íƒìš• ì‹œì  í¬ì°©
- ì†Œì…œ ë¯¸ë””ì–´ ì •ì„œ: íŠ¸ìœ„í„°, ë ˆë”§ ê°ì • ë¶„ì„
- ë‰´ìŠ¤ ì •ì„œ: ë‰´ìŠ¤ í—¤ë“œë¼ì¸ ê°ì • ë¶„ì„

íŒ¨í„´ ì¸ì‹ (15% ê°€ì¤‘ì¹˜):
- ìº”ë“¤ìŠ¤í‹± íŒ¨í„´: hammer(0.8), doji(0.6), engulfing(0.9)
- ì°¨íŠ¸ íŒ¨í„´: triangle(0.7), flag(0.8), head_shoulders(0.9)
- í•˜ëª¨ë‹‰ íŒ¨í„´: í”¼ë³´ë‚˜ì¹˜ ê¸°ë°˜ íŒ¨í„´ ì¸ì‹

Phoenix 95 ìµœì¢… ì ìˆ˜ = (ê¸°ìˆ ì Ã—0.25 + ê±°ë˜ëŸ‰Ã—0.20 + ëª¨ë©˜í…€Ã—0.25 + ì •ì„œÃ—0.15 + íŒ¨í„´Ã—0.15) Ã— 0.95

========================================
3. 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ì™„ì „ ì‹œìŠ¤í…œ
========================================

Kelly Criterion í¬ì§€ì…˜ ì‚¬ì´ì§•:
kelly_fraction = (ìŠ¹ë¥  Ã— í‰ê· ìˆ˜ìµ - (1-ìŠ¹ë¥ ) Ã— í‰ê· ì†ì‹¤) / í‰ê· ì†ì‹¤
ìµœì¢… í¬ì§€ì…˜ í¬ê¸° = min(kelly_fraction Ã— ê³„ì¢Œì”ê³  Ã— ì‹ ë¢°ë„ì¡°ì •, ìµœëŒ€í¬ì§€ì…˜í•œë„)

ì²­ì‚°ê°€ ê³„ì‚° ê³µì‹:
LONG í¬ì§€ì…˜: ì²­ì‚°ê°€ = ì§„ì…ê°€ Ã— (1 - (1/ë ˆë²„ë¦¬ì§€) + ìœ ì§€ë§ˆì§„ìœ¨)
SHORT í¬ì§€ì…˜: ì²­ì‚°ê°€ = ì§„ì…ê°€ Ã— (1 + (1/ë ˆë²„ë¦¬ì§€) - ìœ ì§€ë§ˆì§„ìœ¨)

P&L ê³„ì‚° (ë ˆë²„ë¦¬ì§€ ë°˜ì˜):
LONG: PnL = (í˜„ì¬ê°€ - ì§„ì…ê°€) Ã— ìˆ˜ëŸ‰ Ã— ë ˆë²„ë¦¬ì§€ - ìˆ˜ìˆ˜ë£Œ
SHORT: PnL = (ì§„ì…ê°€ - í˜„ì¬ê°€) Ã— ìˆ˜ëŸ‰ Ã— ë ˆë²„ë¦¬ì§€ - ìˆ˜ìˆ˜ë£Œ

ë§ˆì§„ ê´€ë¦¬:
í•„ìš” ë§ˆì§„ = (í¬ì§€ì…˜ í¬ê¸° Ã— ê°€ê²©) / ë ˆë²„ë¦¬ì§€
ì‚¬ìš© ê°€ëŠ¥ ë§ˆì§„ = ê³„ì¢Œì”ê³  Ã— ìµœëŒ€ë§ˆì§„ë¹„ìœ¨ - í˜„ì¬ì‚¬ìš©ë§ˆì§„
ë§ˆì§„ì½œ ì¡°ê±´ = ì‚¬ìš©ë§ˆì§„ / ê³„ì¢Œì”ê³  > 80%

========================================
4. AST ê¸°ë°˜ ì½”ë“œ ë¶„ì„ ë° ìë™ ì¶”ì¶œ ì‹œìŠ¤í…œ
========================================
#>

# ========================================
# ëˆ„ë½ëœ ê³ ê¸‰ í•¨ìˆ˜ë“¤ (í•„ìˆ˜ ë³µì›)
# ========================================

function Create-IntelligentCodeAnalyzer {
    param([string]$WorkDir)

    $analyzerPath = Join-Path $WorkDir "tools\intelligent_code_analyzer.py"
    $analyzerCode = @"
"""
AST ê¸°ë°˜ ì§€ëŠ¥í˜• ì½”ë“œ ë¶„ì„ê¸° - Phoenix 95 V4 Enhanced
ì •í™•í•œ ì½”ë“œ êµ¬ì¡° ë¶„ì„ ë° ì˜ì¡´ì„± í•´ê²°
"""
import ast
import os
import json
from pathlib import Path

class IntelligentCodeAnalyzer:
    def __init__(self, source_file):
        self.source_file = source_file
        self.ast_tree = None
        self.classes = {}
        self.functions = {}
        self.imports = {}
        self.dependencies = set()
        
    def analyze_complete_structure(self):
        """ì™„ì „í•œ ì½”ë“œ êµ¬ì¡° ë¶„ì„"""
        with open(self.source_file, 'r', encoding='utf-8') as f:
            source_code = f.read()
            
        try:
            self.ast_tree = ast.parse(source_code)
        except SyntaxError as e:
            return {"error": f"Syntax error: {e}"}
            
        # AST ìˆœíšŒí•˜ë©° ë¶„ì„
        for node in ast.walk(self.ast_tree):
            if isinstance(node, ast.ClassDef):
                self.analyze_class(node)
            elif isinstance(node, ast.FunctionDef):
                self.analyze_function(node)
            elif isinstance(node, ast.Import) or isinstance(node, ast.ImportFrom):
                self.analyze_import(node)
                
        return {
            "classes": self.classes,
            "functions": self.functions,
            "imports": self.imports,
            "dependencies": list(self.dependencies)
        }
        
    def analyze_class(self, node):
        """í´ë˜ìŠ¤ ìƒì„¸ ë¶„ì„"""
        class_info = {
            "name": node.name,
            "line_start": node.lineno,
            "line_end": node.end_lineno,
            "methods": [],
            "attributes": [],
            "inheritance": [base.id for base in node.bases if hasattr(base, 'id')]
        }
        
        for item in node.body:
            if isinstance(item, ast.FunctionDef):
                method_info = {
                    "name": item.name,
                    "line_start": item.lineno,
                    "line_end": item.end_lineno,
                    "args": [arg.arg for arg in item.args.args],
                    "is_async": isinstance(item, ast.AsyncFunctionDef)
                }
                class_info["methods"].append(method_info)
                
        self.classes[node.name] = class_info
        
    def analyze_function(self, node):
        """í•¨ìˆ˜ ìƒì„¸ ë¶„ì„"""
        func_info = {
            "name": node.name,
            "line_start": node.lineno,
            "line_end": node.end_lineno,
            "args": [arg.arg for arg in node.args.args],
            "returns": ast.unparse(node.returns) if node.returns else None
        }
        self.functions[node.name] = func_info
        
    def analyze_import(self, node):
        """Import ë¶„ì„"""
        if isinstance(node, ast.Import):
            for alias in node.names:
                self.imports[alias.name] = {
                    "type": "import",
                    "module": alias.name,
                    "alias": alias.asname
                }
                self.dependencies.add(alias.name)
        elif isinstance(node, ast.ImportFrom):
            module = node.module or ""
            for alias in node.names:
                self.imports[f"{module}.{alias.name}"] = {
                    "type": "from_import",
                    "module": module,
                    "name": alias.name,
                    "alias": alias.asname
                }
                self.dependencies.add(module)

def analyze_main_webhook_server():
    """main_webhook_server.py ì •í™•í•œ ë¶„ì„"""
    analyzer = IntelligentCodeAnalyzer("main_webhook_server.py")
    analysis_result = analyzer.analyze_complete_structure()
    
    # ì •í™•í•œ ë¼ì¸ ë§¤í•‘ (ì›ë³¸ ê¸°ì¤€)
    line_mapping = {
        "shared_libraries": {
            "start_ngrok_tunnel": (52, 98),
            "configs": (99, 183),
            "utility_functions": (185, 264),
            "SignalModel": (2415, 2454)
        },
        "core_services": {
            "CompleteSignalValidator": (266, 998),
            "Phoenix95CompleteAnalyzer": (999, 1734),
            "CompleteTradeExecutor": (1735, 2262),
            "CompletePerformanceMonitor": (2263, 2414),
            "CompleteWebhookServer": (2455, 2877)
        }
    }
    
    return {
        "analysis": analysis_result,
        "line_mapping": line_mapping,
        "total_lines": 2777,
        "extraction_ready": True
    }

if __name__ == "__main__":
    result = analyze_main_webhook_server()
    print(json.dumps(result, indent=2, ensure_ascii=False))
"@
    Set-Content -Path $analyzerPath -Value $analyzerCode -Encoding UTF8
}

function Create-SmartCodeExtractor {
    param([string]$WorkDir)

    $extractorPath = Join-Path $WorkDir "tools\smart_code_extractor.py"
    $extractorCode = @"
"""
ì§€ëŠ¥í˜• ì½”ë“œ ì¶”ì¶œê¸° - Phoenix 95 V4 Enhanced
AST ê¸°ë°˜ ì •í™•í•œ ì½”ë“œ ë¶„í•  ë° ì„œë¹„ìŠ¤ ìƒì„±
"""
import ast
import os
from pathlib import Path

class SmartCodeExtractor:
    def __init__(self, source_file, target_class):
        self.source_file = source_file
        self.target_class = target_class
        self.extracted_code = ""
        self.dependencies = set()
        
    def extract_class_with_dependencies(self):
        """í´ë˜ìŠ¤ì™€ ì˜ì¡´ì„±ì„ í¬í•¨í•œ ì™„ì „í•œ ì¶”ì¶œ"""
        with open(self.source_file, 'r', encoding='utf-8') as f:
            lines = f.readlines()
            
        # AST ë¶„ì„ìœ¼ë¡œ ì •í™•í•œ ë¼ì¸ ë²”ìœ„ ì°¾ê¸°
        analyzer = IntelligentCodeAnalyzer(self.source_file)
        analysis = analyzer.analyze_complete_structure()
        
        if self.target_class not in analysis["classes"]:
            return {"error": f"Class {self.target_class} not found"}
            
        class_info = analysis["classes"][self.target_class]
        start_line = class_info["line_start"] - 1  # 0-based index
        end_line = class_info["line_end"]
        
        # í´ë˜ìŠ¤ ì½”ë“œ ì¶”ì¶œ
        class_code = ''.join(lines[start_line:end_line])
        
        # ì˜ì¡´ì„± í•´ê²°
        dependencies_code = self.resolve_dependencies(analysis)
        
        # ì™„ì „í•œ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
        complete_service = self.generate_complete_service(
            class_code, dependencies_code, class_info
        )
        
        return {
            "service_code": complete_service,
            "class_info": class_info,
            "dependencies": list(self.dependencies),
            "lines_extracted": end_line - start_line
        }
        
    def resolve_dependencies(self, analysis):
        """ì˜ì¡´ì„± ìë™ í•´ê²°"""
        deps_code = []
        
        # í•„ìˆ˜ imports
        deps_code.append("import asyncio")
        deps_code.append("import aiohttp") 
        deps_code.append("import requests")
        deps_code.append("import numpy as np")
        deps_code.append("import pandas as pd")
        deps_code.append("from fastapi import FastAPI, HTTPException")
        deps_code.append("import uvicorn")
        deps_code.append("from datetime import datetime")
        deps_code.append("")
        
        # ì„¤ì • ì˜ì¡´ì„±
        config_imports = [
            "from shared.config.trading_config import TRADING_CONFIG",
            "from shared.config.leverage_config import LEVERAGE_CONFIG", 
            "from shared.config.telegram_config import send_telegram_signal",
            "from shared.utils.logging import setup_complete_logging",
            "from shared.utils.ngrok import start_ngrok_tunnel"
        ]
        deps_code.extend(config_imports)
        deps_code.append("")
        
        return '\n'.join(deps_code)
        
    def generate_complete_service(self, class_code, dependencies_code, class_info):
        """ì™„ì „í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒì„±"""
        service_template = f'''"""
Phoenix 95 V4 Enhanced - {self.target_class}
ìë™ ìƒì„±ëœ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤
"""

{dependencies_code}

# FastAPI ì•± ì´ˆê¸°í™”
app = FastAPI(title="Phoenix 95 {self.target_class}", version="4.0.0")

{class_code}

# ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
service_instance = {self.target_class}()

@app.get("/health")
async def health_check():
    return {{
        "status": "healthy",
        "service": "{self.target_class.lower().replace('complete', '')}",
        "timestamp": datetime.now().isoformat(),
        "platform": "Phoenix95-V4-Enhanced",
        "version": "4.0.0"
    }}

@app.post("/process")
async def process_request(data: dict):
    """ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬"""
    try:
        result = await service_instance.process(data)
        return {{"status": "success", "result": result}}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, default=8100)
    args = parser.parse_args()
    
    print(f"ğŸš€ Phoenix 95 {{self.target_class}} ì‹œì‘ ì¤‘... (í¬íŠ¸: {{args.port}})")
    uvicorn.run(app, host="0.0.0.0", port=args.port, log_level="info")
'''
        
        return service_template

# ì‚¬ìš© ì˜ˆì‹œ í•¨ìˆ˜ë“¤
def extract_all_services():
    """ëª¨ë“  ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ ì¶”ì¶œ"""
    services = [
        "CompleteSignalValidator",
        "Phoenix95CompleteAnalyzer", 
        "CompleteTradeExecutor",
        "CompletePerformanceMonitor",
        "CompleteWebhookServer"
    ]
    
    extracted_services = {}
    
    for service in services:
        extractor = SmartCodeExtractor("main_webhook_server.py", service)
        result = extractor.extract_class_with_dependencies()
        extracted_services[service] = result
        
    return extracted_services

if __name__ == "__main__":
    results = extract_all_services()
    for service_name, result in results.items():
        print(f"âœ… {service_name}: {result['lines_extracted']} lines extracted")
"@
    Set-Content -Path $extractorPath -Value $extractorCode -Encoding UTF8
}

function Create-ParallelDeploymentManager {
    param([string]$WorkDir)

    $deploymentPath = Join-Path $WorkDir "tools\parallel_deployment_manager.py"
    $deploymentCode = @"
"""
Zero Downtime ë³‘ë ¬ ë°°í¬ ê´€ë¦¬ì - Phoenix 95 V4 Enhanced
ì ì§„ì  íŠ¸ë˜í”½ ì „í™˜ ë° ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ
"""
import asyncio
import aiohttp
import time
from datetime import datetime

class ParallelDeploymentManager:
    def __init__(self):
        self.v3_services = {}
        self.v4_services = {}
        self.traffic_split = 0  # 0% V4, 100% V3ì—ì„œ ì‹œì‘
        self.rollback_triggers = {
            "error_rate_threshold": 0.05,  # 5%
            "response_time_threshold": 5000,  # 5ì´ˆ
            "success_rate_threshold": 0.95   # 95%
        }
        self.deployment_phases = [10, 25, 50, 75, 100]
        
    async def start_parallel_deployment(self):
        """ë³‘ë ¬ ë°°í¬ ì‹œì‘"""
        print("ğŸš€ Phoenix 95 V4 Zero Downtime ë°°í¬ ì‹œì‘")
        
        # 1. V4 ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
        v4_healthy = await self.check_v4_services_health()
        if not v4_healthy:
            print("âŒ V4 ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ")
            return False
            
        # 2. ì ì§„ì  íŠ¸ë˜í”½ ì „í™˜
        for phase in self.deployment_phases:
            print(f"ğŸ“Š íŠ¸ë˜í”½ {phase}% V4ë¡œ ì „í™˜ ì¤‘...")
            
            success = await self.execute_traffic_split(phase)
            if not success:
                print(f"âŒ {phase}% ì „í™˜ ì‹¤íŒ¨, ë¡¤ë°± ì‹œì‘")
                await self.emergency_rollback()
                return False
                
            # ì•ˆì •í™” ëŒ€ê¸°
            await asyncio.sleep(60)  # í”„ë¡œë•ì…˜ì—ì„œëŠ” ë” ê¸¸ê²Œ
            
        print("âœ… Phoenix 95 V4 ë°°í¬ ì™„ë£Œ!")
        return True
        
    async def execute_traffic_split(self, percentage):
        """íŠ¸ë˜í”½ ë¶„í•  ì‹¤í–‰"""
        self.traffic_split = percentage
        
        # íŠ¸ë˜í”½ ë¶„í•  ì„¤ì • (ë¡œë“œ ë°¸ëŸ°ì„œ ì„¤ì •)
        await self.configure_load_balancer(percentage)
        
        # ëª¨ë‹ˆí„°ë§ ì‹œì‘
        for _ in range(5):  # 5ë¶„ê°„ ëª¨ë‹ˆí„°ë§
            metrics = await self.collect_metrics()
            
            if not self.validate_metrics(metrics):
                return False
                
            await asyncio.sleep(60)
            
        return True
        
    async def configure_load_balancer(self, v4_percentage):
        """ë¡œë“œ ë°¸ëŸ°ì„œ ì„¤ì •"""
        config = {
            "v3_weight": 100 - v4_percentage,
            "v4_weight": v4_percentage,
            "health_check_interval": 30,
            "timeout": 5000
        }
        
        # ì‹¤ì œë¡œëŠ” nginx/haproxy ì„¤ì • ì—…ë°ì´íŠ¸
        print(f"âš–ï¸ ë¡œë“œ ë°¸ëŸ°ì„œ ì„¤ì •: V3({config['v3_weight']}%) V4({config['v4_weight']}%)")
        
    async def collect_metrics(self):
        """ë©”íŠ¸ë¦­ ìˆ˜ì§‘"""
        # ì‹¤ì œë¡œëŠ” Prometheusì—ì„œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        import random
        
        return {
            "error_rate": random.uniform(0.01, 0.03),
            "response_time": random.uniform(200, 800),
            "success_rate": random.uniform(0.97, 0.99),
            "cpu_usage": random.uniform(30, 60),
            "memory_usage": random.uniform(40, 70)
        }
        
    def validate_metrics(self, metrics):
        """ë©”íŠ¸ë¦­ ê²€ì¦"""
        if metrics["error_rate"] > self.rollback_triggers["error_rate_threshold"]:
            print(f"âš ï¸ ì—ëŸ¬ìœ¨ ê³¼ë‹¤: {metrics['error_rate']:.3f}")
            return False
            
        if metrics["response_time"] > self.rollback_triggers["response_time_threshold"]:
            print(f"âš ï¸ ì‘ë‹µì‹œê°„ ê³¼ë‹¤: {metrics['response_time']:.0f}ms")
            return False
            
        if metrics["success_rate"] < self.rollback_triggers["success_rate_threshold"]:
            print(f"âš ï¸ ì„±ê³µë¥  ë¶€ì¡±: {metrics['success_rate']:.3f}")
            return False
            
        print(f"âœ… ë©”íŠ¸ë¦­ ì •ìƒ: ì—ëŸ¬ìœ¨ {metrics['error_rate']:.3f}, ì‘ë‹µì‹œê°„ {metrics['response_time']:.0f}ms")
        return True
        
    async def emergency_rollback(self):
        """ê¸´ê¸‰ ë¡¤ë°±"""
        print("ğŸš¨ ê¸´ê¸‰ ë¡¤ë°± ì‹œì‘")
        
        # 1. ëª¨ë“  íŠ¸ë˜í”½ì„ V3ë¡œ ì¦‰ì‹œ ì „í™˜
        await self.configure_load_balancer(0)
        
        # 2. V4 ì„œë¹„ìŠ¤ ì•ˆì „ ì •ì§€
        await self.stop_v4_services()
        
        # 3. ë¡¤ë°± ì•Œë¦¼
        await self.send_rollback_notification()
        
        print("âœ… ë¡¤ë°± ì™„ë£Œ - V3 ì‹œìŠ¤í…œìœ¼ë¡œ ë³µêµ¬ë¨")
        
    async def check_v4_services_health(self):
        """V4 ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬"""
        v4_ports = [8100, 8101, 8102, 8103, 8104, 8105, 8106, 8107, 8108, 8109, 8110]
        healthy_services = 0
        
        for port in v4_ports:
            try:
                async with aiohttp.ClientSession() as session:
                    async with session.get(f"http://localhost:{port}/health", timeout=5) as response:
                        if response.status == 200:
                            healthy_services += 1
            except:
                pass
                
        health_ratio = healthy_services / len(v4_ports)
        print(f"ğŸ¥ V4 ì„œë¹„ìŠ¤ í—¬ìŠ¤: {healthy_services}/{len(v4_ports)} ({health_ratio:.1%})")
        
        return health_ratio >= 0.9  # 90% ì´ìƒ ì •ìƒì´ì–´ì•¼ í•¨
        
    async def stop_v4_services(self):
        """V4 ì„œë¹„ìŠ¤ ì•ˆì „ ì •ì§€"""
        print("â¹ï¸ V4 ì„œë¹„ìŠ¤ ì•ˆì „ ì •ì§€ ì¤‘...")
        # ì‹¤ì œë¡œëŠ” docker-compose stop ë˜ëŠ” kubectl scale down
        
    async def send_rollback_notification(self):
        """ë¡¤ë°± ì•Œë¦¼ ì „ì†¡"""
        print("ğŸ“¢ ë¡¤ë°± ì•Œë¦¼ ì „ì†¡")
        # ì‹¤ì œë¡œëŠ” í…”ë ˆê·¸ë¨/ìŠ¬ë™ ì•Œë¦¼

async def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    manager = ParallelDeploymentManager()
    await manager.start_parallel_deployment()

if __name__ == "__main__":
    asyncio.run(main())
"@
    Set-Content -Path $deploymentPath -Value $deploymentCode -Encoding UTF8
}

function Create-ThreeLevelTemplates {
    param([string]$WorkDir)

    # QuickStart Template
    $quickStartPath = Join-Path $WorkDir "templates\quickstart_template.py"
    $quickStartCode = @"
"""
Phoenix 95 V4 QuickStart Template - 5ë¶„ ì™„ì„±
ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ë³¸ ì„œë¹„ìŠ¤ ìƒì„±
"""
from phoenix95_v4 import QuickService

class Phoenix95QuickStart:
    def __init__(self, service_name, port, phoenix95_enabled=True):
        self.service = QuickService(
            name=service_name,
            port=port,
            phoenix95_enabled=phoenix95_enabled
        )
        
        # V3 ê¸°ëŠ¥ ìë™ í™œì„±í™”
        self.service.enable_20x_leverage()
        self.service.enable_telegram_alerts()
        self.service.enable_phoenix95_ai()
        
    def create_trading_service(self):
        """ê±°ë˜ ì„œë¹„ìŠ¤ ìƒì„±"""
        @self.service.on_signal
        async def process_trading_signal(signal_data):
            # Phoenix 95 AI ìë™ ë¶„ì„
            analysis = await self.service.phoenix95_analyze(signal_data) 
            
            # 20x ë ˆë²„ë¦¬ì§€ ê±°ë˜ ìë™ ì‹¤í–‰
            if analysis.confidence > 0.7:
                trade_result = await self.service.execute_leverage_trade(
                    symbol=signal_data.symbol,
                    side=signal_data.side,
                    leverage=20,
                    confidence=analysis.confidence
                )
                
                # í…”ë ˆê·¸ë¨ ì•Œë¦¼ ìë™ ì „ì†¡
                await self.service.send_telegram_alert(trade_result)
                
            return {"status": "processed", "analysis": analysis}
            
        return self.service
        
    def run(self):
        """ì„œë¹„ìŠ¤ ì‹¤í–‰"""
        self.service.run()

# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == "__main__":
    # ë‹¨ 3ì¤„ë¡œ ì™„ì „í•œ Phoenix 95 ì„œë¹„ìŠ¤ ìƒì„±
    quick_service = Phoenix95QuickStart("my-trading-bot", 8111)
    trading_service = quick_service.create_trading_service()
    quick_service.run()
"@
    Set-Content -Path $quickStartPath -Value $quickStartCode -Encoding UTF8

    # Professional Template
    $professionalPath = Join-Path $WorkDir "templates\professional_template.py"
    $professionalCode = @"
"""
Phoenix 95 V4 Professional Template - 30ë¶„ ì™„ì„±
ì‹¤ë¬´ í™˜ê²½ì„ ìœ„í•œ ê³ ê¸‰ ê¸°ëŠ¥ êµ¬í˜„
"""
from phoenix95_v4 import ProfessionalService
from phoenix95_v4.ai import EnsembleModel
from phoenix95_v4.risk import AdvancedRiskManager

class Phoenix95Professional:
    def __init__(self, config):
        self.service = ProfessionalService(config)
        self.config = config
        
        # AI ì•™ìƒë¸” ëª¨ë¸ ì„¤ì •
        self.ai_models = EnsembleModel([
            "lstm_model",
            "transformer_model", 
            "cnn_model"
        ])
        
        # ê³ ê¸‰ ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì €
        self.risk_manager = AdvancedRiskManager(
            kelly_criterion=True,
            var_calculation=True,
            correlation_analysis=True
        )
        
    def setup_advanced_phoenix95(self):
        """ê³ ê¸‰ Phoenix 95 ì„¤ì •"""
        phoenix95_config = {
            "threshold": self.config.get("phoenix95_threshold", 0.85),
            "ensemble_models": self.ai_models,
            "confidence_adjustment": True,
            "market_regime_detection": True,
            "volatility_adjustment": True
        }
        
        self.service.configure_phoenix95(phoenix95_config)
        
    def setup_advanced_leverage(self):
        """ê³ ê¸‰ ë ˆë²„ë¦¬ì§€ ì„¤ì •"""
        leverage_config = {
            "leverage_range": (1, 20),
            "dynamic_leverage": True,
            "margin_mode": "ISOLATED",
            "position_sizing": "kelly_criterion",
            "risk_per_trade": 0.02,
            "correlation_limit": 0.7
        }
        
        self.service.configure_leverage(leverage_config)
        
    def create_advanced_trading_engine(self):
        """ê³ ê¸‰ ê±°ë˜ ì—”ì§„ ìƒì„±"""
        @self.service.on_signal
        async def advanced_signal_processing(signal_data):
            # 1. ë‹¤ì¤‘ íŒ©í„° ë¶„ì„
            multi_factor_analysis = await self.ai_models.analyze(signal_data)
            
            # 2. ë¦¬ìŠ¤í¬ í‰ê°€
            risk_assessment = await self.risk_manager.evaluate(signal_data)
            
            # 3. í¬íŠ¸í´ë¦¬ì˜¤ ìƒê´€ê´€ê³„ ì²´í¬
            correlation_check = await self.risk_manager.check_correlation(signal_data)
            
            # 4. Kelly Criterion í¬ì§€ì…˜ ì‚¬ì´ì§•
            optimal_size = await self.risk_manager.calculate_kelly_position(
                signal_data, multi_factor_analysis
            )
            
            # 5. ê³ ê¸‰ ê±°ë˜ ì‹¤í–‰
            if (multi_factor_analysis.score > 0.8 and 
                risk_assessment.level < 0.3 and
                correlation_check.passed):
                
                trade_result = await self.service.execute_advanced_trade(
                    signal_data=signal_data,
                    position_size=optimal_size,
                    risk_params=risk_assessment
                )
                
                return {"status": "executed", "trade": trade_result}
            else:
                return {"status": "filtered", "reason": "risk_criteria_not_met"}
                
        return self.service
        
    def setup_backtesting(self):
        """ë°±í…ŒìŠ¤íŒ… ì‹œìŠ¤í…œ ì„¤ì •"""
        backtest_config = {
            "start_date": "2023-01-01",
            "end_date": "2024-12-31", 
            "initial_capital": 100000,
            "transaction_costs": 0.001,
            "slippage": 0.0005
        }
        
        self.service.enable_backtesting(backtest_config)
        
    def run_professional_service(self):
        """Professional ì„œë¹„ìŠ¤ ì‹¤í–‰"""
        self.setup_advanced_phoenix95()
        self.setup_advanced_leverage()
        self.setup_backtesting()
        
        trading_engine = self.create_advanced_trading_engine()
        trading_engine.run()

# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == "__main__":
    config = {
        "phoenix95_threshold": 0.85,
        "max_leverage": 20,
        "risk_management": "advanced",
        "backtesting": True
    }
    
    professional = Phoenix95Professional(config)
    professional.run_professional_service()
"@
    Set-Content -Path $professionalPath -Value $professionalCode -Encoding UTF8

    # Expert Template
    $expertPath = Join-Path $WorkDir "templates\expert_template.py"
    $expertCode = @"
"""
Phoenix 95 V4 Expert Template - ì™„ì „ DDD êµ¬í˜„
ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ì™„ì „ ì»¤ìŠ¤í„°ë§ˆì´ì§•
"""
from phoenix95_v4.domain.aggregates import Phoenix95SignalAggregate
from phoenix95_v4.domain.value_objects import ConfidenceScore, LeveragePosition
from phoenix95_v4.application.command_handlers import ProcessSignalCommandHandler
from phoenix95_v4.application.query_handlers import GetAnalysisQueryHandler
from phoenix95_v4.infrastructure.repositories import SignalRepository

class Phoenix95Expert:
    def __init__(self):
        # DDD ì•„í‚¤í…ì²˜ êµ¬ì„±
        self.signal_repository = SignalRepository()
        self.command_handler = ProcessSignalCommandHandler()
        self.query_handler = GetAnalysisQueryHandler()
        
    def create_signal_aggregate(self, signal_data):
        """ì‹ í˜¸ Aggregate ìƒì„±"""
        confidence_score = ConfidenceScore(signal_data.confidence)
        leverage_position = LeveragePosition(
            leverage=20,
            margin_mode="ISOLATED",
            stop_loss_percent=0.02,
            take_profit_percent=0.02
        )
        
        signal_aggregate = Phoenix95SignalAggregate(
            signal_id=signal_data.id,
            symbol=signal_data.symbol,
            confidence_score=confidence_score,
            leverage_position=leverage_position
        )
        
        return signal_aggregate
        
    def process_with_ddd(self, signal_data):
        """DDD íŒ¨í„´ìœ¼ë¡œ ì‹ í˜¸ ì²˜ë¦¬"""
        # 1. Domain Aggregate ìƒì„±
        signal_aggregate = self.create_signal_aggregate(signal_data)
        
        # 2. Business Rules ì ìš©
        validation_result = signal_aggregate.validate_trading_conditions()
        if not validation_result.is_valid:
            return {"status": "rejected", "reason": validation_result.reason}
            
        # 3. Phoenix 95 AI ë¶„ì„ (Domain Service)
        ai_analysis = signal_aggregate.analyze_with_phoenix95()
        
        # 4. Risk Management (Domain Service)
        risk_assessment = signal_aggregate.assess_risk()
        
        # 5. Position Sizing (Domain Service)  
        position_size = signal_aggregate.calculate_optimal_position()
        
        # 6. Command ì²˜ë¦¬
        execute_command = {
            "aggregate": signal_aggregate,
            "analysis": ai_analysis,
            "risk": risk_assessment,
            "position_size": position_size
        }
        
        result = self.command_handler.handle(execute_command)
        
        # 7. Domain Event ë°œí–‰
        if result.success:
            signal_aggregate.publish_trading_executed_event()
            
        return result
        
    def setup_expert_system(self):
        """Expert ì‹œìŠ¤í…œ ì„¤ì •"""
        # Repository íŒ¨í„´
        self.signal_repository.configure_persistence()
        
        # Command/Query ë¶„ë¦¬
        self.command_handler.register_commands()
        self.query_handler.register_queries()
        
        # Event Sourcing
        self.setup_event_store()
        
        # Saga Pattern for complex workflows
        self.setup_trading_saga()
        
    def setup_event_store(self):
        """ì´ë²¤íŠ¸ ì†Œì‹± ì„¤ì •"""
        from phoenix95_v4.infrastructure.event_store import EventStore
        self.event_store = EventStore()
        
    def setup_trading_saga(self):
        """ê±°ë˜ Saga ì„¤ì •"""
        from phoenix95_v4.application.sagas import TradingSaga
        self.trading_saga = TradingSaga()

# Domain Objects (ë³„ë„ íŒŒì¼ë“¤)
class Phoenix95SignalAggregate:
    def __init__(self, signal_id, symbol, confidence_score, leverage_position):
        self.signal_id = signal_id
        self.symbol = symbol
        self.confidence_score = confidence_score
        self.leverage_position = leverage_position
        self.domain_events = []
        
    def validate_trading_conditions(self):
        """ê±°ë˜ ì¡°ê±´ ê²€ì¦ (Business Rules)"""
        if not self.confidence_score.is_above_threshold():
            return ValidationResult(False, "ì‹ ë¢°ë„ ë¶€ì¡±")
            
        if not self.leverage_position.is_valid():
            return ValidationResult(False, "ë ˆë²„ë¦¬ì§€ ì„¤ì • ì˜¤ë¥˜")
            
        return ValidationResult(True, "ê²€ì¦ í†µê³¼")
        
    def analyze_with_phoenix95(self):
        """Phoenix 95 AI ë¶„ì„ (Domain Service)"""
        # ì‹¤ì œ AI ë¶„ì„ ë¡œì§
        return AIAnalysisResult(score=0.85, recommendation="STRONG_BUY")
        
    def assess_risk(self):
        """ë¦¬ìŠ¤í¬ í‰ê°€ (Domain Service)"""
        return RiskAssessment(level=0.3, factors=["low_volatility"])
        
    def calculate_optimal_position(self):
        """ìµœì  í¬ì§€ì…˜ ê³„ì‚° (Domain Service)"""
        return PositionSize(0.05)  # 5% í¬ì§€ì…˜
        
    def publish_trading_executed_event(self):
        """Domain Event ë°œí–‰"""
        event = TradingExecutedEvent(
            signal_id=self.signal_id,
            timestamp=datetime.now()
        )
        self.domain_events.append(event)

# Value Objects
class ConfidenceScore:
    def __init__(self, value):
        if not 0 <= value <= 1:
            raise ValueError("ì‹ ë¢°ë„ëŠ” 0-1 ë²”ìœ„ì—¬ì•¼ í•¨")
        self.value = value
        
    def is_above_threshold(self, threshold=0.7):
        return self.value > threshold

class LeveragePosition:
    def __init__(self, leverage, margin_mode, stop_loss_percent, take_profit_percent):
        self.leverage = leverage
        self.margin_mode = margin_mode
        self.stop_loss_percent = stop_loss_percent
        self.take_profit_percent = take_profit_percent
        
    def is_valid(self):
        return (1 <= self.leverage <= 100 and 
                self.margin_mode in ["ISOLATED", "CROSS"])

# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == "__main__":
    expert = Phoenix95Expert()
    expert.setup_expert_system()
    
    # DDD íŒ¨í„´ìœ¼ë¡œ ì‹ í˜¸ ì²˜ë¦¬
    signal_data = SignalData(
        id="signal_123",
        symbol="BTCUSDT", 
        confidence=0.85,
        price=45000
    )
    
    result = expert.process_with_ddd(signal_data)
    print(f"Expert ì²˜ë¦¬ ê²°ê³¼: {result}")
"@
    Set-Content -Path $expertPath -Value $expertCode -Encoding UTF8

    Write-Log "âœ… 3-Level ê°œë°œ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ (QuickStart/Professional/Expert)" "SUCCESS"
}

# ========================================
# ëˆ„ë½ëœ ê³ ê¸‰ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ í…œí”Œë¦¿ë“¤
# ========================================

function Add-AdvancedTelegramTemplates {
    param([string]$WorkDir)

    $telegramConfigPath = Join-Path $WorkDir "shared\config\telegram_config.py"
    
    # ê¸°ì¡´ íŒŒì¼ì— ì¶”ê°€í•  ê³ ê¸‰ í…œí”Œë¦¿ë“¤
    $advancedTemplates = @"

def send_deployment_notification(deployment_info):
    """ë°°í¬ ì™„ë£Œ ì•Œë¦¼"""
    message = f"""
ğŸ‰ <b>Phoenix 95 V4 ë°°í¬ ì™„ë£Œ</b>

â° ì‹œê°„: {deployment_info.get('timestamp')}
ğŸ–¥ï¸ í”Œë«í¼: {deployment_info.get('platform')}
ğŸŒ í™˜ê²½: {deployment_info.get('environment')}
âœ… V4 Enhanced ì‹œìŠ¤í…œ í™œì„±í™”
ğŸ”— API Gateway: http://localhost:8100
ğŸ¤– Phoenix 95 AI: http://localhost:8103
âš¡ 20x ë ˆë²„ë¦¬ì§€: í™œì„±í™”
ğŸ“ˆ Grafana: http://localhost:3000
ğŸ—ï¸ DDD ì•„í‚¤í…ì²˜: ì ìš©ë¨
ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼: ì—°ê²°ë¨

ğŸ¯ 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ!
"""
    return send_telegram_signal(message, "success")

def send_backup_notification(backup_info):
    """ë°±ì—… ì™„ë£Œ ì•Œë¦¼"""
    message = f"""
ğŸ’¾ <b>Phoenix 95 V4 ë°±ì—… ì™„ë£Œ</b>

â° ì‹œê°„: {backup_info.get('timestamp')}
ğŸ–¥ï¸ í”Œë«í¼: {backup_info.get('platform')}
ğŸŒ í™˜ê²½: {backup_info.get('environment')}
ğŸ“ ìœ„ì¹˜: {backup_info.get('backup_path')}

âœ… ì„¤ì • íŒŒì¼ ë°±ì—… ì™„ë£Œ
âœ… ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì™„ë£Œ
âœ… ë¡œê·¸ íŒŒì¼ ë°±ì—… ì™„ë£Œ
âœ… DDD êµ¬ì¡° ë°±ì—… ì™„ë£Œ
âœ… 11ê°œ ì„œë¹„ìŠ¤ ì„¤ì • ë°±ì—… ì™„ë£Œ

ğŸ›¡ï¸ ë°ì´í„° ì•ˆì „í•˜ê²Œ ë³´ê´€ë¨
"""
    return send_telegram_signal(message, "success")

def send_rollback_notification(rollback_info):
    """ë¡¤ë°± ì•Œë¦¼"""
    message = f"""
ğŸš¨ <b>Phoenix 95 V4 ìë™ ë¡¤ë°± ì•Œë¦¼</b>

â° ì‹œê°„: {rollback_info.get('timestamp')}
ğŸ–¥ï¸ í”Œë«í¼: {rollback_info.get('platform')}
ğŸŒ í™˜ê²½: {rollback_info.get('environment')}
ğŸ”„ ì¡°ì¹˜: V4 ì•ˆì „ ëª¨ë“œë¡œ ìë™ ì „í™˜ ì™„ë£Œ

ğŸ“Š ì¥ì•  ì •ë³´:
- ì›ì¸: {rollback_info.get('failure_reason')}
- ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜: {rollback_info.get('failure_count')}
- ë¡¤ë°± íŠ¸ë¦¬ê±°: ìë™ í—¬ìŠ¤ì²´í¬
- ì˜í–¥ë°›ì€ ì„œë¹„ìŠ¤: 11ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤

ğŸ” ìƒì„¸ ë¡œê·¸: {rollback_info.get('log_file')}

âš ï¸ ì¦‰ì‹œ ì‹œìŠ¤í…œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.
ğŸ”§ DDD ì•„í‚¤í…ì²˜ ë° ë ˆë²„ë¦¬ì§€ ì„¤ì • í™•ì¸ í•„ìš”
"""
    return send_telegram_signal(message, "error")

def send_performance_report(performance_data):
    """ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì•Œë¦¼"""
    message = f"""
ğŸ“Š <b>Phoenix 95 V4 ì„±ëŠ¥ ë¦¬í¬íŠ¸</b>

â° ì‹œê°„: {performance_data.get('timestamp')}
ğŸ–¥ï¸ CPU ì‚¬ìš©ë¥ : {performance_data.get('cpu_usage')}%
ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {performance_data.get('memory_usage')}%
âš¡ ì‘ë‹µì‹œê°„: {performance_data.get('response_time')}ms
ğŸ“ˆ ì²˜ë¦¬ëŸ‰: {performance_data.get('throughput')} req/sec

ğŸ¤– AI ì—”ì§„ ì„±ëŠ¥:
- Phoenix 95 ì •í™•ë„: {performance_data.get('ai_accuracy', 85)}%
- ë¶„ì„ ì²˜ë¦¬ëŸ‰: {performance_data.get('analysis_throughput', 50)} signals/min
- í‰ê·  ì‹ ë¢°ë„: {performance_data.get('avg_confidence', 0.78):.2f}

ğŸ’° ë ˆë²„ë¦¬ì§€ ê±°ë˜:
- í™œì„± í¬ì§€ì…˜: {performance_data.get('active_positions', 3)}ê°œ
- ì¼ì¼ ìˆ˜ìµë¥ : {performance_data.get('daily_return', 2.5)}%
- ë¦¬ìŠ¤í¬ ìˆ˜ì¤€: {performance_data.get('risk_level', 'LOW')}

ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ: {performance_data.get('healthy_services', 11)}/11 ì •ìƒ
"""
    return send_telegram_signal(message, "info")

def send_trading_summary(trading_summary):
    """ê±°ë˜ ìš”ì•½ ì•Œë¦¼"""
    message = f"""
ğŸ“ˆ <b>Phoenix 95 ì¼ì¼ ê±°ë˜ ìš”ì•½</b>

â° ê¸°ê°„: {trading_summary.get('date')}
ğŸ’° ì´ ê±°ë˜ ìˆ˜: {trading_summary.get('total_trades')}ê±´
âœ… ì„±ê³µ ê±°ë˜: {trading_summary.get('successful_trades')}ê±´
âŒ ì‹¤íŒ¨ ê±°ë˜: {trading_summary.get('failed_trades')}ê±´
ğŸ“Š ìŠ¹ë¥ : {trading_summary.get('win_rate')}%

ğŸ’µ ì†ìµ í˜„í™©:
- ì‹¤í˜„ ìˆ˜ìµ: ${trading_summary.get('realized_pnl', 0):,.2f}
- ë¯¸ì‹¤í˜„ ì†ìµ: ${trading_summary.get('unrealized_pnl', 0):,.2f}
- ìˆ˜ìˆ˜ë£Œ: ${trading_summary.get('fees', 0):,.2f}
- ìˆœ ìˆ˜ìµ: ${trading_summary.get('net_profit', 0):,.2f}

âš¡ ë ˆë²„ë¦¬ì§€ í†µê³„:
- í‰ê·  ë ˆë²„ë¦¬ì§€: {trading_summary.get('avg_leverage', 15)}x
- ìµœëŒ€ í¬ì§€ì…˜: ${trading_summary.get('max_position', 0):,.2f}
- ë§ˆì§„ ì‚¬ìš©ë¥ : {trading_summary.get('margin_usage', 45)}%

ğŸ¯ Phoenix 95 AI ì„±ëŠ¥:
- í‰ê·  ì‹ ë¢°ë„: {trading_summary.get('avg_ai_confidence', 0.76):.2f}
- ê³ ì‹ ë¢°ë„ ì‹ í˜¸ ({trading_summary.get('high_confidence_threshold', 0.8)}+): {trading_summary.get('high_confidence_signals', 12)}ê°œ
- AI ì¶”ì²œ ì •í™•ë„: {trading_summary.get('ai_accuracy', 84)}%
"""
    return send_telegram_signal(message, "trade")
"@

    # ê¸°ì¡´ íŒŒì¼ì— ì¶”ê°€
    Add-Content -Path $telegramConfigPath -Value $advancedTemplates -Encoding UTF8
    Write-Log "âœ… ê³ ê¸‰ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ í…œí”Œë¦¿ ì¶”ê°€ ì™„ë£Œ" "SUCCESS"
}

# ========================================
# ëˆ„ë½ëœ Infrastructure as Code ë¶€ë¶„
# ========================================

function Create-KubernetesManifests {
    param([string]$WorkDir)

    $k8sPath = Join-Path $WorkDir "infrastructure\kubernetes"
    if (-not (Test-Path $k8sPath)) {
        New-Item -ItemType Directory -Path $k8sPath -Force | Out-Null
    }

    # Kubernetes Deployment
    $deploymentYaml = @"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phoenix95-api-gateway
  labels:
    app: phoenix95-api-gateway
    version: v4.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: phoenix95-api-gateway
  template:
    metadata:
      labels:
        app: phoenix95-api-gateway
        version: v4.0.0
    spec:
      containers:
      - name: api-gateway
        image: phoenix95/api-gateway:4.0.0
        ports:
        - containerPort: 8100
        env:
        - name: ENVIRONMENT
          value: "production"
        - name: PHOENIX95_AI_ENABLED
          value: "true"
        - name: LEVERAGE_ENABLED
          value: "true"
        - name: TELEGRAM_TOKEN
          valueFrom:
            secretKeyRef:
              name: phoenix95-secrets
              key: telegram-token
        livenessProbe:
          httpGet:
            path: /health
            port: 8100
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8100
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: phoenix95-api-gateway-service
spec:
  selector:
    app: phoenix95-api-gateway
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8100
  type: LoadBalancer
---
apiVersion: v1
kind: Secret
metadata:
  name: phoenix95-secrets
type: Opaque
data:
  telegram-token: N0UzODY1NDI4MTE6QUFFWjIxcDMwckVTMWs4TnhOTTJ4YlozVTQ0UEk5RDVDWQo=
  telegram-chat-id: NzU5MDg5NTk1Mgo=
"@
    Set-Content -Path (Join-Path $k8sPath "api-gateway-deployment.yaml") -Value $deploymentYaml -Encoding UTF8

    # Helm Chart
    $helmPath = Join-Path $WorkDir "infrastructure\helm\phoenix95"
    if (-not (Test-Path $helmPath)) {
        New-Item -ItemType Directory -Path $helmPath -Force | Out-Null
    }

    $chartYaml = @"
apiVersion: v2
name: phoenix95
description: Phoenix 95 V4 Enhanced - Enterprise Trading System
type: application
version: 4.0.0
appVersion: 4.0.0
keywords:
  - trading
  - ai
  - leverage
  - microservices
  - ddd
maintainers:
  - name: Phoenix95 Team
    email: team@phoenix95.com
"@
    Set-Content -Path (Join-Path $helmPath "Chart.yaml") -Value $chartYaml -Encoding UTF8

    Write-Log "âœ… Kubernetes ë° Helm ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ" "SUCCESS"
}

function Create-SecurityConfigurations {
    param([string]$WorkDir)

    $securityPath = Join-Path $WorkDir "infrastructure\security"
    if (-not (Test-Path $securityPath)) {
        New-Item -ItemType Directory -Path $securityPath -Force | Out-Null
    }

    # Network Security Policy
    $networkPolicy = @"
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: phoenix95-network-policy
spec:
  podSelector:
    matchLabels:
      app: phoenix95
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: phoenix95
    ports:
    - protocol: TCP
      port: 8100
    - protocol: TCP
      port: 8103
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 6379
"@
    Set-Content -Path (Join-Path $securityPath "network-policy.yaml") -Value $networkPolicy -Encoding UTF8

    # RBAC Configuration
    $rbacConfig = @"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: phoenix95-service-account
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: phoenix95-role
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: phoenix95-role-binding
subjects:
- kind: ServiceAccount
  name: phoenix95-service-account
roleRef:
  kind: Role
  name: phoenix95-role
  apiGroup: rbac.authorization.k8s.io
"@
    Set-Content -Path (Join-Path $securityPath "rbac.yaml") -Value $rbacConfig -Encoding UTF8

    Write-Log "âœ… ë³´ì•ˆ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ" "SUCCESS"
}

# ========================================
# ë©”ì¸ í•¨ìˆ˜ì— ëˆ„ë½ëœ í•¨ìˆ˜ë“¤ ì¶”ê°€ í˜¸ì¶œ
# ========================================

# Install-Phoenix95V4 í•¨ìˆ˜ì— ì¶”ê°€í•  ë¶€ë¶„
function Add-MissingInstallationSteps {
    param([string]$WorkDir)

    Write-Log "ğŸ”§ ëˆ„ë½ëœ ê³ ê¸‰ êµ¬ì„±ìš”ì†Œ ìƒì„± ì¤‘..." "INFO"
    
    # AST ê¸°ë°˜ ì½”ë“œ ë¶„ì„ ë„êµ¬ ìƒì„±
    Create-IntelligentCodeAnalyzer -WorkDir $WorkDir
    Create-SmartCodeExtractor -WorkDir $WorkDir
    
    # Zero Downtime ë°°í¬ ì‹œìŠ¤í…œ
    Create-ParallelDeploymentManager -WorkDir $WorkDir
    
    # 3-Level ê°œë°œ í…œí”Œë¦¿
    Create-ThreeLevelTemplates -WorkDir $WorkDir
    
    # ê³ ê¸‰ í…”ë ˆê·¸ë¨ í…œí”Œë¦¿
    Add-AdvancedTelegramTemplates -WorkDir $WorkDir
    
    # Infrastructure as Code
    Create-KubernetesManifests -WorkDir $WorkDir
    Create-SecurityConfigurations -WorkDir $WorkDir
    
    Write-Log "âœ… ëˆ„ë½ëœ ëª¨ë“  ê³ ê¸‰ êµ¬ì„±ìš”ì†Œ ìƒì„± ì™„ë£Œ" "SUCCESS"
}

# ========================================
# ì„¤ì¹˜ í•¨ìˆ˜ ì—…ë°ì´íŠ¸ (ëˆ„ë½ ë¶€ë¶„ ì¶”ê°€)
# ========================================

# Install-Phoenix95V4 í•¨ìˆ˜ì˜ ëë¶€ë¶„ì— ë‹¤ìŒ ì¶”ê°€:
Write-Log "ğŸ”§ ê³ ê¸‰ ë„êµ¬ ë° í…œí”Œë¦¿ ìƒì„± ì¤‘..." "INFO"
Add-MissingInstallationSteps -WorkDir $workDir

