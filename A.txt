# ================== ì™„ì „í•œ ì›¹ ëŒ€ì‹œë³´ë“œ ==================
class CompleteWebDashboard:
    """ì™„ì „í•œ ì›¹ ëŒ€ì‹œë³´ë“œ (ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „)"""
    
    def __init__(self, system):
        self.system = system
        self.app = web.Application()
        self._setup_routes()
    
    def _setup_routes(self):
        """ë¼ìš°íŠ¸ ì„¤ì •"""
        # ê¸°ë³¸ ë¼ìš°íŠ¸ë“¤
        self.app.router.add_get('/', self.dashboard_handler)
        self.app.router.add_get('/api/status', self.status_handler)
        self.app.router.add_get('/api/metrics', self.metrics_handler)
        self.app.router.add_get('/api/positions', self.positions_handler)
        self.app.router.add_get('/api/trades', self.trades_handler)
        self.app.router.add_get('/health', self.health_handler)
        
        # WebSocket ë¼ìš°íŠ¸
        self.app.router.add_get('/ws', self.system.websocket_handler.websocket_handler)
        
        # ê³ ê¸‰ API ë¼ìš°íŠ¸ë“¤
        self.app.router.add_get('/api/ai-performance', self.ai_performance_handler)
        self.app.router.add_get('/api/price-stream', self.price_stream_handler)
        self.app.router.add_get('/api/system-health', self.system_health_handler)
        
        # ì œì–´ APIë“¤
        self.app.router.add_post('/api/close-position', self.close_position_handler)
        self.app.router.add_post('/api/emergency-stop', self.emergency_stop_handler)
    
    async def dashboard_handler(self, request):
        """ë©”ì¸ ëŒ€ì‹œë³´ë“œ HTML (ìˆ˜ì •ëœ ë²„ì „)"""
        html_content = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Phoenix 95 - Complete System</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Courier New', monospace; 
                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                    color: #00ff41; 
                    min-height: 100vh;
                }
                .header { 
                    text-align: center; 
                    padding: 20px;
                    background: rgba(0, 255, 65, 0.1);
                    border-bottom: 2px solid #00ff41;
                    margin-bottom: 20px;
                }
                .header h1 { 
                    font-size: 2.5em; 
                    text-shadow: 0 0 20px #00ff41;
                    margin-bottom: 10px;
                    animation: pulse 3s infinite;
                }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.7; }
                }
                .status-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px 20px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 5px;
                    margin: 0 20px 20px 20px;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                .connection-status {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .status-dot {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: #51cf66;
                    animation: heartbeat 2s infinite;
                }
                @keyframes heartbeat {
                    0%, 50%, 100% { opacity: 1; }
                    25%, 75% { opacity: 0.5; }
                }
                .status-dot.warning { background: #ffd43b; }
                .status-dot.danger { background: #ff6b6b; }
                .grid { 
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
                    gap: 20px; 
                    padding: 0 20px;
                }
                .card { 
                    background: rgba(26, 26, 26, 0.9); 
                    border: 1px solid #333; 
                    border-radius: 10px; 
                    padding: 20px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }
                .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 8px 25px rgba(0, 255, 65, 0.2);
                    border-color: #00ff41;
                }
                .card::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 2px;
                    background: linear-gradient(90deg, #00ff41, #00cc33);
                }
                .card h3 {
                    margin-bottom: 15px;
                    font-size: 1.3em;
                    border-bottom: 1px solid #333;
                    padding-bottom: 10px;
                }
                .metric { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 12px 0;
                    padding: 10px;
                    background: rgba(255, 255, 255, 0.03);
                    border-radius: 5px;
                }
                .metric:hover { background: rgba(255, 255, 255, 0.05); }
                .metric .label { opacity: 0.8; font-weight: 500; }
                .metric .value { font-weight: bold; font-size: 1.1em; }
                .good { color: #51cf66; }
                .warning { color: #ffd43b; }
                .danger { color: #ff6b6b; }
                .excellent { color: #00ff41; text-shadow: 0 0 5px #00ff41; }
                
                .positions-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.9em;
                    margin-top: 10px;
                }
                .positions-table th,
                .positions-table td {
                    padding: 10px 8px;
                    text-align: left;
                    border-bottom: 1px solid #333;
                }
                .positions-table th {
                    background: rgba(0, 255, 65, 0.1);
                    font-weight: bold;
                }
                .positions-table tr:hover {
                    background: rgba(255, 255, 255, 0.05);
                }
                
                .btn {
                    background: linear-gradient(45deg, #00ff41, #00cc33);
                    color: #000;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-family: 'Courier New', monospace;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    margin: 5px;
                    text-transform: uppercase;
                }
                .btn:hover {
                    background: linear-gradient(45deg, #00cc33, #00aa22);
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3);
                }
                .btn-danger {
                    background: linear-gradient(45deg, #ff6b6b, #ff5252);
                    color: #fff;
                }
                .btn-danger:hover {
                    background: linear-gradient(45deg, #ff5252, #ff4444);
                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                }
                
                .real-time-data {
                    background: rgba(0, 255, 65, 0.1);
                    border: 1px solid #00ff41;
                    border-radius: 5px;
                    padding: 10px;
                    margin: 10px 0;
                    animation: data-pulse 2s infinite;
                }
                @keyframes data-pulse {
                    0%, 100% { border-color: #00ff41; }
                    50% { border-color: #00cc33; }
                }
                
                .loading {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid rgba(0, 255, 65, 0.3);
                    border-radius: 50%;
                    border-top-color: #00ff41;
                    animation: spin 1s ease-in-out infinite;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                
                .error-message {
                    background: rgba(255, 107, 107, 0.1);
                    border: 1px solid #ff6b6b;
                    border-radius: 5px;
                    padding: 10px;
                    margin: 10px 0;
                    color: #ff6b6b;
                }
                
                .success-message {
                    background: rgba(81, 207, 102, 0.1);
                    border: 1px solid #51cf66;
                    border-radius: 5px;
                    padding: 10px;
                    margin: 10px 0;
                    color: #51cf66;
                }
                
                @media (max-width: 768px) {
                    .grid { grid-template-columns: 1fr; padding: 0 10px; }
                    .header h1 { font-size: 2em; }
                    .status-bar { flex-direction: column; gap: 10px; }
                    .positions-table { font-size: 0.8em; }
                    .btn { padding: 8px 16px; font-size: 0.9em; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ›ï¸ PHOENIX 95 COMPLETE SYSTEM</h1>
                <div class="subtitle">
                    <span class="excellent">â— LIVE TRADING â—</span>
                    <span class="good">HEDGE FUND GRADE</span>
                    <span class="excellent">â— REAL-TIME AI â—</span>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="connection-status">
                    <div class="status-dot" id="websocket-dot"></div>
                    <span>WebSocket: <span id="websocket-status">ì—°ê²° ì¤‘...</span></span>
                </div>
                <div>ì‹œìŠ¤í…œ ì‹œê°„: <span id="system-time">--:--:--</span></div>
                <div>ì—…íƒ€ì„: <span id="system-uptime">ê³„ì‚° ì¤‘...</span></div>
                <div>AI ë¶„ì„ë¥ : <span id="ai-analysis-rate" class="excellent">--</span></div>
            </div>
            
            <div class="grid">
                <!-- ì‹¤ì‹œê°„ í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ -->
                <div class="card">
                    <h3>ğŸ’° Portfolio Performance</h3>
                    <div class="metric">
                        <span class="label">ì´ P&L:</span>
                        <span class="value excellent" id="total-pnl">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="label">ì¼ì¼ P&L:</span>
                        <span class="value good" id="daily-pnl">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="label">ìŠ¹ë¥ :</span>
                        <span class="value good" id="win-rate">0%</span>
                    </div>
                    <div class="metric">
                        <span class="label">í™œì„± í¬ì§€ì…˜:</span>
                        <span class="value" id="active-positions-count">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">ì´ ê±°ë˜ìˆ˜:</span>
                        <span class="value" id="total-trades">0</span>
                    </div>
                </div>
                
                <!-- í™œì„± í¬ì§€ì…˜ -->
                <div class="card">
                    <h3>ğŸ“Š Active Positions</h3>
                    <div id="positions-container">
                        <table class="positions-table">
                            <thead>
                                <tr>
                                    <th>ì‹¬ë³¼</th>
                                    <th>ë°©í–¥</th>
                                    <th>í¬ê¸°</th>
                                    <th>P&L</th>
                                    <th>%</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="positions-tbody">
                                <tr><td colspan="6" style="text-align: center;">
                                    <div class="loading"></div> ë¡œë”© ì¤‘...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
                <div class="card">
                    <h3>ğŸ’» System Status</h3>
                    <div class="metric">
                        <span class="label">ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ :</span>
                        <span class="value good" id="memory-usage">0%</span>
                    </div>
                    <div class="metric">
                        <span class="label">CPU ì‚¬ìš©ë¥ :</span>
                        <span class="value good" id="cpu-usage">0%</span>
                    </div>
                    <div class="metric">
                        <span class="label">WebSocket í´ë¼ì´ì–¸íŠ¸:</span>
                        <span class="value" id="websocket-clients">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">AI ì—”ì§„:</span>
                        <span class="value excellent">ENHANCED ACTIVE</span>
                    </div>
                    <div class="metric">
                        <span class="label">ê±°ë˜ì†Œ ì—°ê²°:</span>
                        <span class="value good" id="exchange-status">ì—°ê²°ë¨</span>
                    </div>
                </div>
                
                <!-- Phoenix 95 AI Analytics -->
                <div class="card">
                    <h3>ğŸ§  Phoenix 95 AI Analytics</h3>
                    <div class="metric">
                        <span class="label">ì´ ë¶„ì„ ìˆ˜:</span>
                        <span class="value" id="total-analyses">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">ì‹¤í–‰ë¥ :</span>
                        <span class="value excellent" id="execution-rate">0%</span>
                    </div>
                    <div class="metric">
                        <span class="label">í‰ê·  ì‹ ë¢°ë„:</span>
                        <span class="value excellent" id="avg-confidence">0%</span>
                    </div>
                    <div class="metric">
                        <span class="label">í‰ê·  ë¶„ì„ ì‹œê°„:</span>
                        <span class="value good" id="avg-analysis-time">0ms</span>
                    </div>
                    <div class="metric">
                        <span class="label">ì‹ ë¢°ë„ ì„ê³„ê°’:</span>
                        <span class="value warning" id="confidence-threshold">75%</span>
                    </div>
                </div>
                
                <!-- ì‹¤ì‹œê°„ ê°€ê²© -->
                <div class="card">
                    <h3>ğŸ“ˆ Real-time Prices</h3>
                    <div id="price-stream-data">
                        <div class="real-time-data" id="btc-data">
                            <div style="display: flex; justify-content: space-between;">
                                <span class="excellent">BTC/USDT:</span>
                                <span id="btc-price" class="good">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                                <span>24h ë³€ë™:</span>
                                <span id="btc-change">0%</span>
                            </div>
                        </div>
                        <div class="real-time-data" id="eth-data">
                            <div style="display: flex; justify-content: space-between;">
                                <span class="excellent">ETH/USDT:</span>
                                <span id="eth-price" class="good">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                                <span>24h ë³€ë™:</span>
                                <span id="eth-change">0%</span>
                            </div>
                        </div>
                        <div class="real-time-data" id="ada-data">
                            <div style="display: flex; justify-content: space-between;">
                                <span class="excellent">ADA/USDT:</span>
                                <span id="ada-price" class="good">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                                <span>24h ë³€ë™:</span>
                                <span id="ada-change">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì œì–´ íŒ¨ë„ -->
                <div class="card">
                    <h3>ğŸ® Control Panel</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="btn" onclick="refreshAllData()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
                        <button class="btn btn-danger" onclick="emergencyStop()">ğŸ›‘ ë¹„ìƒ ì •ì§€</button>
                        <button class="btn" onclick="requestManualAnalysis()">ğŸ§  ìˆ˜ë™ ë¶„ì„</button>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 5px;">
                        <div class="excellent">âš¡ LIVE TRADING ACTIVE</div>
                        <small style="opacity: 0.8;">
                            í…ŒìŠ¤íŠ¸ë„· ëª¨ë“œ: <span id="testnet-mode" class="warning">í™•ì¸ ì¤‘...</span>
                        </small>
                    </div>
                    <div id="message-container" style="margin-top: 10px;">
                        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
            
            <script>
                // WebSocket ì—°ê²°
                let ws = null;
                let reconnectAttempts = 0;
                const maxReconnectAttempts = 5;
                let reconnectTimeout = null;
                
                function connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ì •ë¦¬
                    if (ws) {
                        ws.close();
                    }
                    
                    ws = new WebSocket(wsUrl);
                    
                    ws.onopen = function() {
                        console.log('WebSocket ì—°ê²° ì„±ê³µ');
                        updateWebSocketStatus('connected');
                        reconnectAttempts = 0;
                        
                        // ì¬ì—°ê²° íƒ€ì´ë¨¸ ì •ë¦¬
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                            reconnectTimeout = null;
                        }
                        
                        // ì´ˆê¸° ë°ì´í„° ìš”ì²­
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'request_update',
                                update_type: 'all'
                            }));
                        }
                    };
                    
                    ws.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (e) {
                            console.error('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                        }
                    };
                    
                    ws.onclose = function(event) {
                        console.log('WebSocket ì—°ê²° ì¢…ë£Œ:', event.code, event.reason);
                        updateWebSocketStatus('disconnected');
                        
                        // ìë™ ì¬ì—°ê²°
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const delay = 5000 * reconnectAttempts; // ì§€ìˆ˜ì  ë°±ì˜¤í”„
                            console.log(`${delay/1000}ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„ (${reconnectAttempts}/${maxReconnectAttempts})`);
                            
                            reconnectTimeout = setTimeout(connectWebSocket, delay);
                        } else {
                            console.error('ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
                            showMessage('WebSocket ì—°ê²° ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                        }
                    };
                    
                    ws.onerror = function(error) {
                        console.error('WebSocket ì˜¤ë¥˜:', error);
                        updateWebSocketStatus('error');
                    };
                }
                
                function handleWebSocketMessage(data) {
                    try {
                        switch (data.type) {
                            case 'portfolio_metrics':
                                updatePortfolioMetrics(data.data);
                                break;
                            case 'active_positions':
                                updateActivePositions(data.data);
                                break;
                            case 'system_status':
                                updateSystemStatus(data.data);
                                break;
                            case 'price_update':
                                updatePriceData(data.data);
                                break;
                            case 'info':
                                showMessage(data.message, 'success');
                                break;
                            case 'error':
                                showMessage(data.message, 'error');
                                break;
                            default:
                                console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', data.type, data);
                        }
                    } catch (e) {
                        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
                    }
                }
                
                function updateWebSocketStatus(status) {
                    const dot = document.getElementById('websocket-dot');
                    const statusText = document.getElementById('websocket-status');
                    
                    if (status === 'connected') {
                        dot.className = 'status-dot good';
                        statusText.textContent = 'ì—°ê²°ë¨';
                        statusText.className = 'good';
                    } else if (status === 'disconnected') {
                        dot.className = 'status-dot warning';
                        statusText.textContent = 'ì—°ê²° í•´ì œ';
                        statusText.className = 'warning';
                    } else if (status === 'error') {
                        dot.className = 'status-dot danger';
                        statusText.textContent = 'ì˜¤ë¥˜';
                        statusText.className = 'danger';
                    }
                }
                
                function updatePortfolioMetrics(data) {
                    const elements = {
                        'total-pnl': formatCurrency(data.total_pnl || 0),
                        'daily-pnl': formatCurrency(data.daily_pnl || 0),
                        'win-rate': formatPercentage(data.win_rate || 0),
                        'active-positions-count': data.active_positions || 0,
                        'total-trades': data.total_trades || 0
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                            
                            if (id.includes('pnl')) {
                                const numValue = parseFloat(value.replace(/[^-0-9.]/g, ''));
                                element.className = numValue >= 0 ? 'value excellent' : 'value danger';
                            }
                        }
                    });
                }
                
                function updateActivePositions(positions) {
                    const tbody = document.getElementById('positions-tbody');
                    
                    if (!positions || positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.6;">í™œì„± í¬ì§€ì…˜ ì—†ìŒ</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = positions.map(pos => `
                        <tr>
                            <td class="excellent">${pos.symbol}</td>
                            <td class="${pos.side === 'buy' ? 'good' : 'warning'}">${pos.side.toUpperCase()}</td>
                            <td>${parseFloat(pos.amount).toFixed(4)}</td>
                            <td class="${pos.pnl >= 0 ? 'excellent' : 'danger'}">${formatCurrency(pos.pnl)}</td>
                            <td class="${pos.pnl_percent >= 0 ? 'excellent' : 'danger'}">${pos.pnl_percent?.toFixed(2)}%</td>
                            <td>
                                <button class="btn btn-danger" style="font-size: 0.7em; padding: 4px 8px;" 
                                        onclick="closePosition(${pos.id})">ì²­ì‚°</button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                function updateSystemStatus(data) {
                    if (data.memory_percent !== undefined) {
                        const memoryEl = document.getElementById('memory-usage');
                        memoryEl.textContent = `${data.memory_percent}%`;
                        memoryEl.className = data.memory_percent > 85 ? 'value danger' : 
                                           data.memory_percent > 70 ? 'value warning' : 'value good';
                    }
                    
                    if (data.cpu_percent !== undefined) {
                        const cpuEl = document.getElementById('cpu-usage');
                        cpuEl.textContent = `${data.cpu_percent}%`;
                        cpuEl.className = data.cpu_percent > 80 ? 'value danger' : 
                                         data.cpu_percent > 60 ? 'value warning' : 'value good';
                    }
                    
                    if (data.connected_clients !== undefined) {
                        document.getElementById('websocket-clients').textContent = data.connected_clients;
                    }
                    
                    if (data.uptime_seconds !== undefined) {
                        document.getElementById('system-uptime').textContent = formatUptime(data.uptime_seconds);
                    }
                    
                    if (data.ai_engine_stats) {
                        updateAIPerformance(data.ai_engine_stats);
                    }
                }
                
                function updatePriceData(priceData) {
                    const symbol = priceData.symbol.replace('/', '').toLowerCase();
                    
                    const priceElementId = `${symbol.substring(0,3)}-price`;
                    const changeElementId = `${symbol.substring(0,3)}-change`;
                    
                    const priceEl = document.getElementById(priceElementId);
                    const changeEl = document.getElementById(changeElementId);
                    
                    if (priceEl && changeEl) {
                        priceEl.textContent = formatCurrency(priceData.price);
                        changeEl.textContent = `${priceData.change_24h?.toFixed(2)}%`;
                        changeEl.className = priceData.change_24h >= 0 ? 'excellent' : 'danger';
                    }
                }
                
                function updateAIPerformance(stats) {
                    const elements = {
                        'total-analyses': stats.total_analyses || 0,
                        'execution-rate': `${stats.execution_rate || 0}%`,
                        'avg-confidence': `${(stats.avg_confidence * 100 || 0).toFixed(1)}%`,
                        'avg-analysis-time': `${stats.avg_execution_time_ms || 0}ms`,
                        'confidence-threshold': `${stats.confidence_threshold * 100 || 75}%`
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                    
                    document.getElementById('ai-analysis-rate').textContent = `${stats.execution_rate || 0}%`;
                }
                
                function formatCurrency(value) {
                    const num = parseFloat(value) || 0;
                    return `$${num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                
                function formatPercentage(value) {
                    const num = parseFloat(value) || 0;
                    return `${(num * 100).toFixed(1)}%`;
                }
                
                function formatUptime(seconds) {
                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    
                    if (days > 0) return `${days}d ${hours}h ${minutes}m`;
                    if (hours > 0) return `${hours}h ${minutes}m`;
                    return `${minutes}m`;
                }
                
                function updateSystemTime() {
                    document.getElementById('system-time').textContent = new Date().toLocaleTimeString('ko-KR');
                }
                
                function showMessage(message, type = 'info') {
                    const container = document.getElementById('message-container');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
                    messageDiv.textContent = message;
                    
                    container.appendChild(messageDiv);
                    
                    // 5ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 5000);
                }
                
                async function refreshAllData() {
                    try {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'request_update',
                                update_type: 'all'
                            }));
                            showMessage('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ìš”ì²­ë¨', 'success');
                        } else {
                            throw new Error('WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                        }
                    } catch (error) {
                        showMessage(`ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
                    }
                }
                
                async function emergencyStop() {
                    if (confirm('âš ï¸ ì •ë§ë¡œ ë¹„ìƒ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  í™œì„± í¬ì§€ì…˜ì´ ì²­ì‚°ë©ë‹ˆë‹¤.')) {
                        try {
                            const response = await fetch('/api/emergency-stop', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'}
                            });
                            const result = await response.json();
                            
                            if (response.ok) {
                                showMessage(`ë¹„ìƒ ì •ì§€ ì™„ë£Œ: ${result.message}`, 'success');
                            } else {
                                throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                            }
                        } catch (error) {
                            showMessage(`ë¹„ìƒ ì •ì§€ ì‹¤íŒ¨: ${error.message}`, 'error');
                        }
                    }
                }
                
                async function closePosition(positionId) {
                    if (confirm(`í¬ì§€ì…˜ ${positionId}ë¥¼ ì²­ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        try {
                            const response = await fetch('/api/close-position', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({trade_id: positionId})
                            });
                            const result = await response.json();
                            
                            if (response.ok) {
                                showMessage(`í¬ì§€ì…˜ ì²­ì‚° ì™„ë£Œ: ${result.message}`, 'success');
                                // í¬ì§€ì…˜ ë°ì´í„° ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
                                if (ws && ws.readyState === WebSocket.OPEN) {
                                    ws.send(JSON.stringify({
                                        type: 'request_update',
                                        update_type: 'positions'
                                    }));
                                }
                            } else {
                                throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                            }
                        } catch (error) {
                            showMessage(`ì²­ì‚° ì‹¤íŒ¨: ${error.message}`, 'error');
                        }
                    }
                }
                
                async function requestManualAnalysis() {
                    try {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'manual_analysis_request'
                            }));
                            showMessage('ìˆ˜ë™ ë¶„ì„ ìš”ì²­ë¨', 'success');
                        } else {
                            throw new Error('WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                        }
                    } catch (error) {
                        showMessage(`ìˆ˜ë™ ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
                    }
                }
                
                // í…ŒìŠ¤íŠ¸ë„· ëª¨ë“œ í™•ì¸
                async function checkTestnetMode() {
                    try {
                        const response = await fetch('/api/system-health');
                        const data = await response.json();
                        
                        const testnetEl = document.getElementById('testnet-mode');
                        if (testnetEl) {
                            testnetEl.textContent = data.exchange ? 'ì‹¤ê±°ë˜' : 'í…ŒìŠ¤íŠ¸ë„·';
                            testnetEl.className = data.exchange ? 'danger' : 'warning';
                        }
                    } catch (error) {
                        console.error('í…ŒìŠ¤íŠ¸ë„· ëª¨ë“œ í™•ì¸ ì‹¤íŒ¨:', error);
                    }
                }
                
                // ì´ˆê¸°í™”
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, WebSocket ì—°ê²° ì‹œì‘');
                    connectWebSocket();
                    setInterval(updateSystemTime, 1000);
                    checkTestnetMode();
                    
                    // ì£¼ê¸°ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë„· ëª¨ë“œ í™•ì¸
                    setInterval(checkTestnetMode, 30000); // 30ì´ˆë§ˆë‹¤
                });
                
                // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ WebSocket ì •ë¦¬
                window.addEventListener('beforeunload', function() {
                    if (ws) {
                        ws.close();
                    }
                });
                
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                setInterval(function() {
                    if (ws && ws.readyState === WebSocket.CLOSED) {
                        console.log('WebSocket ì—°ê²°ì´ ëŠì–´ì§, ì¬ì—°ê²° ì‹œë„');
                        connectWebSocket();
                    }
                }, 10000); // 10ì´ˆë§ˆë‹¤ í™•ì¸
            </script>
        </body>
        </html>
        """
        return web.Response(text=html_content, content_type='text/html')
    
    async def status_handler(self, request):
        """ì‹œìŠ¤í…œ ìƒíƒœ API"""
        try:
            return web.json_response({
                "status": "running",
                "timestamp": datetime.now().isoformat(),
                "version": "Phoenix95-Complete-v1.0-Fixed",
                "testnet": CONFIG.get('testnet', True)
            })
        except Exception as e:
            logger.error(f"ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def metrics_handler(self, request):
        """ë©”íŠ¸ë¦­ API"""
        try:
            result = await self.system.db_manager.fetch_safe(
                "SELECT * FROM portfolio_metrics ORDER BY calculated_at DESC LIMIT 1"
            )
            
            metrics = result[0] if result else {}
            memory = psutil.virtual_memory()
            
            response_data = {
                "total_pnl": float(metrics.get('total_pnl', 0)),
                "daily_pnl": float(metrics.get('daily_pnl', 0)),
                "active_positions": metrics.get('active_positions', 0),
                "total_trades": metrics.get('total_trades', 0),
                "win_rate": float(metrics.get('win_rate', 0)),
                "memory_percent": round(memory.percent, 1),
                "timestamp": datetime.now().isoformat()
            }
            
            return web.json_response(response_data)
            
        except Exception as e:
            logger.error(f"ë©”íŠ¸ë¦­ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def positions_handler(self, request):
        """í¬ì§€ì…˜ API"""
        try:
            positions = await self.system.monitor.get_active_positions()
            return web.json_response({"positions": positions})
        except Exception as e:
            logger.error(f"í¬ì§€ì…˜ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def trades_handler(self, request):
        """ê±°ë˜ ë‚´ì—­ API"""
        try:
            trades = await self.system.db_manager.fetch_safe(
                "SELECT * FROM trades ORDER BY created_at DESC LIMIT 100"
            )
            
            trade_list = []
            for trade in trades:
                trade_dict = dict(trade)
                # Decimalì„ floatë¡œ ë³€í™˜í•˜ê³  datetimeì„ ë¬¸ìì—´ë¡œ ë³€í™˜
                for key, value in trade_dict.items():
                    if hasattr(value, '__float__'):
                        trade_dict[key] = float(value)
                    elif isinstance(value, datetime):
                        trade_dict[key] = value.isoformat()
                    elif value is None:
                        trade_dict[key] = None
                trade_list.append(trade_dict)
            
            return web.json_response({"trades": trade_list})
        except Exception as e:
            logger.error(f"ê±°ë˜ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def ai_performance_handler(self, request):
        """AI ì„±ëŠ¥ API"""
        try:
            if hasattr(self.system, 'ai_engine') and self.system.ai_engine:
                stats = self.system.ai_engine.get_performance_stats()
                return web.json_response(stats)
            else:
                return web.json_response({"error": "AI ì—”ì§„ì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"}, status=503)
        except Exception as e:
            logger.error(f"AI ì„±ëŠ¥ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def price_stream_handler(self, request):
        """ê°€ê²© ìŠ¤íŠ¸ë¦¼ API"""
        try:
            prices = {}
            for symbol in CONFIG['symbols']:
                if hasattr(self.system, 'price_stream') and self.system.price_stream:
                    price_data = self.system.price_stream.get_price_data(symbol)
                    if price_data:
                        prices[symbol] = price_data
            
            return web.json_response({"prices": prices})
        except Exception as e:
            logger.error(f"ê°€ê²© ìŠ¤íŠ¸ë¦¼ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def system_health_handler(self, request):
        """ì‹œìŠ¤í…œ í—¬ìŠ¤ API"""
        try:
            health_status = {
                "database": self.system.db_manager.pool is not None,
                "redis": self.system.redis_manager.redis is not None,
                "exchange": self.system.exchange_manager.connection_status,
                "price_stream": getattr(self.system.price_stream, 'running', False),
                "ai_engine": hasattr(self.system, 'ai_engine') and self.system.ai_engine is not None,
                "testnet": CONFIG.get('testnet', True),
                "overall": "healthy"
            }
            
            # ì „ì²´ ìƒíƒœ íŒì •
            critical_components = ["database", "ai_engine"]
            if not all(health_status[comp] for comp in critical_components):
                health_status["overall"] = "unhealthy"
            elif not all(health_status[comp] for comp in ["database", "redis", "exchange", "ai_engine"]):
                health_status["overall"] = "degraded"
            
            return web.json_response(health_status)
        except Exception as e:
            logger.error(f"ì‹œìŠ¤í…œ í—¬ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def close_position_handler(self, request):
        """í¬ì§€ì…˜ ì²­ì‚° API"""
        try:
            data = await request.json()
            trade_id = data.get('trade_id')
            
            if not trade_id:
                return web.json_response({"error": "trade_id required"}, status=400)
            
            # trade_idë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜
            try:
                trade_id = int(trade_id)
            except (ValueError, TypeError):
                return web.json_response({"error": "Invalid trade_id"}, status=400)
            
            result = await self.system.executor.close_position(trade_id)
            
            # ìƒíƒœ ì½”ë“œ ê²°ì •
            status_code = 200
            if result.get('status') in ['NOT_FOUND', 'ERROR']:
                status_code = 400
            elif result.get('status') == 'FAILED':
                status_code = 500
            
            return web.json_response(result, status=status_code)
            
        except Exception as e:
            logger.error(f"í¬ì§€ì…˜ ì²­ì‚° ì˜¤ë¥˜: {e}")
            return web.json_response({"error": str(e)}, status=500)
    
    async def emergency_stop_handler(self, request):
        """ë¹„ìƒ ì •ì§€ API"""
        try:
            # ëª¨ë“  í™œì„± í¬ì§€ì…˜ ì¡°íšŒ
            active_trades = await self.system.db_manager.fetch_safe(
                "SELECT id FROM trades WHERE status = 'active'"
            )
            
            closed_count = 0
            failed_count = 0
            
            # ê° í¬ì§€ì…˜ ì²­ì‚° ì‹œë„
            for trade in active_trades:
                try:
                    result = await self.system.executor.close_position(trade['id'])
                    if result.get('status') == 'CLOSED':
                        closed_count += 1
                    else:
                        failed_count += 1
                except Exception as e:
                    logger.error(f"í¬ì§€ì…˜ {trade['id']} ì²­ì‚° ì‹¤íŒ¨: {e}")
                    failed_count += 1
            
            # ì‹ í˜¸ ìƒì„± ì¤‘ì§€
            if hasattr(self.system, 'signal_generator') and self.system.signal_generator:
                self.system.signal_generator.stop_generation()
            
            # ì•Œë¦¼ ì „ì†¡
            total_positions = len(active_trades)
            if total_positions > 0:
                await self.system.notification_manager.send_alert(
                    f"ğŸš¨ ë¹„ìƒ ì •ì§€ ì‹¤í–‰: {closed_count}/{total_positions}ê°œ í¬ì§€ì…˜ ì²­ì‚° (ì‹¤íŒ¨: {failed_count}ê°œ)", 
                    'critical'
                )
            else:
                await self.system.notification_manager.send_alert(
                    "ğŸš¨ ë¹„ìƒ ì •ì§€ ì‹¤í–‰: í™œì„± í¬ì§€ì…˜ ì—†ìŒ", 'info'
                )
            
            return web.json_response({
                "status": "success",
                "message": f"ë¹„ìƒ ì •ì§€ ì™„ë£Œ. {closed_count}ê°œ í¬ì§€ì…˜ ì²­ì‚°ë¨ (ì‹¤íŒ¨: {failed_count}ê°œ)",
                "closed_positions": closed_count,
                "failed_positions": failed_count,
                "total_positions": total_positions
            })
            
        except Exception as e:
            logger.error(f"ë¹„ìƒ ì •ì§€ ì˜¤ë¥˜: {e}")
            await self.system.notification_manager.send_alert(f"ë¹„ìƒ ì •ì§€ ì‹¤íŒ¨: {e}", 'critical')
            return web.json_response({"error": str(e)}, status=500)
    
    async def health_handler(self, request):
        """í—¬ìŠ¤ì²´í¬ (ê°„ë‹¨í•œ ì‘ë‹µ)"""
        return web.json_response({"status": "healthy", "timestamp": datetime.now().isoformat()})

# ================== ì‹œìŠ¤í…œ í™•ì¥ ë©”ì„œë“œë“¤ ==================
class CompletePhoenix95System:
    """ì‹œìŠ¤í…œ í™•ì¥ ë©”ì„œë“œë“¤"""
    
    async def _signal_processing_loop(self):
        """ì‹¤ì‹œê°„ ì‹ í˜¸ ì²˜ë¦¬ ë£¨í”„ (ê°œì„ ëœ ë²„ì „)"""
        logger.info("ì‹ í˜¸ ì²˜ë¦¬ ë£¨í”„ ì‹œì‘")
        
        try:
            # ì‹ í˜¸ ìƒì„±ê¸° ì‹œì‘
            signal_gen = self.signal_generator.start_signal_generation()
            
            async for signal in signal_gen:
                try:
                    if self._shutdown_event.is_set():
                        break
                    
                    # ì‹ í˜¸ë¥¼ íì— ì¶”ê°€ (ë…¼ë¸”ë¡œí‚¹)
                    try:
                        self.signal_processing_queue.put_nowait(signal)
                    except asyncio.QueueFull:
                        logger.warning("ì‹ í˜¸ ì²˜ë¦¬ íê°€ ê°€ë“ì°¸ - ì˜¤ë˜ëœ ì‹ í˜¸ ì œê±°")
                        try:
                            self.signal_processing_queue.get_nowait()
                            self.signal_processing_queue.put_nowait(signal)
                        except asyncio.QueueEmpty:
                            pass
                    
                    # AI ë¶„ì„
                    analysis = await self.ai_engine.analyze_signal_enhanced(signal)
                    logger.info(f"ì‹ í˜¸ ë¶„ì„ ì™„ë£Œ: {signal['symbol']} -> {analysis.get('action')}")
                    
                    # ê±°ë˜ ì‹¤í–‰ ê²°ì •
                    if analysis.get('action') == 'EXECUTE':
                        analysis['symbol'] = signal['symbol']
                        execution_result = await self.executor.execute_trade(analysis)
                        
                        if execution_result.get('status') == 'EXECUTED':
                            trade_type = "ëª¨ì˜" if execution_result.get('mock') else "ì‹¤ì œ"
                            await self.notification_manager.send_alert(
                                f"ğŸš€ {trade_type} ê±°ë˜ ì‹¤í–‰: {signal['symbol']} {analysis.get('position_size', 0):.4f} "
                                f"(ì‹ ë¢°ë„: {analysis.get('confidence', 0):.3f})", 'success'
                            )
                            
                            # ë°ì´í„°ë² ì´ìŠ¤ì— ì‹ í˜¸ ê¸°ë¡
                            await self._record_signal_analysis(signal, analysis)
                        elif execution_result.get('status') == 'REJECTED':
                            logger.info(f"ê±°ë˜ ê±°ë¶€: {execution_result.get('reason')} (Level {execution_result.get('level', 'N/A')})")
                        else:
                            logger.warning(f"ê±°ë˜ ì‹¤í–‰ ì‹¤íŒ¨: {execution_result}")
                    
                except Exception as e:
                    logger.error(f"ì‹ í˜¸ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
                    await asyncio.sleep(5)  # ì˜¤ë¥˜ ì‹œ ì§§ì€ ëŒ€ê¸°
                
        except asyncio.CancelledError:
            logger.info("ì‹ í˜¸ ì²˜ë¦¬ ë£¨í”„ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤")
        except Exception as e:
            logger.error(f"ì‹ í˜¸ ì²˜ë¦¬ ë£¨í”„ ì˜¤ë¥˜: {e}")
    
    async def _record_signal_analysis(self, signal: Dict[str, Any], analysis: Dict[str, Any]):
        """ì‹ í˜¸ ë¶„ì„ ê²°ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë¡ (ê°œì„ ëœ ë²„ì „)"""
        try:
            await self.db_manager.execute_safe(
                """INSERT INTO signals 
                   (symbol, action, price, confidence, phoenix95_score, technical_score, 
                    risk_score, sentiment_score, market_regime, rsi, macd, volume, 
                    volatility, status) 
                   VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)""",
                signal['symbol'],
                signal['action'],
                signal['price'],
                signal['confidence'],
                analysis.get('phoenix95_score', 0),
                analysis.get('technical_score', 0),
                analysis.get('risk_score', 0),
                analysis.get('sentiment_score', 0),
                analysis.get('market_regime', 'UNKNOWN'),
                signal.get('rsi', 50),
                signal.get('macd', 0),
                signal.get('volume', 0),
                signal.get('volatility', 0),
                'processed' if analysis.get('action') == 'EXECUTE' else 'expired'
            )
        except Exception as e:
            logger.error(f"ì‹ í˜¸ ê¸°ë¡ ì˜¤ë¥˜: {e}")

# ================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==================
def print_startup_banner():
    """ì‹œì‘ ë°°ë„ˆ ì¶œë ¥"""
    banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                  â•‘
â•‘   ğŸ›ï¸  PHOENIX 95 - COMPLETE HEDGE FUND TRADING SYSTEM (FIXED)  ğŸ›ï¸             â•‘
â•‘                                                                                  â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                       â•‘
â•‘   â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•                       â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—                      â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                      â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                      â•‘
â•‘      â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•                       â•‘
â•‘                                                                                  â•‘
â•‘                        INSTITUTIONAL GRADE - ERROR FIXED                       â•‘
â•‘                        â€¢ Improved Error Handling                               â•‘
â•‘                        â€¢ Enhanced WebSocket Stability                          â•‘
â•‘                        â€¢ Better Resource Management                            â•‘
â•‘                        â€¢ Fixed Signal Processing                               â•‘
â•‘                        â€¢ Improved Database Connections                         â•‘
â•‘                        â€¢ Enhanced Type Safety                                  â•‘
â•‘                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)

def print_system_info():
    """ì‹œìŠ¤í…œ ì •ë³´ ì¶œë ¥"""
    testnet_status = "í…ŒìŠ¤íŠ¸ë„·" if CONFIG.get('testnet', True) else "ì‹¤ê±°ë˜"
    
    info = f"""
ğŸ”§ ì‹œìŠ¤í…œ ì„¤ì •:
   â€¢ í™˜ê²½: {testnet_status} ëª¨ë“œ
   â€¢ ì‹ ë¢°ë„ ì„ê³„ê°’: {CONFIG.get('confidence_threshold', 0.75)}
   â€¢ ìµœëŒ€ ë ˆë²„ë¦¬ì§€: {CONFIG.get('max_leverage', 20)}x
   â€¢ ìµœëŒ€ í¬ì§€ì…˜: {CONFIG.get('max_positions', 10)}ê°œ
   â€¢ ê±°ë˜ ë¦¬ìŠ¤í¬: {CONFIG.get('risk_per_trade', 0.02)*100}%
   â€¢ ëª¨ë‹ˆí„°ë§ ê°„ê²©: {CONFIG.get('monitoring_interval', 3)}ì´ˆ

ğŸ“Š ê±°ë˜ ì‹¬ë³¼:
   â€¢ {', '.join(CONFIG.get('symbols', []))}

ğŸŒ ì›¹ ì¸í„°í˜ì´ìŠ¤:
   â€¢ ëŒ€ì‹œë³´ë“œ: http://localhost:{CONFIG.get('websocket_port', 8100)}
   â€¢ WebSocket: ws://localhost:{CONFIG.get('websocket_port', 8100)}/ws
   â€¢ API í—¬ìŠ¤ì²´í¬: http://localhost:{CONFIG.get('websocket_port', 8100)}/health

âš ï¸  ì¤‘ìš” ì•Œë¦¼:
   â€¢ í˜„ì¬ {testnet_status} ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
   â€¢ ëª¨ë“  ê±°ë˜ëŠ” ë¡œê·¸ì— ê¸°ë¡ë˜ë©° ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤
   â€¢ ë¹„ìƒì‹œ Ctrl+C ë˜ëŠ” /api/emergency-stopì„ ì‚¬ìš©í•˜ì„¸ìš”
   â€¢ ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „ - ì•ˆì •ì„±ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤
    """
    print(info)

# ================== CLI ê°œì„  ==================
async def test_system_components():
    """ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë²„ì „)"""
    logger.info("ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘")
    
    try:
        print("ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸...")
        db_manager = DatabaseManager()
        await db_manager.initialize()
        await db_manager.close()
        print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ")
        
        print("ğŸ”§ Redis ì—°ê²° í…ŒìŠ¤íŠ¸...")
        redis_manager = RedisManager()
        await redis_manager.initialize()
        await redis_manager.set_safe("test_key", "test_value", 10)
        result = await redis_manager.get_safe("test_key")
        await redis_manager.close()
        if result == "test_value" or not redis_manager.redis:  # Fallback ëª¨ë“œë„ í—ˆìš©
            print("âœ… Redis ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ (ë˜ëŠ” Fallback ëª¨ë“œ)")
        else:
            raise Exception("Redis í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
        
        print("ğŸ”§ ê±°ë˜ì†Œ ì—°ê²° í…ŒìŠ¤íŠ¸...")
        exchange_manager = ExchangeManager()
        await exchange_manager.initialize()
        price = await exchange_manager.fetch_current_price("BTC/USDT")
        await exchange_manager.close()
        if price > 0:
            print(f"âœ… ê±°ë˜ì†Œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ (BTC ê°€ê²©: ${price:,.2f})")
        else:
            raise Exception("ê±°ë˜ì†Œ ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨")
        
        print("ğŸ”§ ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸...")
        notification_manager = NotificationManager()
        await notification_manager.initialize()
        await notification_manager.send_alert("í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€", 'info')
        await notification_manager.close()
        print("âœ… ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì„±ê³µ")
        
        print("\nğŸ‰ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
        return True
        
    except Exception as e:
        print(f"\nâŒ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        logger.error(f"ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        return False

# ================== ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ ==================
async def main_with_improved_error_handling():
    """ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬ë¥¼ ê°€ì§„ ë©”ì¸ í•¨ìˆ˜"""
    system = None
    try:
        # ì‹œì‘ ë°°ë„ˆ ì¶œë ¥
        print_startup_banner()
        print_system_info()
        
        # ì‹œìŠ¤í…œ ìƒì„±
        system = CompletePhoenix95System()
        
        # ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ì„¤ì •
        setup_signal_handlers(system)
        
        print("ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...")
        await system.initialize_complete_system()
        
        print("ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘ ì¤‘...")
        # ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ë“¤ ì‹œì‘
        system.background_tasks = [
            asyncio.create_task(system.monitor.start_monitoring()),
            asyncio.create_task(system._signal_processing_loop()),
            asyncio.create_task(system.websocket_handler.start_broadcasting()),
        ]
        
        print("ğŸŒ ì›¹ ì„œë²„ ì‹œì‘ ì¤‘...")
        # ì›¹ ì„œë²„ ì‹œì‘
        runner = web.AppRunner(system.dashboard.app)
        await runner.setup()
        site = web.TCPSite(runner, 'localhost', CONFIG['websocket_port'])
        await site.start()
        
        print(f"\nğŸ‰ Complete Phoenix 95 ì‹œìŠ¤í…œ ì™„ì „ ì‹œì‘!")
        print(f"ğŸ“Š ëŒ€ì‹œë³´ë“œ: http://localhost:{CONFIG['websocket_port']}")
        print(f"ğŸ”§ WebSocket: ws://localhost:{CONFIG['websocket_port']}/ws")
        
        testnet_status = "í…ŒìŠ¤íŠ¸ë„·" if CONFIG.get('testnet', True) else "ì‹¤ê±°ë˜"
        print(f"ğŸ›¡ï¸ ëª¨ë“œ: {testnet_status}")
        print("\nâœ¨ ì‹œìŠ¤í…œì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”!")
        
        # ë¬´í•œ ì‹¤í–‰ (ì¢…ë£Œ ì´ë²¤íŠ¸ê¹Œì§€)
        await system._shutdown_event.wait()
        
    except KeyboardInterrupt:
        print("\nâŒ¨ï¸ ì‚¬ìš©ì ì¤‘ë‹¨ (Ctrl+C)")
        logger.info("ì‚¬ìš©ì ì¤‘ë‹¨ (Ctrl+C)")
    except Exception as e:
        print(f"\nğŸ’¥ ì‹œìŠ¤í…œ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
        logger.critical(f"ì‹œìŠ¤í…œ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
    finally:
        if system:
            print("\nğŸ”„ ì‹œìŠ¤í…œ ì•ˆì „ ì¢…ë£Œ ì¤‘...")
            try:
                await system.shutdown_complete_system()
                print("âœ… Phoenix 95 ì‹œìŠ¤í…œì´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            except Exception as e:
                print(f"âš ï¸ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                logger.error(f"ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {e}")

if __name__ == "__main__":
    try:
        asyncio.run(main_with_improved_error_handling())
    except KeyboardInterrupt:
        print("\nğŸ‘‹ Phoenix 95 ì‹œìŠ¤í…œì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"\nğŸ’¥ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        logger.critical(f"ë©”ì¸ ì‹¤í–‰ ì˜¤ë¥˜: {e}")

print("""

ğŸ“š ì¶”ê°€ ì •ë³´:
   â€¢ ìˆ˜ì • ì‚¬í•­: ì˜¤ë¥˜ ì²˜ë¦¬ ê°œì„ , WebSocket ì•ˆì •ì„± í–¥ìƒ, íƒ€ì… ì•ˆì „ì„± ê°•í™”
   â€¢ ë¬¸ì„œ: https://github.com/your-repo/phoenix95
   â€¢ ì§€ì›: support@phoenix95.trading
   â€¢ ë¼ì´ì„ ìŠ¤: MIT

âš ï¸  ë©´ì±…ì‚¬í•­:
   ì´ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” êµìœ¡ ë° ì—°êµ¬ ëª©ì ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
   ì‹¤ì œ ê±°ë˜ì—ì„œ ë°œìƒí•˜ëŠ” ì†ì‹¤

# ================== ì‹œìŠ¤í…œ ì™„ì„± ë¶€ë¶„ (CompletePhoenix95System í™•ì¥) ==================

class CompletePhoenix95System:
    """ì™„ì „í•œ Phoenix 95 ì‹œìŠ¤í…œ - ëˆ„ë½ëœ ë©”ì„œë“œë“¤ ì¶”ê°€"""
    
    async def start_complete_system(self):
        """ì™„ì „í•œ ì‹œìŠ¤í…œ ì‹œì‘ (ë©”ì¸ ì§„ì…ì )"""
        try:
            await self.initialize_complete_system()
            
            # ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ë“¤ ì‹œì‘
            self.background_tasks = [
                # ê¸°ë³¸ ëª¨ë‹ˆí„°ë§
                asyncio.create_task(self.monitor.start_monitoring()),
                
                # ì‹ í˜¸ ì²˜ë¦¬
                asyncio.create_task(self._signal_processing_loop()),
                
                # WebSocket ë¸Œë¡œë“œìºìŠ¤íŒ…
                asyncio.create_task(self.websocket_handler.start_broadcasting()),
                
                # ì„±ëŠ¥ ì¶”ì 
                asyncio.create_task(self._performance_tracking_loop()),
                
                # ìë™ ë°±ì—…
                asyncio.create_task(self._automated_backup_loop()),
                
                # ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬
                asyncio.create_task(self._system_health_check_loop()),
            ]
            
            # ì›¹ ì„œë²„ ì‹œì‘
            runner = web.AppRunner(self.dashboard.app)
            await runner.setup()
            site = web.TCPSite(runner, 'localhost', CONFIG['websocket_port'])
            await site.start()
            
            logger.info("ğŸ‰ Complete Phoenix 95 ì‹œìŠ¤í…œ ì™„ì „ ì‹œì‘!")
            logger.info(f"ğŸ“Š ëŒ€ì‹œë³´ë“œ: http://localhost:{CONFIG['websocket_port']}")
            logger.info(f"ğŸ”§ WebSocket: ws://localhost:{CONFIG['websocket_port']}/ws")
            logger.info(f"ğŸ›¡ï¸ ì‹œìŠ¤í…œ ìƒíƒœ: {self.system_health}")
            
            # ì„±ê³µ ì•Œë¦¼
            await self.notification_manager.send_alert(
                f"Phoenix 95 ì‹œìŠ¤í…œì´ í¬íŠ¸ {CONFIG['websocket_port']}ì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤", 'success'
            )
            
            # ë¬´í•œ ì‹¤í–‰ (ì¢…ë£Œ ì´ë²¤íŠ¸ê¹Œì§€)
            await self._shutdown_event.wait()
            
        except Exception as e:
            logger.error(f"Complete ì‹œìŠ¤í…œ ì‹œì‘ ì˜¤ë¥˜: {e}")
            await self.notification_manager.send_alert(f"ì‹œìŠ¤í…œ ì‹œì‘ ì‹¤íŒ¨: {e}", 'critical')
            raise
    
    async def _performance_tracking_loop(self):
        """ì„±ëŠ¥ ì¶”ì  ë£¨í”„"""
        while not self._shutdown_event.is_set():
            try:
                # AI ì—”ì§„ ì„±ëŠ¥ í†µê³„
                ai_stats = self.ai_engine.get_performance_stats()
                
                # ë°ì´í„°ë² ì´ìŠ¤ì— AI ì„±ëŠ¥ ì €ì¥
                await self.db_manager.execute_safe(
                    """INSERT INTO ai_performance 
                       (total_analyses, total_executions, execution_rate, avg_confidence, 
                        avg_execution_time_ms, phoenix95_avg_score) 
                       VALUES ($1, $2, $3, $4, $5, $6)""",
                    ai_stats.get('total_analyses', 0),
                    ai_stats.get('total_executions', 0),
                    ai_stats.get('execution_rate', 0) / 100,  # ë°±ë¶„ìœ¨ì„ ì†Œìˆ˜ë¡œ ë³€í™˜
                    ai_stats.get('avg_confidence', 0),
                    ai_stats.get('avg_execution_time_ms', 0),
                    ai_stats.get('avg_confidence', 0)  # phoenix95_avg_score ê·¼ì‚¬ì¹˜
                )
                
                # Redisì— ì„±ëŠ¥ ë°ì´í„° ì €ì¥
                await self.redis_manager.set_safe(
                    "performance_stats",
                    json.dumps(ai_stats),
                    3600  # 1ì‹œê°„
                )
                
                # ì„±ëŠ¥ ì•Œë¦¼
                execution_rate = ai_stats.get('execution_rate', 0)
                if execution_rate < 5:  # 5% ë¯¸ë§Œ
                    await self.notification_manager.send_alert(
                        f"âš ï¸ ë§¤ìš° ë‚®ì€ ê±°ë˜ ì‹¤í–‰ë¥ : {execution_rate:.1f}% (ì‹ í˜¸ í’ˆì§ˆ í™•ì¸ í•„ìš”)", 'warning'
                    )
                elif execution_rate > 90:  # 90% ì´ˆê³¼
                    await self.notification_manager.send_alert(
                        f"âš ï¸ ë§¤ìš° ë†’ì€ ê±°ë˜ ì‹¤í–‰ë¥ : {execution_rate:.1f}% (ê³¼ë„í•œ ê±°ë˜ ì£¼ì˜)", 'warning'
                    )
                
                await asyncio.sleep(300)  # 5ë¶„ë§ˆë‹¤
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"ì„±ëŠ¥ ì¶”ì  ì˜¤ë¥˜: {e}")
                await asyncio.sleep(600)  # ì˜¤ë¥˜ ì‹œ 10ë¶„ ëŒ€ê¸°
    
    async def _automated_backup_loop(self):
        """ìë™ ë°±ì—… ë£¨í”„"""
        while not self._shutdown_event.is_set():
            try:
                await asyncio.sleep(CONFIG['backup_interval'])
                
                # ë°±ì—… ìƒì„±
                backup_data = {
                    'timestamp': datetime.now().isoformat(),
                    'active_trades_count': len(await self.monitor.get_active_positions()),
                    'ai_performance': self.ai_engine.get_performance_stats(),
                    'system_health': self.system_health,
                    'config': CONFIG
                }
                
                # Redisì— ë°±ì—… ë°ì´í„° ì €ì¥
                backup_key = f"auto_backup_{int(time.time())}"
                await self.redis_manager.set_safe(
                    backup_key,
                    json.dumps(backup_data, default=str),
                    86400 * 7  # 7ì¼ ë³´ê´€
                )
                
                # ì‹œìŠ¤í…œ ë¡œê·¸ì— ê¸°ë¡
                await self.db_manager.execute_safe(
                    """INSERT INTO system_logs (level, component, message, metadata) 
                       VALUES ($1, $2, $3, $4)""",
                    'INFO',
                    'BackupSystem',
                    'ìë™ ë°±ì—… ì™„ë£Œ',
                    json.dumps({'backup_key': backup_key, 'data_size': len(json.dumps(backup_data, default=str))})
                )
                
                logger.info(f"ìë™ ë°±ì—… ì™„ë£Œ: {backup_key}")
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"ìë™ ë°±ì—… ì˜¤ë¥˜: {e}")
                await asyncio.sleep(3600)  # ì˜¤ë¥˜ ì‹œ 1ì‹œê°„ ëŒ€ê¸°
    
    async def _system_health_check_loop(self):
        """ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ë£¨í”„"""
        while not self._shutdown_event.is_set():
            try:
                # ê° ì»´í¬ë„ŒíŠ¸ ìƒíƒœ ì²´í¬
                health_status = {
                    'database': self.db_manager.pool is not None,
                    'redis': self.redis_manager.redis is not None,
                    'exchange': self.exchange_manager.connection_status,
                    'price_stream': self.price_stream.running if self.price_stream else False,
                    'ai_engine': hasattr(self, 'ai_engine') and self.ai_engine is not None
                }
                
                # ì´ì „ ìƒíƒœì™€ ë¹„êµí•˜ì—¬ ë³€í™” ê°ì§€
                status_changed = []
                for component, status in health_status.items():
                    if self.system_health.get(component) != status:
                        status_changed.append(f"{component}: {'OK' if status else 'FAIL'}")
                        self.system_health[component] = status
                
                # ìƒíƒœ ë³€í™” ì•Œë¦¼
                if status_changed:
                    await self.notification_manager.send_alert(
                        f"ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ ë³€í™”: {', '.join(status_changed)}", 'info'
                    )
                
                # ì „ì²´ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬
                healthy_components = sum(health_status.values())
                total_components = len(health_status)
                health_percentage = (healthy_components / total_components) * 100
                
                if health_percentage < 80:
                    await self.notification_manager.send_alert(
                        f"ğŸš¨ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì €í•˜: {health_percentage:.0f}% ({healthy_components}/{total_components})", 'critical'
                    )
                elif health_percentage < 100:
                    await self.notification_manager.send_alert(
                        f"âš ï¸ ì‹œìŠ¤í…œ ì¼ë¶€ ì¥ì• : {health_percentage:.0f}% ({healthy_components}/{total_components})", 'warning'
                    )
                
                await asyncio.sleep(60)  # 1ë¶„ë§ˆë‹¤ ì²´í¬
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ì˜¤ë¥˜: {e}")
                await asyncio.sleep(300)  # ì˜¤ë¥˜ ì‹œ 5ë¶„ ëŒ€ê¸°

# ================== CLI íŒŒì„œ ë° ì„¤ì • ê´€ë¦¬ ==================
def create_cli_parser():
    """CLI íŒŒì„œ ìƒì„±"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='Phoenix 95 - Complete Hedge Fund Trading System (Fixed Version)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ì˜ˆì œ:
  python phoenix95_complete_fixed.py                    # ì¼ë°˜ ëª¨ë“œë¡œ ì‹œì‘
  python phoenix95_complete_fixed.py --test            # ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
  python phoenix95_complete_fixed.py --simulation      # ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
  python phoenix95_complete_fixed.py --port 8200       # í¬íŠ¸ 8200ì—ì„œ ì‹œì‘
  python phoenix95_complete_fixed.py --production      # í”„ë¡œë•ì…˜ ëª¨ë“œ (ì‹¤ê±°ë˜)
        """
    )
    
    parser.add_argument(
        '--test', 
        action='store_true', 
        help='ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰'
    )
    
    parser.add_argument(
        '--simulation', 
        action='store_true', 
        help='ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ (ìœ„í—˜ë„ ë‚®ì¶¤)'
    )
    
    parser.add_argument(
        '--production',
        action='store_true',
        help='í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ (ì‹¤ê±°ë˜ - ì£¼ì˜!)'
    )
    
    parser.add_argument(
        '--port', 
        type=int, 
        default=8100,
        help='ì›¹ ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ê°’: 8100)'
    )
    
    parser.add_argument(
        '--log-level', 
        choices=['DEBUG', 'INFO', 'WARNING', 'ERROR'], 
        default='INFO',
        help='ë¡œê·¸ ë ˆë²¨ ì„¤ì •'
    )
    
    parser.add_argument(
        '--config', 
        type=str,
        help='ì„¤ì • íŒŒì¼ ê²½ë¡œ (JSON í˜•ì‹)'
    )
    
    parser.add_argument(
        '--symbols',
        nargs='+',
        help='ê±°ë˜í•  ì‹¬ë³¼ ëª©ë¡ (ì˜ˆ: BTC/USDT ETH/USDT)'
    )
    
    parser.add_argument(
        '--max-positions',
        type=int,
        help='ìµœëŒ€ í¬ì§€ì…˜ ìˆ˜'
    )
    
    parser.add_argument(
        '--risk-per-trade',
        type=float,
        help='ê±°ë˜ë‹¹ ë¦¬ìŠ¤í¬ ë¹„ìœ¨ (0.01 = 1%)'
    )
    
    return parser

async def load_custom_config(config_path: str):
    """ì‚¬ìš©ì ì •ì˜ ì„¤ì • ë¡œë“œ"""
    try:
        async with aiofiles.open(config_path, 'r', encoding='utf-8') as f:
            content = await f.read()
            custom_config = json.loads(content)
            
        # CONFIG ì—…ë°ì´íŠ¸
        CONFIG.update(custom_config)
        logger.info(f"ì‚¬ìš©ì ì •ì˜ ì„¤ì • ë¡œë“œë¨: {config_path}")
        
    except Exception as e:
        logger.error(f"ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
        raise

def apply_cli_args(args):
    """CLI ì¸ìë¥¼ CONFIGì— ì ìš©"""
    try:
        # í¬íŠ¸ ì„¤ì •
        CONFIG['websocket_port'] = args.port
        
        # í”„ë¡œë•ì…˜/ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
        if args.production:
            CONFIG['testnet'] = False
            CONFIG['confidence_threshold'] = 0.8
            CONFIG['risk_per_trade'] = 0.01  # í”„ë¡œë•ì…˜ì—ì„œëŠ” ë” ë³´ìˆ˜ì 
            logger.warning("âš ï¸ í”„ë¡œë•ì…˜ ëª¨ë“œ í™œì„±í™” - ì‹¤ì œ ê±°ë˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤!")
        elif args.simulation:
            CONFIG['testnet'] = True
            CONFIG['max_positions'] = 3
            CONFIG['risk_per_trade'] = 0.005  # 0.5%ë¡œ ë‚®ì¶¤
            logger.info("ğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™”")
        
        # ì‹¬ë³¼ ì„¤ì •
        if args.symbols:
            CONFIG['symbols'] = args.symbols
            logger.info(f"ê±°ë˜ ì‹¬ë³¼ ì„¤ì •: {args.symbols}")
        
        # ìµœëŒ€ í¬ì§€ì…˜ ìˆ˜
        if args.max_positions:
            CONFIG['max_positions'] = args.max_positions
            logger.info(f"ìµœëŒ€ í¬ì§€ì…˜ ìˆ˜ ì„¤ì •: {args.max_positions}")
        
        # ê±°ë˜ë‹¹ ë¦¬ìŠ¤í¬
        if args.risk_per_trade:
            CONFIG['risk_per_trade'] = args.risk_per_trade
            logger.info(f"ê±°ë˜ë‹¹ ë¦¬ìŠ¤í¬ ì„¤ì •: {args.risk_per_trade*100}%")
        
    except Exception as e:
        logger.error(f"CLI ì¸ì ì ìš© ì˜¤ë¥˜: {e}")
        raise

# ================== ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ==================
async def run_simulation_mode():
    """ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹¤í–‰ (ê°œì„ ëœ ë²„ì „)"""
    logger.info("ğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì‹œìŠ¤í…œ ì‹œì‘")
    
    # ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •ìœ¼ë¡œ CONFIG ìˆ˜ì •
    CONFIG.update({
        'testnet': True,
        'simulation_mode': True,
        'max_positions': 3,
        'risk_per_trade': 0.005,  # 0.5%ë¡œ ë” ë‚®ì¶¤
        'confidence_threshold': 0.7,  # ë” ë‚®ì€ ì„ê³„ê°’
        'max_leverage': 10,  # ë‚®ì€ ë ˆë²„ë¦¬ì§€
        'monitoring_interval': 5,  # ë” ê¸´ ëª¨ë‹ˆí„°ë§ ê°„ê²©
    })
    
    print("ğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì„¤ì •:")
    print(f"   â€¢ í…ŒìŠ¤íŠ¸ë„·: {CONFIG['testnet']}")
    print(f"   â€¢ ìµœëŒ€ í¬ì§€ì…˜: {CONFIG['max_positions']}")
    print(f"   â€¢ ê±°ë˜ë‹¹ ë¦¬ìŠ¤í¬: {CONFIG['risk_per_trade']*100}%")
    print(f"   â€¢ ì‹ ë¢°ë„ ì„ê³„ê°’: {CONFIG['confidence_threshold']}")
    print(f"   â€¢ ìµœëŒ€ ë ˆë²„ë¦¬ì§€: {CONFIG['max_leverage']}x")
    
    system = CompletePhoenix95System()
    
    try:
        await system.start_complete_system()
    except KeyboardInterrupt:
        logger.info("ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì¤‘ë‹¨")
        print("\nğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    finally:
        await system.shutdown_complete_system()

# ================== í”„ë¡œë•ì…˜ ëª¨ë“œ í™•ì¸ ==================
def confirm_production_mode():
    """í”„ë¡œë•ì…˜ ëª¨ë“œ ì‹¤í–‰ í™•ì¸"""
    print("=" * 70)
    print("âš ï¸  PRODUCTION MODE WARNING âš ï¸")
    print("=" * 70)
    print("ì‹¤ì œ ê±°ë˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤!")
    print("ì‹¤ì œ ìê¸ˆìœ¼ë¡œ ê±°ë˜ê°€ ì§„í–‰ë˜ë©°, ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    print("í”„ë¡œë•ì…˜ ëª¨ë“œë¥¼ ê³„ì†í•˜ë ¤ë©´ 'YES'ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.")
    print("=" * 70)
    
    confirmation = input("í”„ë¡œë•ì…˜ ëª¨ë“œ ì‹¤í–‰ì„ í™•ì¸í•©ë‹ˆë‹¤ (YES/no): ").strip()
    
    if confirmation != "YES":
        print("í”„ë¡œë•ì…˜ ëª¨ë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        print("ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤...")
        return False
    
    print("ğŸš¨ í”„ë¡œë•ì…˜ ëª¨ë“œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return True

# ================== ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ (CLI í†µí•©) ==================
async def main_with_cli():
    """CLIì™€ í†µí•©ëœ ë©”ì¸ í•¨ìˆ˜"""
    # CLI íŒŒì„œ ìƒì„±
    parser = create_cli_parser()
    args = parser.parse_args()
    
    # ë¡œê·¸ ë ˆë²¨ ì„¤ì •
    logging.getLogger().setLevel(getattr(logging, args.log_level))
    
    try:
        # ì‚¬ìš©ì ì •ì˜ ì„¤ì • ë¡œë“œ
        if args.config:
            await load_custom_config(args.config)
        
        # CLI ì¸ì ì ìš©
        apply_cli_args(args)
        
        # í”„ë¡œë•ì…˜ ëª¨ë“œ í™•ì¸
        if args.production and not confirm_production_mode():
            # í”„ë¡œë•ì…˜ ê±°ë¶€ ì‹œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì „í™˜
            args.simulation = True
            args.production = False
            CONFIG['testnet'] = True
        
        # í…ŒìŠ¤íŠ¸ ëª¨ë“œ
        if args.test:
            print("ğŸ”§ ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘...")
            success = await test_system_components()
            if success:
                print("\nâœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
                print("ì´ì œ ì¼ë°˜ ëª¨ë“œë¡œ ì‹œìŠ¤í…œì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            else:
                print("\nâŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
            return
        
        # ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
        if args.simulation:
            await run_simulation_mode()
            return
        
        # ì¼ë°˜ ëª¨ë“œ
        await main_with_improved_error_handling()
        
    except Exception as e:
        logger.critical(f"í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì˜¤ë¥˜: {e}")
        print(f"\nğŸ’¥ ì‹¤í–‰ ì˜¤ë¥˜: {e}")

# ================== Docker ì„¤ì • íŒŒì¼ë“¤ ==================
def generate_docker_files():
    """Docker ì„¤ì • íŒŒì¼ë“¤ ìƒì„±"""
    
    # requirements.txt
    requirements_txt = """
aiohttp==3.8.6
aiofiles==23.2.1
asyncpg==0.29.0
redis==5.0.1
psutil==5.9.6
python-multipart==0.0.6
websockets==11.0.3
numpy==1.24.3
ccxt==4.1.0
"""
    
    # docker-compose.yml
    docker_compose_yml = """
version: '3.8'

services:
  phoenix95:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "8100:8100"
    environment:
      - DATABASE_URL=postgresql://trader:secure123@db:5432/phoenix95
      - REDIS_URL=redis://redis:6379/0
      - ENVIRONMENT=production
      - BINANCE_API_KEY=${BINANCE_API_KEY:-test_key}
      - BINANCE_SECRET=${BINANCE_SECRET:-test_secret}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    networks:
      - phoenix95_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8100/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: phoenix95
      POSTGRES_USER: trader
      POSTGRES_PASSWORD: secure123
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    command: >
      postgres 
      -c max_connections=100 
      -c shared_buffers=256MB
      -c effective_cache_size=512MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
    networks:
      - phoenix95_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trader -d phoenix95"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
  redis:
    image: redis:7-alpine
    command: >
      redis-server 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
    volumes:
      - redis_data:/data
    networks:
      - phoenix95_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ì„ íƒì : Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - phoenix95
    networks:
      - phoenix95_network
    profiles:
      - production

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  phoenix95_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
"""

    # Dockerfile
    dockerfile = """
FROM python:3.11-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \\
    gcc \\
    postgresql-client \\
    curl \\
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip \\
    && pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ë¡œê·¸ ë° ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/logs /app/config

# ë¹„root ì‚¬ìš©ì ìƒì„±
RUN useradd --create-home --shell /bin/bash phoenix95 \\
    && chown -R phoenix95:phoenix95 /app
USER phoenix95

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8100

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\
    CMD python -c "import requests; requests.get('http://localhost:8100/health')"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["python", "phoenix95_complete_fixed.py", "--production"]
"""

    # nginx.conf
    nginx_conf = """
events {
    worker_connections 1024;
}

http {
    upstream phoenix95 {
        server phoenix95:8100;
    }
    
    server {
        listen 80;
        server_name localhost;
        
        location / {
            proxy_pass http://phoenix95;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /ws {
            proxy_pass http://phoenix95;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
"""

    # .env.example
    env_example = """
# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DATABASE_URL=postgresql://trader:secure123@localhost:5432/phoenix95

# Redis ì„¤ì •
REDIS_URL=redis://localhost:6379/0

# ë°”ì´ë‚¸ìŠ¤ API (ì‹¤ê±°ë˜ìš©)
BINANCE_API_KEY=your_binance_api_key_here
BINANCE_SECRET=your_binance_secret_here

# ì•Œë¦¼ ì„¤ì • (ì„ íƒì‚¬í•­)
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
TELEGRAM_CHAT_ID=your_telegram_chat_id

# ì‹œìŠ¤í…œ ì„¤ì •
ENVIRONMENT=development
LOG_LEVEL=INFO
"""

    # init-db.sql
    init_db_sql = """
-- PostgreSQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
-- Phoenix 95 Trading System

-- ê¶Œí•œ ì„¤ì •
GRANT ALL PRIVILEGES ON DATABASE phoenix95 TO trader;

-- í™•ì¥ ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- ì„±ëŠ¥ ì„¤ì •
ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements';
ALTER SYSTEM SET track_activity_query_size = 2048;
ALTER SYSTEM SET pg_stat_statements.track = 'all';
"""

    return {
        'requirements.txt': requirements_txt.strip(),
        'docker-compose.yml': docker_compose_yml.strip(),
        'Dockerfile': dockerfile.strip(),
        'nginx.conf': nginx_conf.strip(),
        '.env.example': env_example.strip(),
        'init-db.sql': init_db_sql.strip()
    }

# ================== ì„¤ì • íŒŒì¼ ìƒì„±ê¸° ==================
def generate_config_files():
    """ì„¤ì • íŒŒì¼ë“¤ ìƒì„±"""
    
    # config/development.json
    development_config = {
        "log_level": "DEBUG",
        "confidence_threshold": 0.7,
        "max_leverage": 10,
        "monitoring_interval": 5,
        "memory_threshold": 80,
        "backup_interval": 1800,
        "websocket_port": 8100,
        "max_positions": 5,
        "risk_per_trade": 0.01,
        "min_confidence": 0.6,
        "symbols": ["BTC/USDT", "ETH/USDT"],
        "testnet": True,
        "simulation_mode": True
    }
    
    # config/production.json
    production_config = {
        "log_level": "INFO",
        "confidence_threshold": 0.8,
        "max_leverage": 20,
        "monitoring_interval": 1,
        "memory_threshold": 90,
        "backup_interval": 3600,
        "websocket_port": 8100,
        "max_positions": 10,
        "risk_per_trade": 0.02,
        "min_confidence": 0.75,
        "symbols": ["BTC/USDT", "ETH/USDT", "ADA/USDT", "DOT/USDT"],
        "testnet": False,
        "simulation_mode": False
    }
    
    # config/trading_rules.json
    trading_rules = {
        "risk_management": {
            "max_daily_loss": 1000.0,
            "max_drawdown": 0.15,
            "position_sizing": "kelly_criterion",
            "stop_loss_pct": 0.02,
            "take_profit_pct": 0.04
        },
        "execution_rules": {
            "min_volume": 1000000,
            "max_spread": 0.001,
            "slippage_tolerance": 0.0005,
            "order_timeout": 30
        },
        "phoenix95_settings": {
            "boost_factor": 1.3,
            "rsi_optimal_range": [30, 70],
            "macd_threshold": 0.001,
            "volume_multiplier": 1.5
        }
    }
    
    return {
        'config/development.json': json.dumps(development_config, indent=2),
        'config/production.json': json.dumps(production_config, indent=2),
        'config/trading_rules.json': json.dumps(trading_rules, indent=2)
    }

# ================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==================
def setup_project_structure():
    """í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì •"""
    directories = [
        'logs',
        'config',
        'data',
        'backups',
        'ssl'
    ]
    
    for directory in directories:
        os.makedirs(directory, exist_ok=True)
        print(f"ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±: {directory}")
    
    # Docker íŒŒì¼ë“¤ ìƒì„±
    docker_files = generate_docker_files()
    for filename, content in docker_files.items():
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"ğŸ“„ íŒŒì¼ ìƒì„±: {filename}")
    
    # ì„¤ì • íŒŒì¼ë“¤ ìƒì„±
    config_files = generate_config_files()
    for filepath, content in config_files.items():
        os.makedirs(os.path.dirname(filepath), exist_ok=True)
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"ğŸ“„ íŒŒì¼ ìƒì„±: {filepath}")
    
    print("\nâœ… í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì • ì™„ë£Œ!")

def print_deployment_instructions():
    """ë°°í¬ ì§€ì¹¨ ì¶œë ¥"""
    instructions = """
ğŸš€ Phoenix 95 ë°°í¬ ì§€ì¹¨:

1. ê°œë°œ í™˜ê²½ ì„¤ì •:
   python phoenix95_complete_fixed.py --test
   python phoenix95_complete_fixed.py --simulation

2. Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰:
   docker-compose up -d

3. í”„ë¡œë•ì…˜ ë°°í¬:
   cp .env.example .env
   # .env íŒŒì¼ì—ì„œ ì‹¤ì œ API í‚¤ ì„¤ì •
   docker-compose --profile production up -d

4. ë¡œê·¸ ëª¨ë‹ˆí„°ë§:
   docker-compose logs -f phoenix95

5. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸:
   curl http://localhost:8100/health

6. ëŒ€ì‹œë³´ë“œ ì ‘ì†:
   http://localhost:8100

âš ï¸ ì£¼ì˜ì‚¬í•­:
   â€¢ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ë°˜ë“œì‹œ ì‹¤ì œ API í‚¤ ì„¤ì •
   â€¢ SSL ì¸ì¦ì„œ ì„¤ì • ê¶Œì¥
   â€¢ ì •ê¸°ì ì¸ ë°±ì—… ì‹¤í–‰
   â€¢ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ í•„ìˆ˜
"""
    print(instructions)

# ================== ë©´ì±…ì‚¬í•­ ì™„ì„± ==================
def print_disclaimer():
    """ì™„ì „í•œ ë©´ì±…ì‚¬í•­"""
    disclaimer = """
ğŸ“š ì¶”ê°€ ì •ë³´:
   â€¢ ìˆ˜ì • ì‚¬í•­: ì˜¤ë¥˜ ì²˜ë¦¬ ê°œì„ , WebSocket ì•ˆì •ì„± í–¥ìƒ, íƒ€ì… ì•ˆì „ì„± ê°•í™”
   â€¢ CLI ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€, Docker ì§€ì›, ì„¤ì • ê´€ë¦¬ ê°œì„ 
   â€¢ ë¬¸ì„œ: https://github.com/your-repo/phoenix95
   â€¢ ì§€ì›: support@phoenix95.trading
   â€¢ ë¼ì´ì„ ìŠ¤: MIT

âš ï¸  ë©´ì±…ì‚¬í•­:
   ì´ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” êµìœ¡ ë° ì—°êµ¬ ëª©ì ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
   ì‹¤ì œ ê±°ë˜ì—ì„œ ë°œìƒí•˜ëŠ” ì†ì‹¤ì— ëŒ€í•´ì„œëŠ” ì‚¬ìš©ìê°€ ì „ì ìœ¼ë¡œ ì±…ì„ì§‘ë‹ˆë‹¤.
   
   â€¢ ìë™ ê±°ë˜ ì‹œìŠ¤í…œì˜ ìœ„í—˜ì„±ì„ ì¶©ë¶„íˆ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ì„¸ìš”
   â€¢ íˆ¬ì ì†ì‹¤ ìœ„í—˜ì´ ìˆìœ¼ë©°, ì›ê¸ˆ ì†ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤
   â€¢ ì‹œì¥ ë³€ë™ì„±ìœ¼ë¡œ ì¸í•œ ì˜ˆìƒì¹˜ ëª»í•œ ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
   â€¢ ê¸°ìˆ ì  ì˜¤ë¥˜ë‚˜ ì‹œìŠ¤í…œ ì¥ì• ë¡œ ì¸í•œ ì†ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤
   â€¢ ë²•ì  ê·œì œë‚˜ ê±°ë˜ì†Œ ì •ì±… ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
   
   ë³¸ ì‹œìŠ¤í…œ ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ëª¨ë“  ê²°ê³¼ì— ëŒ€í•œ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.

ğŸ›ï¸ Phoenix 95 - Where AI Meets Institutional Trading

ğŸ’¡ Quick Start:
   python phoenix95_complete_fixed.py --test      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
   python phoenix95_complete_fixed.py --help      # ë„ì›€ë§ ë³´ê¸°
   python phoenix95_complete_fixed.py --setup     # í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì •
"""
    print(disclaimer)

# ================== ë©”ì¸ ì§„ì…ì  (ìµœì¢…) ==================
if __name__ == "__main__":
    # íŠ¹ë³„ ëª…ë ¹ì–´ ì²˜ë¦¬
    if len(sys.argv) > 1:
        if '--setup' in sys.argv:
            print("ğŸ”§ Phoenix 95 í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì • ì¤‘...")
            setup_project_structure()
            print_deployment_instructions()
            sys.exit(0)
        elif '--docker-files' in sys.argv:
            print("ğŸ³ Docker ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘...")
            docker_files = generate_docker_files()
            for filename, content in docker_files.items():
                with open(filename, 'w', encoding='utf-8') as f:
                    f.write(content)
                print(f"ğŸ“„ ìƒì„±ë¨: {filename}")
            sys.exit(0)
    
    # ì¼ë°˜ ì‹¤í–‰
    try:
        # ì‹œì‘ ë°°ë„ˆ ì¶œë ¥
        print_startup_banner()
        
        # CLIì™€ í•¨ê»˜ ì‹¤í–‰
        asyncio.run(main_with_cli())
        
    except KeyboardInterrupt:
        print("\nğŸ‘‹ Phoenix 95 ì‹œìŠ¤í…œì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"\nğŸ’¥ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        logger.critical(f"ë©”ì¸ ì‹¤í–‰ ì˜¤ë¥˜: {e}")
    finally:
        # ë©´ì±…ì‚¬í•­ ì¶œë ¥
        print_disclaimer()
